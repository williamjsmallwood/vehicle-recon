<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Recon Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            color: #1a202c;
            font-size: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 4px 10px;
            background: #4299e1;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: #edf2f7;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #4299e1;
            color: white;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Dashboard View */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border: 2px solid #4299e1;
        }

        .stat-card.active {
            background: #4299e1;
            color: white;
        }

        .stat-card.active .stat-value {
            color: white;
        }

        .stat-card.active .stat-label {
            color: rgba(255,255,255,0.9);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4299e1;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
            font-size: 12px;
        }

        .queue-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            max-width: 100%;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Single-step filtered view: one full-width column, cards inside form a grid */
        .queue-board.single-step {
            grid-template-columns: 1fr;
        }

        .queue-board.single-step .queue-column {
            width: 100%;
        }

        .queue-board.single-step .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }

        @media (max-width: 600px) {
            .queue-board.single-step .vehicle-grid {
                grid-template-columns: 1fr;
            }
        }

        .queue-column {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .queue-column.has-overdue {
            animation: flashOverdue 2s ease-in-out infinite;
            border: 3px solid #fc8181;
        }

        @keyframes flashOverdue {
            0%, 100% {
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            50% {
                background: #fff5f5;
                box-shadow: 0 0 20px rgba(252, 129, 129, 0.5);
            }
        }

        .overdue-alert {
            background: #fc8181;
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .reassign-suggestion {
            background: #fef5e7;
            border: 2px solid #f39c12;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            font-size: 11px;
        }

        .step-suggestion {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            font-size: 11px;
        }

        .reassign-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 6px;
            width: 100%;
        }

        .reassign-btn:hover {
            background: #e67e22;
        }

        .step-btn {
            background: #805ad5;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 6px;
            width: 100%;
        }

        .step-btn:hover {
            background: #6b46c1;
        }

        .admin-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #718096;
            transition: all 0.2s;
        }

        .admin-tab:hover {
            color: #4299e1;
            background: #f7fafc;
        }

        .admin-tab.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #bee3f8;
            color: #2c5282;
            border-radius: 12px;
            font-size: 12px;
            margin: 3px;
        }

        .tag-remove-btn {
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-name-editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .step-name-editable:hover {
            background: #e2e8f0;
        }

        .substep-container {
            margin-top: 10px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }

        .substep-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .substep-item:last-child {
            margin-bottom: 0;
        }

        .substep-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #4299e1;
            color: white;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        .expand-btn {
            background: transparent;
            border: none;
            color: #4299e1;
            cursor: pointer;
            font-size: 18px;
            padding: 0 8px;
            transition: transform 0.2s;
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .workflow-bar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .workflow-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .workflow-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workflow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .workflow-btn.active {
            border-color: currentColor;
            background: currentColor;
            color: white;
        }

        .workflow-badge {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .workflow-btn.active .workflow-badge {
            background: rgba(255,255,255,0.3);
        }

        .progress-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #e6ffed;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            color: #22543d;
        }

        .auto-reassign-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }

        .auto-reassign-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.6);
        }

        .lock-icon {
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .dependency-warning {
            background: #fff5f5;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .step-filter-bar {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .step-filter-btn {
            padding: 10px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 100px;
        }

        .step-filter-btn:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .step-filter-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .step-filter-btn.all-steps {
            background: #2d3748;
            color: white;
            border-color: #2d3748;
        }

        .step-counts {
            display: flex;
            gap: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .count-badge {
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
        }

        .count-in-step {
            background: #4299e1;
        }

        .count-movable {
            background: #48bb78;
        }

        .count-overdue {
            background: #fc8181;
        }

        .quick-complete-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 5px;
            width: 100%;
        }

        .quick-complete-btn:hover {
            background: #38a169;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .queue-title {
            font-weight: bold;
            font-size: 14px;
        }

        .queue-count {
            background: #4299e1;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .vehicle-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vehicle-card:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
        }

        .vehicle-card.overdue {
            border-color: #fc8181;
            background: #fff5f5;
        }
        
        .vehicle-card.needs-attention {
            animation: pulseAttention 2s ease-in-out infinite;
        }
        
        @keyframes pulseAttention {
            0%, 100% {
                border-color: #f39c12;
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4);
            }
            50% {
                border-color: #e67e22;
                box-shadow: 0 0 0 6px rgba(243, 156, 18, 0);
            }
        }

        .vehicle-vin {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .vehicle-time {
            font-size: 11px;
            color: #718096;
            line-height: 1.4;
        }

        .vehicle-tags {
            display: flex;
            gap: 4px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 2px 6px;
            background: #bee3f8;
            color: #2c5282;
            border-radius: 3px;
            font-size: 10px;
        }

        .alert-tag {
            background: #fc8181;
            color: white;
        }

        .reassign-suggestion {
            background: #fef5e7;
            border: 2px solid #f39c12;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                border-color: #f39c12;
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4);
            }
            50% {
                border-color: #e67e22;
                box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.2);
            }
        }

        .suggestion-badge {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
            animation: flash 1.5s infinite;
        }


        @keyframes flashOrange {
            0%, 100% { background: #f39c12; box-shadow: 0 4px 12px rgba(243,156,18,0.4); }
            50% { background: #e67e22; box-shadow: 0 4px 20px rgba(243,156,18,0.7); }
        }
        @keyframes flash {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* Technician View */
        .tech-assignment {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .assignment-vin {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin: 15px 0;
            word-break: break-all;
        }

        .assignment-step {
            font-size: 18px;
            color: #4299e1;
            margin-bottom: 15px;
        }

        .complete-btn {
            padding: 12px 30px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
        }

        .complete-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        .no-assignment {
            color: #718096;
            font-size: 16px;
            padding: 30px 20px;
        }

        /* Admin Panel */
        .admin-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .btn {
            padding: 10px 16px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:hover {
            background: #3182ce;
        }

        .threshold-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .threshold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 4px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }

        thead, tbody, tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            word-wrap: break-word;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            font-size: 12px;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .login-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .login-spinner { display: none; flex-direction: column; align-items: center; gap: 14px; padding: 16px 0 4px; }
        .login-spinner.active { display: flex; }
        .spinner-ring { width: 44px; height: 44px; border: 4px solid #e2e8f0; border-top-color: #4299e1; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .spinner-msg { font-size: 14px; color: #718096; font-weight: 500; }

        @media (max-width: 768px) {
            h1 {
                font-size: 18px;
            }

            .queue-board {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .threshold-list {
                grid-template-columns: 1fr;
            }

            .assignment-vin {
                font-size: 20px;
            }

            .assignment-step {
                font-size: 16px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 4px;
            }

            .step-filter-btn {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 11px;
            }

            .step-counts {
                gap: 4px;
            }

            .count-badge {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 5px;
            }

            header {
                padding: 10px;
            }

            h1 {
                font-size: 16px;
            }

            .step-filter-buttons {
                gap: 5px;
            }

            .step-filter-btn {
                min-width: 70px;
                padding: 6px 8px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // Your actual Supabase credentials are here
        const SUPABASE_URL = 'https://fpmpujyjhkxtyvwuqwbt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwbXB1anlqaGt4dHl2d3Vxd2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNjUzMDYsImV4cCI6MjA4NjY0MTMwNn0._BQEQV1L938A2onw5iUn0rhnMgVdblYUsUHqj87cXFY';
        
        // Initialize Supabase client
        let supabaseClient = null;
        const USE_SUPABASE = SUPABASE_URL && SUPABASE_ANON_KEY;
        
        // Wait for page to load before initializing
        document.addEventListener('DOMContentLoaded', async function() {
            if (USE_SUPABASE && typeof window.supabase !== 'undefined') {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: false
                        }
                    });
                    console.log('✅ Supabase initialized');
                } catch (error) {
                    console.error('❌ Failed to initialize Supabase:', error);
                }
            } else {
                console.log('⚠️ Using mock authentication (Supabase not configured)');
            }
            // Run init here so supabaseClient is ready
            await init();
        });

        
        // User session and location
        let userSession = null;
        let userLocation = null;
        let userLocations = []; // Array of locations super admin can access
        let currentLocationId = null; // Currently selected location
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function initializeAuth() {
            if (!USE_SUPABASE || !supabaseClient) {
                // Fallback to mock login if supabaseClient not configured
                return;
            }
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                await loadUserProfile(session.user.id);
            }
        }
        
        async function loadUserProfile(userId) {
            if (!supabaseClient) return;
            
            const { data, error } = await supabaseClient
                .from('user_profiles')
                .select(`
                    *,
                    locations (*)
                `)
                .eq('id', userId)
                .single();
            
            if (data) {
                currentUser = {
                    id: data.id,
                    username: data.username,
                    role: data.role,
                    name: data.full_name,
                    department: data.department
                };
                userLocation = data.locations;
                await loadAllData();
                render();
            }
        }
        
        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        
        async function loadAllData() {
            if (!userLocation || !supabaseClient) return;
            
            await Promise.all([
                loadVehicles(),
                loadWorkflows(),
                loadTechnicians(),
                loadStepThresholds(),
                loadTagDefinitions()
            ]);
        }
        
        async function loadVehicles() {
            if (!supabaseClient) return;
            
            const { data, error } = await supabaseClient
                .from('vehicles')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                vehicles = data.map(v => ({
                    ...v,
                    entryTime: new Date(v.entry_time),
                    stepStartTime: new Date(v.step_start_time),
                    completedSteps: v.completed_steps || [],
                    skippedSteps: v.skipped_steps || [],
                    tags: v.tags || [],
                    vehicleTags: v.vehicle_tags || [],
                    photos: v.photos || [],
                    stepHistory: v.step_history || [],
                    noteHistory: []
                }));
                
                // Load all notes in a single query (fixes N+1 performance issue)
                if (vehicles.length > 0) {
                    const vehicleIds = vehicles.map(v => v.id);
                    const { data: allNotes } = await supabaseClient
                        .from('vehicle_notes')
                        .select('*')
                        .in('vehicle_id', vehicleIds)
                        .order('created_at', { ascending: false });
                    
                    if (allNotes) {
                        // Group notes by vehicle_id
                        const notesByVehicle = {};
                        for (const n of allNotes) {
                            if (!notesByVehicle[n.vehicle_id]) notesByVehicle[n.vehicle_id] = [];
                            notesByVehicle[n.vehicle_id].push({
                                text: n.note_text,
                                timestamp: new Date(n.created_at),
                                user: n.username,
                                id: n.id
                            });
                        }
                        // Assign notes to each vehicle
                        for (const vehicle of vehicles) {
                            vehicle.noteHistory = notesByVehicle[vehicle.id] || [];
                        }
                    }
                }
                // Rebuild scan cache after vehicles + notes are loaded
                buildScanCache();
            }
        }
        
        async function loadVehicleNotes(vehicle) {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('vehicle_notes')
                .select('*')
                .eq('vehicle_id', vehicle.id)
                .order('created_at', { ascending: false });
            
            if (data) {
                vehicle.noteHistory = data.map(n => ({
                    text: n.note_text,
                    timestamp: new Date(n.created_at),
                    user: n.username,
                    id: n.id
                }));
            }
        }
        
        async function loadWorkflows() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                workflows = {};
                data.forEach(w => {
                    workflows[w.workflow_key] = {
                        name: w.name,
                        steps: w.steps || [],
                        color: w.color
                    };
                });
            }
        }
        
        async function loadTechnicians() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('technicians')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                // Convert flat array → step-keyed object: { 'Detail': ['John','Jane'], ... }
                technicians = {};
                data.forEach(t => {
                    const dept = t.department;
                    if (!dept) return;
                    if (!technicians[dept]) technicians[dept] = [];
                    if (!technicians[dept].includes(t.name)) technicians[dept].push(t.name);
                });
            }
        }
        
        async function loadStepThresholds() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('step_thresholds')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                stepThresholds = {};
                data.forEach(t => {
                    stepThresholds[t.step_name] = t.threshold_hours;
                });
            }
        }
        
        async function loadTagDefinitions() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('tag_definitions')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                tagDefinitions = {};
                data.forEach(t => {
                    tagDefinitions[t.tag_name] = {
                        color: t.color,
                        skipsStep: t.skips_step
                    };
                });
            }
        }
        
        // ============================================
        // MOCK DATA (REPLACED BY DATABASE)
        // ============================================
        // Mock Data and State Management
        const STEPS = [
            'Xpel', 'Detail', 'Final Touch', 'Glass Work', 
            'Photos', 'Mechanical', 'Body Shop', 'Quality Control', 'Finished'
        ];

        let currentUser = null;
        let currentView = 'dashboard';
        let selectedStepFilter = 'all'; // New filter state
        let selectedTechFilter = 'all'; // Filter by technician
        let selectedStatFilter = 'all'; // Filter by stat card (all, inProgress, completed, overdue, suggested)
        let currentAdminTab = 'import'; // Admin panel tabs
        let expandedSteps = new Set(); // Track which steps are expanded to show substeps

        // Workflow system - define different recon paths
        let workflows = {
            'CPO': {
                name: 'CPO (Certified Pre-Owned)',
                steps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop', 'Quality Control', 'Finished'],
                color: '#48bb78'
            },
            'As-Is': {
                name: 'As-Is (Quick Sale)',
                steps: ['Detail', 'Photos', 'Mechanical', 'Quality Control', 'Finished'],
                color: '#ed8936'
            },
            'Wholesale': {
                name: 'Wholesale',
                steps: ['Mechanical', 'Photos', 'Finished'],
                color: '#9f7aea'
            }
        };

        let currentWorkflowFilter = 'all'; // Filter by workflow

        // Tag definitions - what each tag does
        let tagDefinitions = {
            'Skip Body Shop': { skipsStep: 'Body Shop', color: '#bee3f8' },
            'Skip Glass Work': { skipsStep: 'Glass Work', color: '#bee3f8' },
            'Skip Xpel': { skipsStep: 'Xpel', color: '#bee3f8' },
            'Priority': { priority: true, color: '#fbd38d' },
            'CPO': { special: true, color: '#c6f6d5' },
            'Wholesale': { special: true, color: '#fed7d7' }
        };

        // Substeps configuration - define substeps for each main step
        let substeps = {
            'Mechanical': ['Inspection', 'Parts Order', 'Repair', 'Completed'],
            'Body Shop': ['Estimate', 'Parts Order', 'Paint Prep', 'Paint', 'Reassembly', 'Completed'],
            'Detail': ['Exterior Wash', 'Interior Clean', 'Polish', 'Final Inspection'],
            'Quality Control': ['Initial Check', 'Test Drive', 'Final Approval']
        };

        // Step dependencies - which steps must be completed before this one
        let stepDependencies = {
            'Photos': ['Detail'],
            'Quality Control': ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop']
        };

        // Track which vehicles are locked from reassignment (in process)
        let reassignableLocks = new Set(); // VINs that cannot be auto-reassigned

        // Historical data directory (will be created relative to where file is loaded)
        let baseDirectory = '/home/claude'; // Will be updated on load
        let historyDirectory = `${baseDirectory}/recon_history`;
        let photosDirectory = `${baseDirectory}/vehicle_photos`;

        // Sample vehicles with different states
        let vehicles = [
            {
                vin: '1HGBH41JXMN109186',
                stockNumber: 'A12345',
                year: '2021',
                make: 'Honda',
                model: 'Accord',
                miles: 45230,
                appraisalNotes: 'Trade-in, good condition, minor scratches on bumper',
                entryTime: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                currentStep: 'Detail',
                currentSubstep: null,
                stepStartTime: new Date(Date.now() - 3 * 60 * 60 * 1000), // 3 hours ago
                completedSteps: ['Xpel'],
                completedSubsteps: {},
                skippedSteps: [],
                assignedTech: 'Mike Johnson',
                tags: [],
                vehicleTags: [],
                notes: 'Customer wants quick turnaround',
                noteHistory: [
                    { text: 'Customer wants quick turnaround', timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000), user: 'admin', id: 1 }
                ],
                photos: [],
                stepHistory: [
                    { step: 'Xpel', tech: 'Sarah Chen', startTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), endTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), duration: '24h' }
                ],
                workflow: 'CPO'
            },
            {
                vin: '2FMDK3GC8MBA12345',
                stockNumber: 'B98765',
                year: '2022',
                make: 'Ford',
                model: 'Edge',
                miles: 32100,
                appraisalNotes: 'Auction purchase, needs mechanical inspection',
                entryTime: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                currentStep: 'Mechanical',
                stepStartTime: new Date(Date.now() - 1 * 60 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos'],
                skippedSteps: [],
                assignedTech: 'Tom Wilson',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '5UXWX7C5XBA98765',
                stockNumber: 'C54321',
                year: '2023',
                make: 'BMW',
                model: 'X5',
                miles: 18500,
                appraisalNotes: 'Lease return, excellent condition',
                entryTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                currentStep: 'Xpel',
                stepStartTime: new Date(Date.now() - 30 * 60 * 1000),
                completedSteps: [],
                skippedSteps: ['Body Shop'],
                assignedTech: 'Sarah Chen',
                tags: ['Skip Body Shop'],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: 'WBADT43452G12345',
                stockNumber: 'D11111',
                year: '2020',
                make: 'BMW',
                model: '3 Series',
                miles: 67890,
                appraisalNotes: 'Needs paint work on rear quarter panel',
                entryTime: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),
                currentStep: 'Body Shop',
                stepStartTime: new Date(Date.now() - 5 * 60 * 60 * 1000), // 5 hours - OVERDUE
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical'],
                skippedSteps: [],
                assignedTech: 'Carlos Martinez',
                tags: [],
                notes: 'Priority - customer waiting',
                noteHistory: [
                    { text: 'Priority - customer waiting', timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), user: 'admin', id: 2 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: 'JM1BK32F781234567',
                stockNumber: 'E22222',
                year: '2022',
                make: 'Mazda',
                model: 'CX-5',
                miles: 25000,
                appraisalNotes: 'Clean vehicle, routine recon',
                entryTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                currentStep: 'Photos',
                stepStartTime: new Date(Date.now() - 1.8 * 60 * 60 * 1000), // 1.8 hours - approaching threshold with Jenny busy
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work'],
                skippedSteps: [],
                assignedTech: 'Jenny Park',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '3VW2B7AJ8DM123456',
                stockNumber: 'F33333',
                year: '2021',
                make: 'Volkswagen',
                model: 'Jetta',
                miles: 41200,
                appraisalNotes: 'Minor hail damage',
                entryTime: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
                currentStep: 'Final Touch',
                stepStartTime: new Date(Date.now() - 20 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail'],
                skippedSteps: ['Glass Work'],
                assignedTech: 'Mike Johnson',
                tags: ['Skip Glass Work'],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'As-Is'
            },
            {
                vin: '1G1YY22G965123456',
                stockNumber: 'G44444',
                year: '2019',
                make: 'Chevrolet',
                model: 'Corvette',
                miles: 55300,
                appraisalNotes: 'Windshield chip needs repair',
                entryTime: new Date(Date.now() - 12 * 60 * 60 * 1000),
                currentStep: 'Glass Work',
                stepStartTime: new Date(Date.now() - 90 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch'],
                skippedSteps: [],
                assignedTech: 'David Lee',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'Wholesale',
                stockNumber: 'G44444',
                miles: 55300,
                appraisalNotes: 'Windshield chip needs repair'
            },
            {
                vin: '5FNRL5H40BB123456',
                stockNumber: 'H55555',
                year: '2023',
                make: 'Honda',
                model: 'Odyssey',
                miles: 29800,
                appraisalNotes: 'CPO candidate, thorough inspection required',
                entryTime: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days - OLDEST
                currentStep: 'Quality Control',
                stepStartTime: new Date(Date.now() - 15 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop'],
                skippedSteps: [],
                assignedTech: 'Admin QC',
                tags: [],
                notes: 'Ready for final QC check',
                noteHistory: [
                    { text: 'Ready for final QC check', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), user: 'admin', id: 3 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '1FTFW1ET5DFC12345',
                stockNumber: 'Z99999',
                year: '2024',
                make: 'Ford',
                model: 'F-150',
                miles: 0,
                appraisalNotes: 'Incoming delivery - not yet on lot',
                entryTime: new Date(),
                currentStep: 'Awaiting Arrival',
                stepStartTime: new Date(),
                completedSteps: [],
                skippedSteps: [],
                assignedTech: 'unassigned',
                tags: [],
                vehicleTags: [],
                notes: '',
                noteHistory: [
                    { text: 'Vehicle added to system - awaiting arrival and workflow assignment', timestamp: new Date(), user: 'admin', id: 4 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'AWAITING'
            }
        ];

        // Vehicle history - stores all past vehicles (5 year retention)
        let vehicleHistory = [
            {
                vin: '1HGCM82633A123456',
                stockNumber: 'PAST001',
                miles: 32000,
                appraisalNotes: 'Trade-in, sold 2 years ago',
                completedDate: new Date('2023-03-15'),
                totalReconTime: '4 days',
                notes: 'Smooth process, no issues',
                photos: [],
                stepHistory: []
            }
        ];

        // Stock number registry to prevent duplicates
        let stockNumberRegistry = new Set(['A12345', 'B98765', 'C54321', 'D11111', 'E22222', 'F33333', 'G44444', 'H55555', 'PAST001']);

        let technicians = {
            'Xpel': ['Sarah Chen', 'Alex Rodriguez'],
            'Detail': ['Mike Johnson', 'Chris Brown'],
            'Final Touch': ['Mike Johnson', 'Jenny Park'],
            'Glass Work': ['David Lee'],
            'Photos': ['Jenny Park', 'Lisa Wang'],
            'Mechanical': ['Tom Wilson', 'Robert Garcia'],
            'Body Shop': ['Carlos Martinez', 'James Anderson'],
            'Quality Control': ['Admin QC'],
            'Finished': []
        };

        let stepThresholds = {
            'Xpel': 2,
            'Detail': 2,
            'Final Touch': 2,
            'Glass Work': 2,
            'Photos': 2,
            'Mechanical': 2,
            'Body Shop': 2,
            'Quality Control': 2,
            'Finished': 0
        };

        let lastAssignment = {}; // Track last assignment per step
        let technicianStatus = {}; // Track if technician is currently working or available

        // Initialize technician status — technicians is always a step-keyed object
        function initTechnicianStatus() {
            Object.entries(technicians).forEach(([step, techs]) => {
                (techs || []).forEach(tech => {
                    if (!technicianStatus[tech]) {
                        technicianStatus[tech] = {
                            currentVehicle: null,
                            available: true,
                            lastCompleted: null
                        };
                    }
                });
            });

            // Set current assignments based on vehicles
            vehicles.forEach(v => {
                if (v.assignedTech && technicianStatus[v.assignedTech]) {
                    technicianStatus[v.assignedTech].currentVehicle = v.vin;
                    technicianStatus[v.assignedTech].available = false;
                }
            });
        }

        // Check if there's a better technician available
        function suggestTechnicianChange(vehicle) {
            const step = vehicle.currentStep;
            const currentTech = vehicle.assignedTech;
            const hoursInStep = (Date.now() - vehicle.stepStartTime.getTime()) / (1000 * 60 * 60);
            const threshold = stepThresholds[step] || 2;
            
            // Only suggest if vehicle has been waiting too long (80% of threshold)
            if (hoursInStep < threshold * 0.8) {
                return null;
            }
            
            const availableTechs = (technicians[step] || []).filter(tech => {
                // Check if tech is available or has completed their current job
                const status = technicianStatus[tech];
                if (!status) return false;
                
                // Tech is available
                if (status.available) return true;
                
                // Or tech has a vehicle that's been completed (in mock, check if assigned vehicle is still in same step)
                if (status.currentVehicle) {
                    const assignedVehicle = vehicles.find(v => v.vin === status.currentVehicle);
                    // If vehicle moved to next step, tech is available
                    if (assignedVehicle && assignedVehicle.currentStep !== step) {
                        status.available = true;
                        status.currentVehicle = null;
                        return true;
                    }
                }
                
                return false;
            });
            
            // If there's an available tech and current tech is still busy
            if (availableTechs.length > 0 && currentTech) {
                const currentTechStatus = technicianStatus[currentTech];
                if (currentTechStatus && !currentTechStatus.available) {
                    // Find the tech who completed their last job earliest
                    let bestTech = availableTechs[0];
                    let earliestCompletion = technicianStatus[bestTech]?.lastCompleted || 0;
                    
                    availableTechs.forEach(tech => {
                        const completion = technicianStatus[tech]?.lastCompleted || 0;
                        if (completion < earliestCompletion) {
                            bestTech = tech;
                            earliestCompletion = completion;
                        }
                    });
                    
                    return {
                        currentTech: currentTech,
                        suggestedTech: bestTech,
                        reason: 'Available technician can start immediately',
                        waitTime: formatTimeDiff(vehicle.stepStartTime)
                    };
                }
            }
            
            return null;
        }

        // Apply suggested reassignment
        function reassignTechnician(vin, newTech) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const oldTech = vehicle.assignedTech;
            
            // Update vehicle assignment
            vehicle.assignedTech = newTech;
            
            // Update technician status
            if (technicianStatus[oldTech]) {
                technicianStatus[oldTech].currentVehicle = null;
                technicianStatus[oldTech].available = true;
            }
            
            if (technicianStatus[newTech]) {
                technicianStatus[newTech].currentVehicle = vin;
                technicianStatus[newTech].available = false;
            }
            
            closeDialog();
            
            render();
            alert(`Vehicle ${vehicle.stockNumber || vin} reassigned from ${oldTech} to ${newTech}`);
        }

        // Users database
        const users = {
            'admin': { password: 'admin123', role: 'administrator', name: 'Admin User' },
            'mike': { password: 'tech123', role: 'technician', name: 'Mike Johnson', department: 'Detail' },
            'sarah': { password: 'tech123', role: 'technician', name: 'Sarah Chen', department: 'Xpel' },
            'tom': { password: 'tech123', role: 'technician', name: 'Tom Wilson', department: 'Mechanical' }
        };

        // Utility Functions
        function isAdmin() {
            return currentUser && (currentUser.role === 'administrator' || currentUser.role === 'superadmin');
        }
        
        function formatTimeDiff(date) {
            const diff = Date.now() - date.getTime();
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function isOverdue(vehicle) {
            const threshold = stepThresholds[vehicle.currentStep] || 2;
            const hoursInStep = (Date.now() - vehicle.stepStartTime.getTime()) / (1000 * 60 * 60);
            return hoursInStep > threshold;
        }

        function getNextStep(vehicle) {
            // Find next step that's not completed and not skipped
            for (let step of STEPS) {
                if (step === 'Quality Control' || step === 'Finished') {
                    // These come at the end in specific order
                    continue;
                }
                if (!vehicle.completedSteps.includes(step) && !vehicle.skippedSteps.includes(step)) {
                    return step;
                }
            }
            
            // If all regular steps are done, go to QC
            if (!vehicle.completedSteps.includes('Quality Control')) {
                return 'Quality Control';
            }
            
            return 'Finished';
        }

        function getSmartNextStep(vehicle) {
            // Get all remaining steps (excluding QC and Finished)
            const remainingSteps = STEPS.filter(step => 
                step !== 'Quality Control' && 
                step !== 'Finished' &&
                !vehicle.completedSteps.includes(step) && 
                !vehicle.skippedSteps.includes(step)
            );

            if (remainingSteps.length === 0) {
                // All regular steps done, move to QC
                return 'Quality Control';
            }

            // Count vehicles in each remaining step
            const queueCounts = {};
            remainingSteps.forEach(step => {
                queueCounts[step] = vehicles.filter(v => v.currentStep === step).length;
            });

            // Find step with shortest queue
            let shortestQueue = remainingSteps[0];
            let shortestCount = queueCounts[remainingSteps[0]];

            remainingSteps.forEach(step => {
                if (queueCounts[step] < shortestCount) {
                    shortestQueue = step;
                    shortestCount = queueCounts[step];
                }
            });

            return shortestQueue;
        }

        function assignTechnician(step) {
            const techList = technicians[step] || [];
            if (techList.length === 0) return null;

            // Count current assignments per tech across ALL steps (total workload)
            const counts = {};
            techList.forEach(t => { counts[t] = 0; });
            vehicles.forEach(v => {
                if (v.currentStep !== 'Finished' && v.assignedTech && counts.hasOwnProperty(v.assignedTech)) {
                    counts[v.assignedTech]++;
                }
            });

            // Pick tech with lowest total workload
            let bestTech = techList[0];
            let bestCount = Infinity;
            techList.forEach(t => {
                if (counts[t] < bestCount) {
                    bestCount = counts[t];
                    bestTech = t;
                }
            });
            lastAssignment[step] = bestTech;
            return bestTech;
        }

        function getAvailableTechnician(step) {
            const techList = technicians[step] || [];
            if (techList.length === 0) return null;

            // Count current assignments per tech for THIS step
            const counts = {};
            techList.forEach(t => { counts[t] = 0; });
            vehicles.forEach(v => {
                if (v.currentStep === step && v.assignedTech && counts.hasOwnProperty(v.assignedTech)) {
                    counts[v.assignedTech]++;
                }
            });

            // Return the tech with the fewest assignments (true load balancing)
            let bestTech = techList[0];
            let bestCount = Infinity;
            techList.forEach(t => {
                if (counts[t] < bestCount) {
                    bestCount = counts[t];
                    bestTech = t;
                }
            });
            return bestTech;
        }

        function getSuggestedAlternateStep(vehicle) {
            // Get all steps the vehicle still needs (excluding completed, skipped, QC, and Finished)
            const remainingSteps = STEPS.filter(step => 
                step !== 'Quality Control' && 
                step !== 'Finished' &&
                step !== vehicle.currentStep &&
                !vehicle.completedSteps.includes(step) && 
                !vehicle.skippedSteps.includes(step)
            );

            if (remainingSteps.length === 0) {
                return null; // No other steps available
            }

            // Calculate queue lengths for each remaining step
            const queueInfo = remainingSteps.map(step => {
                const queueLength = vehicles.filter(v => v.currentStep === step).length;
                const currentStepQueue = vehicles.filter(v => v.currentStep === vehicle.currentStep).length;
                
                return {
                    step: step,
                    queueLength: queueLength,
                    improvement: currentStepQueue - queueLength
                };
            });

            // Find step with shortest queue that's actually better than current
            const bestAlternate = queueInfo
                .filter(info => info.improvement > 0) // Only suggest if it's actually better
                .sort((a, b) => b.improvement - a.improvement)[0];

            return bestAlternate ? bestAlternate.step : null;
        }

        async function reassignVehicle(vin, newTech) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                vehicle.assignedTech = newTech;
                vehicle.stepStartTime = new Date();
                await persistVehicleState(vehicle);
                render();
                alert(`✓ Vehicle ${vehicle.stockNumber || vin} reassigned to ${newTech}`);
            }
        }

        async function moveToSuggestedStep(vin, newStep) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                // Safety check: Don't allow moving to QC or Finished without all steps completed
                if (newStep === 'Quality Control') {
                    const allStepsComplete = STEPS.filter(s => 
                        s !== 'Quality Control' && 
                        s !== 'Finished'
                    ).every(step => 
                        vehicle.completedSteps.includes(step) || 
                        vehicle.skippedSteps.includes(step)
                    );
                    
                    if (!allStepsComplete) {
                        alert('❌ Cannot move to Quality Control - all prior steps must be completed first!');
                        return;
                    }
                }
                
                if (newStep === 'Finished') {
                    if (!vehicle.completedSteps.includes('Quality Control')) {
                        alert('❌ Cannot move to Finished - must complete Quality Control first!');
                        return;
                    }
                }
                
                vehicle.currentStep = newStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(newStep);

                await persistVehicleState(vehicle);
                render();
                alert(`✓ Vehicle ${vehicle.stockNumber || vin} moved to ${newStep}`);
            }
        }

        // ── Persist vehicle state to Supabase after any step change ──
        async function persistVehicleState(vehicle) {
            if (!supabaseClient || !vehicle.id) {
                console.warn('persistVehicleState: skipped — no supabaseClient or vehicle.id', vehicle?.stockNumber);
                return;
            }
            try {
                const { data, error } = await supabaseClient
                    .from('vehicles')
                    .update({
                        current_step:     vehicle.currentStep,
                        step_start_time:  vehicle.stepStartTime instanceof Date
                                            ? vehicle.stepStartTime.toISOString()
                                            : vehicle.stepStartTime,
                        assigned_tech:    vehicle.assignedTech,
                        completed_steps:  vehicle.completedSteps,
                        skipped_steps:    vehicle.skippedSteps,
                        workflow:         vehicle.workflow
                    })
                    .eq('id', vehicle.id)
                    .select('id');

                if (error) {
                    console.error('persistVehicleState DB error:', error.message, '| vehicle:', vehicle.stockNumber);
                    alert('⚠️ Save failed for ' + (vehicle.stockNumber || vehicle.vin) + ': ' + error.message);
                } else if (!data || data.length === 0) {
                    console.error('persistVehicleState: 0 rows updated — RLS is blocking UPDATE. Vehicle:', vehicle.stockNumber, 'id:', vehicle.id);
                    alert('⚠️ Save blocked for ' + (vehicle.stockNumber || vehicle.vin) + '.\n\nYour Supabase RLS policy is blocking UPDATE on the vehicles table.\n\nRun this in your Supabase SQL editor to fix it:\n\nCREATE POLICY \"Allow authenticated updates\"\nON vehicles FOR UPDATE\nUSING (auth.uid() IS NOT NULL);');
                } else {
                    console.log('✅ Saved:', vehicle.stockNumber, '→', vehicle.currentStep);
                }
            } catch (e) {
                console.error('persistVehicleState exception:', e.message);
            }
        }

        async function completeStep(vehicle) {
            // Mark current step as complete
            vehicle.completedSteps.push(vehicle.currentStep);
            
            // Update technician status - they're now available
            if (vehicle.assignedTech && technicianStatus[vehicle.assignedTech]) {
                technicianStatus[vehicle.assignedTech].available = true;
                technicianStatus[vehicle.assignedTech].currentVehicle = null;
                technicianStatus[vehicle.assignedTech].lastCompleted = Date.now();
            }
            
            // Determine next step using smart routing with safety checks
            let nextStep;
            
            if (vehicle.currentStep === 'Quality Control') {
                nextStep = 'Finished';
            } else {
                // Check if all regular steps are complete
                const allRegularStepsComplete = STEPS.filter(s => 
                    s !== 'Quality Control' && 
                    s !== 'Finished'
                ).every(step => 
                    vehicle.completedSteps.includes(step) || 
                    vehicle.skippedSteps.includes(step)
                );
                
                if (allRegularStepsComplete) {
                    // All steps done, move to Quality Control
                    nextStep = 'Quality Control';
                } else {
                    // Get smart next step from remaining steps
                    nextStep = getSmartNextStep(vehicle);
                }
            }
            
            vehicle.currentStep = nextStep;
            vehicle.stepStartTime = new Date();
            const newTech = assignTechnician(nextStep);
            vehicle.assignedTech = newTech;
            
            // Update new technician status
            if (newTech && technicianStatus[newTech]) {
                technicianStatus[newTech].available = false;
                technicianStatus[newTech].currentVehicle = vehicle.vin;
            }

            await persistVehicleState(vehicle);
            render();
        }

        async function rejectFromQC(vehicle, sendBackTo) {
            // Remove the step from completed so it needs to be done again
            const index = vehicle.completedSteps.indexOf(sendBackTo);
            if (index > -1) {
                vehicle.completedSteps.splice(index);
            }
            
            vehicle.currentStep = sendBackTo;
            vehicle.stepStartTime = new Date();
            vehicle.assignedTech = assignTechnician(sendBackTo);

            await persistVehicleState(vehicle);
            render();
        }

        // Rendering Functions
        function renderLogin() {
            return `
                <div class="login-container">
                    <h2 class="login-title">🚗 Vehicle Recon System</h2>
                    
                    <form id="loginForm" onsubmit="event.preventDefault(); login();" style="width: 100%;">
                        <div class="form-group">
                            <label>Email / Username</label>
                            <input type="text" id="username" placeholder="Enter email or username" autofocus>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="password" placeholder="Enter password">
                        </div>
                        <button type="submit" id="loginBtn" class="btn" style="width: 100%">Login</button>
                    </form>

                    <div class="login-spinner" id="loginSpinner">
                        <div class="spinner-ring"></div>
                        <span class="spinner-msg" id="loginSpinnerMsg">Signing in…</span>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header>
                    <h1>🚗 Vehicle Recon Management System</h1>
                   <div class="user-info">
    <span>👤 ${currentUser.name || currentUser.username}</span>
    <span>Role: ${currentUser.role}</span>
    ${currentUser.department ? `<span>Dept: ${currentUser.department}</span>` : ''}
    
    ${currentUser && currentUser.role === 'superadmin' && userLocations.length > 0 ? `
        <div style="display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; color: #718096; font-weight: bold;">📍 Viewing:</label>
            ${userLocations.length > 1 ? `
                <select id="locationSwitcher" onchange="handleLocationSwitch(this.value)" style="padding: 6px; border: 2px solid #4299e1; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    ${userLocations.map(loc => `
                        <option value="${loc.id}" ${loc.id === currentLocationId ? 'selected' : ''}>
                            ${loc.name}
                        </option>
                    `).join('')}
                </select>
            ` : `
                <span style="padding: 6px; background: #e6f7ff; border: 2px solid #4299e1; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    ${userLocations[0]?.name || 'No Location'}
                </span>
            `}
        </div>
    ` : (userLocations.length > 0 ? `
        <span style="padding: 6px; background: #f7fafc; border: 2px solid #cbd5e0; border-radius: 4px; font-size: 12px;">
            📍 ${userLocations[0]?.name || 'Location'}
        </span>
    ` : '')}
    
</div>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </header>
            `;
        }

        function renderTechSummary(stepVehicles) {
            if (!stepVehicles || stepVehicles.length === 0) return '';
            const techMap = {};
            stepVehicles.forEach(function(v) {
                const t = v.assignedTech || 'Unassigned';
                if (!techMap[t]) techMap[t] = { total: 0, overdue: 0 };
                techMap[t].total++;
                if (isOverdue(v)) techMap[t].overdue++;
            });
            const entries = Object.entries(techMap);
            if (entries.length === 0) return '';
            let html = '<div style="display:flex;flex-wrap:wrap;gap:5px;margin:6px 0 10px;">';
            entries.forEach(function(entry) {
                const tech = entry[0];
                const stats = entry[1];
                // If a tech filter is active and this isn't it, skip entirely
                if (selectedTechFilter !== 'all' && selectedTechFilter !== tech) return;
                const hasO = stats.overdue > 0;
                const isActive = selectedTechFilter === tech;
                const dot = '<span style="width:7px;height:7px;border-radius:50%;background:' + (hasO ? '#fc8181' : '#68d391') + ';display:inline-block;flex-shrink:0;"></span>';
                const countBadge = '<span style="background:' + (hasO ? '#fc8181' : '#9ae6b4') + ';color:' + (hasO ? '#fff' : '#22543d') + ';border-radius:10px;padding:1px 6px;font-size:10px;margin-left:3px;">' + stats.total + '</span>';
                const overdueBadge = hasO ? '<span style="background:#e53e3e;color:white;border-radius:10px;padding:1px 6px;font-size:10px;margin-left:2px;">⚠ ' + stats.overdue + '</span>' : '';
                const borderColor = hasO ? '#fc8181' : '#68d391';
                const bg = isActive ? (hasO ? '#fed7d7' : '#c6f6d5') : (hasO ? '#fff5f5' : '#f0fff4');
                const color = hasO ? '#c53030' : '#276749';
                const ring = isActive ? 'outline:2px solid ' + borderColor + ';outline-offset:1px;' : '';
                const closeX = isActive ? ' <span style=\"font-size:9px;margin-left:2px;opacity:0.7;\">✕</span>' : '';
                const escapedTech = tech.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                html += '<span onclick="filterByTech(\'' + escapedTech + '\')" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:3px 8px 3px 6px;border-radius:20px;font-size:11px;font-weight:600;background:' + bg + ';border:1.5px solid ' + borderColor + ';color:' + color + ';' + ring + 'transition:all 0.15s;" title="' + (isActive ? 'Click to clear filter' : 'Click to filter by ' + tech) + '">' + dot + ' ' + tech + countBadge + overdueBadge + closeX + '</span>';
            });
            html += '</div>';
            return html;
        }

        function renderDashboard() {
            const totalVehicles = vehicles.length;
            const awaitingArrival = vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING').length;
            const inProgress = vehicles.filter(v => v.currentStep !== 'Finished' && v.workflow && v.workflow !== 'AWAITING').length;
            const completed = vehicles.filter(v => v.currentStep === 'Finished').length;
            const overdue = vehicles.filter(v => isOverdue(v) && v.currentStep !== 'Finished').length;


            
            // Calculate suggested changes
            const suggested = vehicles.filter(v => {
                if (v.currentStep === 'Finished') return false;
                if (!v.workflow || v.workflow === 'AWAITING') return false;
                const suggestedStep = getSuggestedAlternateStep(v);
                const availableTech = getAvailableTechnician(v.currentStep);
                return suggestedStep !== null || (availableTech && availableTech !== v.assignedTech);
            }).length;

            // Filter vehicles based on selected stat
            let vehiclesToShow = vehicles;
            if (selectedStatFilter !== 'all') {
                vehiclesToShow = getVehiclesByStat(selectedStatFilter);
            }

            // Filter by workflow
            if (currentWorkflowFilter !== 'all') {
                vehiclesToShow = vehiclesToShow.filter(v => v.workflow === currentWorkflowFilter);
            }

            // Filter by selected technician
            if (selectedTechFilter !== 'all') {
                vehiclesToShow = vehiclesToShow.filter(v => (v.assignedTech || 'Unassigned') === selectedTechFilter);
            }

            const queuesByStep = {};
            STEPS.forEach(step => {
                queuesByStep[step] = vehiclesToShow.filter(v => v.currentStep === step);
            });

            // Filter steps if a specific step is selected
            const stepsToShow = selectedStepFilter === 'all' 
                ? STEPS 
                : [selectedStepFilter];

            return `
                ${isAdmin() ? `
                <div class="step-filter-bar">
                    <div class="step-filter-buttons">
                        <button class="step-filter-btn ${selectedStepFilter === 'all' ? 'all-steps' : ''}" 
                                onclick="filterByStep('all')">
                            <div>All Steps</div>
                            <div class="step-counts">
                                <span class="count-badge count-in-step">${inProgress}</span>
                            </div>
                        </button>
                        ${STEPS.filter(s => s !== 'Finished').map(step => {
                            const stats = getStepStats(step);
                            // Only show step if it has vehicles in it
                            if (stats.inStep === 0) return '';
                            return `
                            <button class="step-filter-btn ${selectedStepFilter === step ? 'active' : ''}" 
                                    onclick="filterByStep('${step}')">
                                <div>${step}</div>
                                <div class="step-counts">
                                    <span class="count-badge count-in-step" title="Vehicles in step">${stats.inStep}</span>
                                    ${stats.movable > 0 ? `<span class="count-badge count-movable" title="Can move to faster step">${stats.movable}</span>` : ''}
                                    ${stats.overdue > 0 ? `<span class="count-badge count-overdue" title="Overdue vehicles">${stats.overdue}</span>` : ''}
                                </div>
                            </button>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="workflow-bar">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 15px;">Workflows:</strong>
                    </div>
                    <div class="workflow-buttons">
                        <button class="workflow-btn ${currentWorkflowFilter === 'all' ? 'active' : ''}" 
                                style="border-color: #718096; ${currentWorkflowFilter === 'all' ? 'background: #718096; color: white;' : ''}"
                                onclick="filterByWorkflow('all')">
                            All Workflows
                            <span class="workflow-badge">${vehicles.filter(v => v.workflow && v.workflow !== 'AWAITING').length}</span>
                        </button>
                        ${Object.entries(workflows).map(([id, workflow]) => {
                            const count = vehicles.filter(v => v.workflow === id).length;
                            // Only show workflow if it has vehicles
                            if (count === 0) return '';
                            return `
                                <button class="workflow-btn ${currentWorkflowFilter === id ? 'active' : ''}" 
                                        style="border-color: ${workflow.color}; ${currentWorkflowFilter === id ? `background: ${workflow.color}; color: white;` : ''}"
                                        onclick="filterByWorkflow('${id}')">
                                    ${workflow.name}
                                    <span class="workflow-badge">${count}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card ${selectedStatFilter === 'awaiting' ? 'active' : ''}" onclick="filterByStat('awaiting')" style="border: 2px solid #f39c12;">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'awaiting' ? 'white' : '#f39c12'}">${awaitingArrival}</div>
                        <div class="stat-label">Awaiting Arrival</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'total' ? 'active' : ''}" onclick="filterByStat('total')">
                        <div class="stat-value">${totalVehicles}</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'inProgress' ? 'active' : ''}" onclick="filterByStat('inProgress')">
                        <div class="stat-value">${inProgress}</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'completed' ? 'active' : ''}" onclick="filterByStat('completed')">
                        <div class="stat-value">${completed}</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'overdue' ? 'active' : ''}" onclick="filterByStat('overdue')">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'overdue' ? 'white' : (overdue > 0 ? '#e53e3e' : '#48bb78')}">${overdue}</div>
                        <div class="stat-label">Overdue Vehicles</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'suggested' ? 'active' : ''}" onclick="filterByStat('suggested')">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'suggested' ? 'white' : (suggested > 0 ? '#f39c12' : '#48bb78')}">${suggested}</div>
                        <div class="stat-label">Suggested Changes</div>
                    </div>
                </div>

                <!-- Awaiting Arrival Button -->
                ${awaitingArrival > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <button onclick="openAwaitingModal()" style="
                            padding: 12px 24px;
                            background: #f39c12;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: bold;
                            cursor: pointer;
                            animation: flashOrange 1.5s ease-in-out infinite;
                            box-shadow: 0 4px 12px rgba(243,156,18,0.4);
                        ">
                            ⏳ Awaiting Arrival &mdash; ${awaitingArrival} vehicle${awaitingArrival !== 1 ? 's' : ''}
                        </button>
                    </div>
                ` : ''}


                <div class="queue-board ${selectedStepFilter !== 'all' ? 'single-step' : ''}">
                    ${stepsToShow.map(step => {
                        const stepVehicles = queuesByStep[step];
                        const hasOverdue = stepVehicles.some(v => isOverdue(v));
                        const overdueVehicles = stepVehicles.filter(v => isOverdue(v));
                        
                        return `
                        <div class="queue-column ${hasOverdue ? 'has-overdue' : ''}">
                            <div class="queue-header">
                                <span class="queue-title">${step}</span>
                                <span class="queue-count">${stepVehicles.length}</span>
                            </div>
                            ${hasOverdue ? `
                                <div class="overdue-alert">
                                    ⚠️ ${overdueVehicles.length} OVERDUE!
                                </div>
                            ` : ''}
                            ${renderTechSummary(stepVehicles)}
                            <div class="${selectedStepFilter !== 'all' ? 'vehicle-grid' : ''}">
                            ${stepVehicles
                                .sort((a, b) => a.entryTime - b.entryTime) // Oldest first
                                .map(vehicle => {
                                    const vehicleOverdue = isOverdue(vehicle);
                                    const availableTech = getAvailableTechnician(step);
                                    const shouldSuggestReassign = availableTech && 
                                        availableTech !== vehicle.assignedTech;
                                    
                                    const suggestedStep = getSuggestedAlternateStep(vehicle);
                                    const shouldSuggestStepChange = suggestedStep !== null;
                                    
                                    // On filtered view, always show suggestions if available
                                    const isFilteredView = selectedStepFilter !== 'all';
                                    const showStepSuggestion = isFilteredView ? shouldSuggestStepChange : (vehicleOverdue && shouldSuggestStepChange);
                                    const showTechSuggestion = isFilteredView ? shouldSuggestReassign : (vehicleOverdue && shouldSuggestReassign);
                                    
                                    return `
                                    <div class="vehicle-card ${vehicleOverdue ? 'overdue' : ''} ${(showStepSuggestion || showTechSuggestion) ? 'needs-attention' : ''}" onclick="showVehicleDetails('${vehicle.vin}')">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <div class="vehicle-vin">${vehicle.stockNumber || vehicle.vin}</div>
                                                ${vehicle.year && vehicle.make && vehicle.model ? `
                                                    <div style="font-size: 11px; color: #718096; margin-top: 2px;">
                                                        ${vehicle.year} ${vehicle.make} ${vehicle.model}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 5px;">
                                                <span class="progress-indicator">${vehicle.completedSteps.length}/${STEPS.length - 1}</span>
                                                ${isAdmin() ? `
                                                    <span class="lock-icon" 
                                                          onclick="event.stopPropagation(); toggleReassignLock('${vehicle.vin}')" 
                                                          title="${reassignableLocks.has(vehicle.vin) ? 'Locked from auto-reassign' : 'Click to lock from auto-reassign'}">
                                                        ${reassignableLocks.has(vehicle.vin) ? '🔒' : '🔓'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="vehicle-time">⏱️ ${formatTimeDiff(vehicle.stepStartTime)} in step</div>
                                        <div class="vehicle-time">📅 ${formatTimeDiff(vehicle.entryTime)} in system</div>
                                        <div class="vehicle-time">👤 ${vehicle.assignedTech || 'Unassigned'}</div>
                                        ${vehicle.tags.length > 0 ? `
                                            <div class="vehicle-tags">
                                                ${vehicle.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        ${vehicleOverdue ? '<div class="vehicle-tags"><span class="tag alert-tag">⚠️ OVERDUE</span></div>' : ''}
                                        ${isAdmin() && vehicle.currentStep !== 'Finished' ? `
                                            <button class="quick-complete-btn" onclick="event.stopPropagation(); quickCompleteStep('${vehicle.vin}')">
                                                ✓ Complete ${vehicle.currentStep}
                                            </button>
                                        ` : ''}
                                        ${(currentUser && (currentUser.role === 'administrator' || currentUser.role === 'superadmin')) && vehicle.currentStep !== 'Finished' ? `
                                            <button class="quick-complete-btn" onclick="event.stopPropagation(); pushToFinished('${vehicle.vin}')" style="background:#805ad5;margin-top:4px;">
                                                🏁 Push to Finished
                                            </button>
                                        ` : ''}
                                        ${showStepSuggestion ? `
                                            <div class="step-suggestion" onclick="event.stopPropagation()">
                                                <strong>🔄 Move to Different Step:</strong><br>
                                                ${suggestedStep} has shorter queue
                                                <button class="step-btn" onclick="event.stopPropagation(); moveToSuggestedStep('${vehicle.vin}', '${suggestedStep}')">
                                                    Move to ${suggestedStep}
                                                </button>
                                            </div>
                                        ` : ''}
                                        ${showTechSuggestion ? `
                                            <div class="reassign-suggestion" onclick="event.stopPropagation()">
                                                <strong>💡 Reassign Technician:</strong><br>
                                                ${availableTech} is available
                                                <button class="reassign-btn" onclick="event.stopPropagation(); reassignVehicle('${vehicle.vin}', '${availableTech}')">
                                                    Reassign to ${availableTech}
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `}).join('')}
                            </div>
                            ${stepVehicles.length === 0 ? '<div style="color: #a0aec0; text-align: center; padding: 20px;">No vehicles</div>' : ''}
                        </div>
                    `}).join('')}
                </div>
                
                ${isAdmin() && inProgress > 0 ? `
                    <button class="auto-reassign-btn" onclick="autoReassignAll()" title="Auto-optimize all vehicle assignments">
                        🤖 Auto-Reassign All
                    </button>
                ` : ''}
            `;
        }

        function renderTechnicianView() {
            // Find vehicle assigned to current technician in their department
            const techDept = currentUser.department;
            const assignedVehicle = vehicles.find(v => 
                v.assignedTech === currentUser.name && 
                v.currentStep === techDept &&
                v.currentStep !== 'Finished'
            );

            if (!assignedVehicle) {
                // Show vehicles in their department queue
                const deptVehicles = vehicles.filter(v => v.currentStep === techDept);
                
                return `
                    <div class="tech-assignment">
                        <div class="no-assignment">
                            <h2>✅ No Current Assignment</h2>
                            <p style="margin-top: 10px;">Waiting for next vehicle in ${techDept}...</p>
                            ${deptVehicles.length > 0 ? `
                                <p style="margin-top: 15px; color: #4a5568;">
                                    <strong>${deptVehicles.length}</strong> vehicle${deptVehicles.length !== 1 ? 's' : ''} in ${techDept} queue
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="tech-assignment">
                    <h2 style="font-size: 18px; margin-bottom: 10px;">Current Assignment - ${currentUser.department}</h2>
                    <div class="assignment-vin">${assignedVehicle.stockNumber || assignedVehicle.vin}</div>
                    ${assignedVehicle.year && assignedVehicle.make && assignedVehicle.model ? `
                        <div style="font-size: 13px; color: #718096; margin-top: 5px; margin-bottom: 10px;">
                            ${assignedVehicle.year} ${assignedVehicle.make} ${assignedVehicle.model}
                        </div>
                    ` : ''}
                    <div class="assignment-step">Step: ${assignedVehicle.currentStep}</div>
                    <div style="margin: 15px 0; color: #718096; font-size: 14px;">
                        <div>⏱️ Time in step: ${formatTimeDiff(assignedVehicle.stepStartTime)}</div>
                        <div>📅 Total time in system: ${formatTimeDiff(assignedVehicle.entryTime)}</div>
                        ${assignedVehicle.tags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${assignedVehicle.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}
                            </div>
                        ` : ''}
                    </div>
                    <button class="complete-btn" onclick="completeTechStep('${assignedVehicle.vin}')">
                        ✓ Mark Complete
                    </button>
                </div>
            `;
        }

        function renderAdminPanel() {
            return `
                <div class="admin-tabs">
                    <button class="admin-tab ${currentAdminTab === 'dashboard' ? 'active' : ''}" onclick="switchAdminTab('dashboard')">
                        📊 Dashboard
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'usermgmt' ? 'active' : ''}" onclick="switchAdminTab('usermgmt')">
                        👥 User Management
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'import' ? 'active' : ''}" onclick="switchAdminTab('import')">
                        📋 Import Vehicles
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'steps' ? 'active' : ''}" onclick="switchAdminTab('steps')">
                        🔧 Steps
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'techs' ? 'active' : ''}" onclick="switchAdminTab('techs')">
                        👨‍🔧 Technicians
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'tags' ? 'active' : ''}" onclick="switchAdminTab('tags')">
                        🏷️ Tags
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'workflows' ? 'active' : ''}" onclick="switchAdminTab('workflows')">
                        🔄 Workflows
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'settings' ? 'active' : ''}" onclick="switchAdminTab('settings')">
                        ⚙️ Settings
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'data' ? 'active' : ''}" onclick="switchAdminTab('data')">
                        💾 Data Management
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'report' ? 'active' : ''}" onclick="switchAdminTab('report')">
                        📊 Report
                    </button>
                    ${currentUser && currentUser.role === 'superadmin' ? `
                    <button class="admin-tab ${currentAdminTab === 'locations' ? 'active' : ''}" onclick="switchAdminTab('locations')">
                        🏢 Locations
                    </button>
                    ` : ''}
                </div>

                <!-- Dashboard Tab -->
                <div class="admin-content ${currentAdminTab === 'dashboard' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">📊 Management Dashboard</h2>
                        
                        <!-- Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #e6f7ff; border: 2px solid #4299e1; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #4299e1;" id="totalLocations">-</div>
                                <div style="font-size: 14px; color: #2c5282;">Total Locations</div>
                            </div>
                            <div style="background: #f0fdf4; border: 2px solid #48bb78; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #48bb78;" id="totalUsers">-</div>
                                <div style="font-size: 14px; color: #22543d;">Total Users</div>
                            </div>
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #f59e0b;" id="totalAdmins">-</div>
                                <div style="font-size: 14px; color: #78350f;">Administrators</div>
                            </div>
                            <div style="background: #fce7f3; border: 2px solid #ec4899; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ec4899;" id="totalSuperAdmins">-</div>
                                <div style="font-size: 14px; color: #831843;">Super Admins</div>
                            </div>
                        </div>
                        
                        <!-- Locations Overview -->
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">🏢 Locations Overview</h3>
                                <button class="btn" onclick="showAddLocationForm()" style="background: #48bb78; padding: 8px 16px; font-size: 13px;">
                                    ➕ Add Location
                                </button>
                            </div>
                            <div id="locationsTable">Loading...</div>
                        </div>
                        
                        <!-- Users by Location -->
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-bottom: 15px;">👥 Users by Location</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="font-size: 13px; font-weight: bold; margin-right: 10px;">Filter by Location:</label>
                                <select id="locationFilter" onchange="filterUsersByLocation(this.value)" 
                                        style="padding: 6px; border: 2px solid #cbd5e0; border-radius: 4px; font-size: 13px;">
                                    <option value="all">All Locations</option>
                                </select>
                            </div>
                            <div id="usersTable">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="admin-content ${currentAdminTab === 'usermgmt' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">👥 User Management</h2>
                        
                        <div style="background: #e6f7ff; border: 2px solid #4299e1; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <strong>✨ One-Step User Creation</strong><br>
                            Create users instantly! They can login immediately with the email and password you set.
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0;">
                            <h3>Create New User</h3>
                            
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="newUserEmail" placeholder="user@example.com" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Password * (minimum 6 characters)</label>
                                <input type="password" id="newUserPassword" placeholder="••••••••" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="newUserUsername" placeholder="johndoe" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="newUserFullName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Role *</label>
                                <select id="newUserRole" onchange="toggleDepartmentField()" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                                    <option value="technician">Technician</option>
                                    <option value="manager">Manager</option>
                                    <option value="administrator">Administrator</option>
                                    ${currentUser && currentUser.role === 'superadmin' ? '<option value="superadmin">Super Admin</option>' : ''}
                                </select>
                            </div>
                            
                            <div class="form-group" id="locationFieldGroup">
                                <label>Location *</label>
                                <select id="newUserLocation" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
                                    ${userLocations.map(loc => `
                                        <option value="${loc.id}" ${loc.id === currentLocationId ? 'selected' : ''}>${loc.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group" id="departmentFieldGroup">
                                <label>Department (for technicians)</label>
                                <select id="newUserDepartment" style="width:100%;padding:9px;border:2px solid #cbd5e0;border-radius:4px;font-size:14px;">
                                    <option value="">— None (non-technician) —</option>
                                    ${STEPS.filter(s => s !== 'Finished').map(s => '<option value="' + s + '">' + s + '</option>').join('')}
                                </select>
                            </div>
                            
                            <button class="btn" onclick="createNewUser(event)" style="background: #48bb78; width: 100%;">
                                ✅ Create User
                            </button>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>Existing Users</h3>
                            <div id="userManagementList" style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0;">
                                Loading users...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'import' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">📋 Import Vehicles from Excel</h2>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin-bottom: 10px; font-size: 14px;">
                                Upload a CSV file with columns: VIN, Stock Number, Year, Make, Model, Miles, Appraisal Notes, Skip Steps
                            </p>
                            <p style="margin-bottom: 10px; font-size: 13px; color: #718096;">
                                <strong>Note:</strong> New vehicles are added · Existing stock numbers get year/make/model/miles updated (VIN &amp; stock are never changed)
                            </p>
                            <input type="file" id="excelImport" accept=".csv" 
                                   onchange="handleExcelImport(event)"
                                   style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px;">
                            <button class="btn" onclick="downloadImportTemplate()" 
                                    style="margin-top: 10px; background: #4299e1;">
                                📥 Download Template
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2 class="section-title">Add New Vehicle</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>VIN Number</label>
                                <input type="text" id="newVIN" placeholder="Enter VIN">
                            </div>
                            <div class="form-group">
                                <label>Stock Number</label>
                                <input type="text" id="newStockNumber" placeholder="Enter Stock #">
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <input type="text" id="newYear" placeholder="2024">
                            </div>
                            <div class="form-group">
                                <label>Make</label>
                                <input type="text" id="newMake" placeholder="Toyota">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" id="newModel" placeholder="Camry">
                            </div>
                            <div class="form-group">
                                <label>Miles</label>
                                <input type="number" id="newMiles" placeholder="25000">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Skip Steps (Optional)</label>
                                <select id="skipSteps" multiple style="height: 80px;">
                                    ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => 
                                        `<option value="${step}">${step}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <button class="btn" onclick="addNewVehicle()">Add Vehicle</button>
                    </div>
                </div>

                </div>

                <div class="admin-content ${currentAdminTab === 'steps' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🔧 Step Management</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Add New Step</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group">
                                    <label>Step Name</label>
                                    <input type="text" id="newStepName" placeholder="Paint Correction">
                                </div>
                                <div class="form-group">
                                    <label>Insert Before</label>
                                    <select id="insertBeforeStep">
                                        ${STEPS.map(step => 
                                            `<option value="${step}">${step}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="addStep()">➕ Add Step</button>
                        </div>
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Current Steps (In Order)</h3>
                        <p style="font-size: 13px; color: #718096; margin-bottom: 15px;">
                            Click the ▶ arrow to expand a step and manage its substeps
                        </p>
                        <div style="background: white; border-radius: 6px; overflow: hidden;">
                            ${STEPS.map((step, index) => {
                                const isExpanded = expandedSteps.has(step);
                                const hasSubsteps = substeps[step] && substeps[step].length > 0;
                                
                                return `
                                    <div style="border-bottom: 1px solid #e2e8f0;">
                                        <div style="display: grid; grid-template-columns: 40px 1fr 80px 80px 200px; gap: 10px; padding: 12px; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                ${hasSubsteps || true ? `
                                                    <button class="expand-btn ${isExpanded ? 'expanded' : ''}" 
                                                            onclick="toggleStepExpansion('${step}')" 
                                                            title="Show/hide substeps">
                                                        ▶
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div>
                                                <strong style="font-size: 14px;">${index + 1}. </strong>
                                                <span class="step-name-editable" onclick="editStepName('${step}')" title="Click to rename">
                                                    ${step}
                                                </span>
                                                ${hasSubsteps ? `<span class="substep-badge">${substeps[step].length} substeps</span>` : ''}
                                            </div>
                                            <div style="font-size: 13px;">${stepThresholds[step] || 0}h</div>
                                            <div style="font-size: 13px;">${(technicians[step] || []).length} techs</div>
                                            <div style="display: flex; gap: 4px;">
                                                <button class="btn" onclick="moveStepUp('${step}')" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        ${index === 0 ? 'disabled' : ''}>
                                                    ↑
                                                </button>
                                                <button class="btn" onclick="moveStepDown('${step}')" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        ${index >= STEPS.length - 1 ? 'disabled' : ''}>
                                                    ↓
                                                </button>
                                                <button class="btn" onclick="removeStep('${step}')" 
                                                        style="background: #e53e3e; padding: 4px 8px; font-size: 11px;">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                        
                                        ${isExpanded ? `
                                            <div class="substep-container">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                    <h4 style="font-size: 14px; margin: 0;">Substeps for ${step}</h4>
                                                    <button class="btn" onclick="addSubstep('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                                        ➕ Add Substep
                                                    </button>
                                                </div>
                                                
                                                ${hasSubsteps ? substeps[step].map((substep, subIndex) => `
                                                    <div class="substep-item">
                                                        <div style="display: flex; align-items: center; gap: 8px;">
                                                            <span style="color: #718096; font-weight: bold;">${subIndex + 1}.</span>
                                                            <span class="step-name-editable" onclick="editSubstepName('${step}', '${substep}')" title="Click to rename">
                                                                ${substep}
                                                            </span>
                                                        </div>
                                                        <div style="display: flex; gap: 4px;">
                                                            <button class="btn" onclick="moveSubstepUp('${step}', '${substep}')" 
                                                                    style="padding: 3px 6px; font-size: 11px;"
                                                                    ${subIndex === 0 ? 'disabled' : ''}>
                                                                ↑
                                                            </button>
                                                            <button class="btn" onclick="moveSubstepDown('${step}', '${substep}')" 
                                                                    style="padding: 3px 6px; font-size: 11px;"
                                                                    ${subIndex >= substeps[step].length - 1 ? 'disabled' : ''}>
                                                                ↓
                                                            </button>
                                                            <button onclick="removeSubstep('${step}', '${substep}')" 
                                                                    style="background: #e53e3e; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                                ✕
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('') : `
                                                    <div style="padding: 20px; text-align: center; color: #a0aec0; font-size: 13px;">
                                                        No substeps yet. Click "Add Substep" to create one.
                                                    </div>
                                                `}
                                                
                                                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                        <h4 style="font-size: 14px; margin: 0;">Required Steps (Dependencies)</h4>
                                                        <button class="btn" onclick="addStepDependency('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                                            ➕ Add Requirement
                                                        </button>
                                                    </div>
                                                    
                                                    ${stepDependencies[step] && stepDependencies[step].length > 0 ? `
                                                        <div style="background: #fff5f5; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                                            <strong style="font-size: 12px; color: #c53030;">⚠️ ${step} requires these steps to be completed first:</strong>
                                                        </div>
                                                        ${stepDependencies[step].map(dep => `
                                                            <div class="substep-item">
                                                                <div style="font-size: 13px;">
                                                                    <strong>${dep}</strong> must be completed first
                                                                </div>
                                                                <button onclick="removeStepDependency('${step}', '${dep}')" 
                                                                        style="background: #e53e3e; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        `).join('')}
                                                    ` : `
                                                        <div style="padding: 15px; text-align: center; color: #a0aec0; font-size: 13px;">
                                                            No requirements. This step can be started at any time.
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'techs' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">👨‍🔧 Technician Management</h2>
                        ${STEPS.filter(s => s !== 'Finished').map(step => `
                            <div style="margin-bottom: 15px; padding: 15px; background: #f7fafc; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong>${step}</strong>
                                    <button class="btn" onclick="addTechnicianToStep('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                        ➕ Add Tech
                                    </button>
                                </div>
                                ${(technicians[step] && technicians[step].length > 0) ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${technicians[step].map(tech => `
                                            <div style="background: white; padding: 6px 10px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                                <span>${tech}</span>
                                                <button onclick="removeTechnicianFromStep('${step}', '${tech}')" 
                                                        style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 11px;">
                                                    ✕
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<small style="color: #718096;">No technicians assigned</small>'}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'tags' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🏷️ Tag Management</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Create New Tag</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div class="form-group">
                                    <label>Tag Name</label>
                                    <input type="text" id="newTagName" placeholder="Rush Order">
                                </div>
                                <div class="form-group">
                                    <label>Tag Type</label>
                                    <select id="newTagType" onchange="document.getElementById('skipStepField').style.display = this.value === 'skip' ? 'block' : 'none'">
                                        <option value="special">Special (Visual Only)</option>
                                        <option value="skip">Skip Step</option>
                                        <option value="priority">Priority</option>
                                    </select>
                                </div>
                                <div class="form-group" id="skipStepField" style="display: none;">
                                    <label>Skip Which Step?</label>
                                    <select id="tagSkipStep">
                                        ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => 
                                            `<option value="${step}">${step}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="createNewTag()">➕ Create Tag</button>
                        </div>
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Existing Tags</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            ${Object.entries(tagDefinitions).map(([name, def]) => `
                                <div style="background: #f7fafc; padding: 12px; border-radius: 4px; border-left: 4px solid ${def.color};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <strong style="font-size: 14px;">${name}</strong>
                                        <button onclick="deleteTag('${name}')" 
                                                style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 11px;">
                                            ✕
                                        </button>
                                    </div>
                                    <div style="font-size: 12px; color: #718096;">
                                        ${def.skipsStep ? `Skips: ${def.skipsStep}` : ''}
                                        ${def.priority ? 'Priority Flag' : ''}
                                        ${def.special && !def.priority ? 'Special Tag' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'workflows' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🔄 Workflow Management</h2>
                        <p style="margin-bottom: 15px; color: #718096; font-size: 14px;">
                            Workflows define which steps a vehicle goes through. Click steps in the order you want them. The number shows the order.
                        </p>
                        <div style="background:#edf2f7;border-radius:6px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#4a5568;display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
                            <span>🔌 Supabase: <strong>${USE_SUPABASE && supabaseClient ? '✅ Connected' : '❌ Not connected'}</strong></span>
                            <span>📍 Location ID: <strong>${currentLocationId || '⚠️ None — log in first'}</strong></span>
                            <button onclick="testWorkflowDB()" style="background:#4299e1;color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-size:12px;font-weight:bold;">🧪 Test DB Write</button>
                        </div>
                        
                        ${Object.entries(workflows).map(([id, workflow]) => `
                            <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-left: 4px solid ${workflow.color}; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 18px; margin: 0; margin-bottom: 5px;">${workflow.name}</h3>
                                        <span style="font-size: 13px; color: #718096;">${workflow.steps.length} steps configured</span>
                                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                                            <button class="btn" onclick="editWorkflowName('${id}')" style="background: #4299e1; padding: 4px 10px; font-size: 11px;">
                                                ✏️ Edit Name
                                            </button>
                                            <button class="btn" onclick="editWorkflowColor('${id}')" style="background: ${workflow.color}; color: white; padding: 4px 10px; font-size: 11px;">
                                                🎨 Edit Color
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn" onclick="deleteWorkflow('${id}')" style="background: #e53e3e; padding: 6px 12px; font-size: 12px;">
                                        Delete Workflow
                                    </button>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 4px;">
                                    <strong style="font-size: 14px; display: block; margin-bottom: 10px;">Click Steps to Add (in order):</strong>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;" id="workflow_steps_${id}">
                                        ${STEPS.filter(s => s !== 'Finished').map(step => {
                                            const stepIndex = workflow.steps.indexOf(step);
                                            const isIncluded = stepIndex > -1;
                                            return `
                                                <button onclick="clickWorkflowStep('${id}', '${step}')" 
                                                        id="step_btn_${id}_${step.replace(/\s/g, '_')}"
                                                        style="position: relative; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: ${isIncluded ? '#e6ffed' : 'white'}; border: 2px solid ${isIncluded ? '#48bb78' : '#e2e8f0'}; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; font-weight: ${isIncluded ? 'bold' : 'normal'};">
                                                    ${isIncluded ? `<span style="position: absolute; top: 2px; right: 2px; background: #48bb78; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${stepIndex + 1}</span>` : ''}
                                                    <span>${step}</span>
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                    
                                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                                        <button class="btn" onclick="saveWorkflowOrder('${id}')" style="flex: 1; background: #48bb78; padding: 10px; font-size: 13px;">
                                            💾 Save Step Order
                                        </button>
                                        <button class="btn" onclick="clearWorkflowSteps('${id}')" style="background: #e53e3e; padding: 10px; font-size: 13px;">
                                            🗑️ Clear All
                                        </button>
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding: 10px; background: #fffbeb; border-radius: 4px; font-size: 12px;">
                                        <strong>⚠️ Important:</strong> Click "Save Step Order" after making changes. "Finished" is automatically added as the final step.
                                    </div>
                                    
                                    <div style="margin-top: 10px; padding: 10px; background: #e6f2ff; border-radius: 4px; font-size: 12px;">
                                        <strong>📋 Current Step Order:</strong><br>
                                        ${workflow.steps.map((s, i) => `${i+1}. ${s}`).join(' → ') || 'No steps selected'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        
                        <button class="btn" onclick="createWorkflow()" style="width: 100%; padding: 12px; font-size: 14px;">
                            ➕ Create New Workflow
                        </button>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'settings' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">⚙️ Step Time Thresholds (Hours)</h2>
                        <div class="threshold-list">
                            ${STEPS.filter(s => s !== 'Finished').map(step => `
                                <div class="threshold-item">
                                    <span>${step}</span>
                                    <input type="number" 
                                           value="${stepThresholds[step]}" 
                                           style="width: 80px;" 
                                           onchange="updateThreshold('${step}', this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'data' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">💾 Data Management</h2>
                        
                        <div style="background: #fef5e7; border: 2px solid #f39c12; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; color: #7c2d12;">📁 File-Based Storage</h3>
                            <p style="margin-bottom: 10px; font-size: 14px;">
                                This system uses <strong>manual file-based storage</strong>. Your data is saved to actual files on your computer.
                            </p>
                            <ul style="margin-left: 20px; font-size: 14px; color: #744210;">
                                <li><strong>Important:</strong> You must manually save your work by clicking the "Save" button</li>
                                <li>Your save file will be downloaded to your Downloads folder</li>
                                <li>To continue working, load your save file using the "Load Data" button below</li>
                                <li>Keep your save file safe - it contains all your work!</li>
                            </ul>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #48bb78;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #22543d;">💾 Save Your Work</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Download current data as <strong>${SAVE_FILE_NAME}</strong>
                                </p>
                                <button class="btn" onclick="saveChanges()" style="width: 100%; background: #48bb78; font-size: 15px; padding: 12px;">
                                    💾 Save to File
                                </button>
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    File will be saved to your Downloads folder
                                </p>
                            </div>

                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #4299e1;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #2c5282;">📂 Load Your Work</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Load data from your saved file
                                </p>
                                <input type="file" id="loadDataFile" accept=".json" onchange="loadFromFile(event)" style="width: 100%; padding: 10px; border: 2px solid #4299e1; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    Select your ${SAVE_FILE_NAME} file
                                </p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h3 style="margin-bottom: 10px; font-size: 16px;">📥 Create Backup</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Create a dated backup file (recommended daily)
                                </p>
                                <button class="btn" onclick="exportData()" style="width: 100%; background: #4299e1;">
                                    Create Backup
                                </button>
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    Creates: recon-backup-YYYY-MM-DD.json
                                </p>
                            </div>

                            <div style="background: #fff5f5; padding: 20px; border-radius: 8px; border: 2px solid #fc8181;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #c53030;">⚠️ Reset to Sample Data</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #742a2a;">
                                    Start fresh with sample vehicles
                                </p>
                                <button class="btn" onclick="clearAllData()" style="width: 100%; background: #e53e3e;">
                                    Reset to Sample Data
                                </button>
                            </div>
                        </div>

                        <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; color: #234e52;">💡 Best Practices</h3>
                            <ul style="margin-left: 20px; font-size: 13px; color: #2c7a7b;">
                                <li><strong>Save often:</strong> Click "Save to File" whenever you make important changes</li>
                                <li><strong>Keep your file safe:</strong> Store ${SAVE_FILE_NAME} in a safe location</li>
                                <li><strong>Create backups:</strong> Use "Create Backup" to make dated backup files</li>
                                <li><strong>Load your file:</strong> When you open the system, load your save file first</li>
                                <li><strong>Multiple saves:</strong> You can keep multiple backup files with different dates</li>
                            </ul>
                        </div>

                        <div style="background: #fffbeb; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px;">
                            <h3 style="margin-bottom: 10px; color: #7c2d12;">📋 File Storage Information</h3>
                            <ul style="margin-left: 20px; font-size: 13px; color: #744210;">
                                <li><strong>File Name:</strong> ${SAVE_FILE_NAME}</li>
                                <li><strong>File Type:</strong> JSON (JavaScript Object Notation)</li>
                                <li><strong>Storage Location:</strong> Your computer (Downloads folder by default)</li>
                                <li><strong>What's Saved:</strong> All vehicles, technicians, steps, workflows, tags, and settings</li>
                                <li><strong>Persistence:</strong> Your file remains even if you close the browser</li>
                                <li><strong>Portability:</strong> You can copy your save file to another computer</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'report' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">📊 All Vehicles Report</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>VIN</th>
                                    <th>Stock #</th>
                                    <th>Current Step</th>
                                    <th>Time in Step</th>
                                    <th>Total Time</th>
                                    <th>Assigned Tech</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vehicles.sort((a, b) => a.entryTime - b.entryTime).map(v => `
                                    <tr style="${isOverdue(v) ? 'background: #fff5f5;' : ''}">
                                        <td>${v.vin}</td>
                                        <td>${v.stockNumber || 'N/A'}</td>
                                        <td>${v.currentStep}</td>
                                        <td>${formatTimeDiff(v.stepStartTime)}</td>
                                        <td>${formatTimeDiff(v.entryTime)}</td>
                                        <td>${v.assignedTech || 'Unassigned'}</td>
                                        <td>${isOverdue(v) && v.currentStep !== 'Finished' ? '⚠️ Overdue' : '✓ On Track'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Locations Tab (superadmin only) -->
                ${currentUser && currentUser.role === 'superadmin' ? `
                <div class="admin-content ${currentAdminTab === 'locations' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🏢 Location Management</h2>

                        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 24px;">
                            <h3 style="margin-bottom: 16px;">➕ Create New Location</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label>Location Name *</label>
                                    <input type="text" id="locMgmtName" placeholder="Miami Store" style="width:100%;padding:8px;border:2px solid #cbd5e0;border-radius:4px;">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="locMgmtAddress" placeholder="123 Main St" style="width:100%;padding:8px;border:2px solid #cbd5e0;border-radius:4px;">
                                </div>
                                <div class="form-group">
                                    <label>City *</label>
                                    <input type="text" id="locMgmtCity" placeholder="Miami" style="width:100%;padding:8px;border:2px solid #cbd5e0;border-radius:4px;">
                                </div>
                                <div class="form-group">
                                    <label>State * (2 letters)</label>
                                    <input type="text" id="locMgmtState" placeholder="FL" maxlength="2" style="width:100%;padding:8px;border:2px solid #cbd5e0;border-radius:4px;text-transform:uppercase;">
                                </div>
                            </div>
                            <button class="btn" onclick="createLocationFromTab()" style="background:#48bb78;margin-top:12px;width:100%;">
                                ✅ Create Location
                            </button>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                <h3 style="margin:0;">Existing Locations</h3>
                                <button class="btn" onclick="refreshLocationsList()" style="background:#4299e1;padding:6px 14px;font-size:13px;">🔄 Refresh</button>
                            </div>
                            <div id="locMgmtList">Loading locations...</div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        function renderReporting() {
            // Calculate bottlenecks
            const avgTimeByStep = {};
            STEPS.forEach(step => {
                const vehiclesInStep = vehicles.filter(v => v.completedSteps && v.completedSteps.includes(step));
                if (vehiclesInStep.length > 0) {
                    // Simplified - in real system would track actual times
                    avgTimeByStep[step] = Math.random() * 3 + 0.5;
                }
            });

            const bottleneck = Object.entries(avgTimeByStep)
                .sort((a, b) => b[1] - a[1])[0];

            return `
                <div class="admin-section">
                    <h2 class="section-title">📊 Daily Performance Report</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${vehicles.filter(v => v.currentStep === 'Finished').length}</div>
                            <div class="stat-label">Vehicles Completed Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicles.filter(v => isOverdue(v)).length}</div>
                            <div class="stat-label">Currently Overdue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${bottleneck ? bottleneck[0] : 'N/A'}</div>
                            <div class="stat-label">Biggest Bottleneck</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(Math.random() * 24 + 12).toFixed(1)}h</div>
                            <div class="stat-label">Avg Time Through System</div>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h2 class="section-title">Average Time by Step</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Avg Time (hours)</th>
                                <th>Current Queue</th>
                                <th>Threshold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${STEPS.filter(s => s !== 'Finished').map(step => {
                                const queueLength = vehicles.filter(v => v.currentStep === step).length;
                                const avgTime = avgTimeByStep[step] || 0;
                                const threshold = stepThresholds[step];
                                const status = avgTime > threshold ? '⚠️ Over Threshold' : '✓ Normal';
                                return `
                                    <tr style="${avgTime > threshold ? 'background: #fff5f5;' : ''}">
                                        <td>${step}</td>
                                        <td>${avgTime.toFixed(1)}</td>
                                        <td>${queueLength}</td>
                                        <td>${threshold}h</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="admin-section">
                    <h2 class="section-title">Technician Productivity</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Technician</th>
                                <th>Department</th>
                                <th>Completed Today</th>
                                <th>Avg Time per Job</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(technicians || {}).filter(([,techs]) => Array.isArray(techs)).flatMap(([step, techs]) => 
                                techs.map(tech => `
                                    <tr>
                                        <td>${tech}</td>
                                        <td>${step}</td>
                                        <td>${Math.floor(Math.random() * 8 + 2)}</td>
                                        <td>${(Math.random() * 2 + 0.5).toFixed(1)}h</td>
                                    </tr>
                                `)
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ============================================
        // SUPABASE DATA LOADING FUNCTIONS
        // ============================================
        
        async function loadUserProfileFromSupabase(userId) {
            if (!supabaseClient) return;
            
            try {
                // Load user profile
                const { data: profile, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (profileError) {
                    console.error('Profile load error:', profileError);
                    alert('Error loading profile: ' + profileError.message);
                    return;
                }
                
                console.log('👤 Profile loaded:', profile);
                
                // Set current user
                currentUser = {
                    id: profile.id,
                    username: profile.username,
                    role: profile.role,
                    name: profile.full_name,
                    department: profile.department
                };
                
                // Handle super admin (can see all locations)
                if (profile.role === 'superadmin') {
                    console.log('🌟 Super admin detected - loading all locations');
                    await loadAllLocationsForSuperAdmin();
                } else {
                    // Regular user - load their single location
                    const { data: location, error: locError } = await supabaseClient
                        .from('locations')
                        .select('*')
                        .eq('id', profile.location_id)
                        .single();
                    
                    if (location) {
                        userLocations = [location];
                        currentLocationId = location.id;
                        console.log('📍 Location loaded:', location.name);
                    }
                }
                
                // Load data for current location
                await loadDataFromSupabase();
                render();
                
            } catch (err) {
                console.error('Profile load exception:', err);
                render(); // render login on error
            }
        }
        
        async function loadAllLocationsForSuperAdmin() {
            console.log('🔍 Loading all locations for super admin...');
            const { data: locations, error } = await supabaseClient
                .from('locations')
                .select('*')
                .order('name');
            
            if (error) {
                console.error('❌ Error loading locations:', error);
                alert('Error loading locations: ' + error.message);
                return;
            }
            
            console.log('📍 Locations found:', locations);
            
            if (locations && locations.length > 0) {
                userLocations = locations;
                currentLocationId = locations[0].id; // Default to first location
                console.log(`✅ Loaded ${locations.length} locations`);
                console.log('📍 Default location:', locations[0].name);
            } else {
                console.warn('⚠️ No locations found in database!');
            }
        }
        
        async function loadDataFromSupabase() {
            if (!supabaseClient || !currentLocationId) {
                console.log('⚠️ Skipping data load - no location selected');
                return;
            }
            
            console.log('📊 Loading data for location:', currentLocationId);
            
            try {
                // Load vehicles
                const { data: vehicleData, error: vError } = await supabaseClient
                    .from('vehicles')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (vehicleData) {
                    vehicles = vehicleData.map(v => ({
                        id: v.id,
                        vin: v.vin,
                        stockNumber: v.stock_number,
                        year: v.year,
                        make: v.make,
                        model: v.model,
                        miles: v.miles,
                        appraisalNotes: v.appraisal_notes,
                        currentStep: v.current_step,
                        workflow: v.workflow,
                        assignedTech: v.assigned_tech,
                        entryTime: new Date(v.entry_time),
                        stepStartTime: new Date(v.step_start_time),
                        completedSteps: v.completed_steps || [],
                        skippedSteps: v.skipped_steps || [],
                        tags: v.tags || [],
                        vehicleTags: v.vehicle_tags || [],
                        photos: v.photos || [],
                        stepHistory: v.step_history || [],
                        noteHistory: []
                    }));
                    
                    console.log(`✅ Loaded ${vehicles.length} vehicles`);
                }
                
                // Load workflows, technicians, step thresholds, tag definitions, and notes all in parallel
                const vehicleIds = vehicles.map(v => v.id);
                const [
                    { data: workflowData },
                    { data: techData,        error: techErr },
                    { data: profileTechData, error: profileTechErr },
                    { data: thresholdData },
                    { data: tagData },
                    { data: allNotes }
                ] = await Promise.all([
                    supabaseClient.from('workflows').select('*').eq('location_id', currentLocationId),
                    supabaseClient.from('technicians').select('*').eq('location_id', currentLocationId),
                    supabaseClient.from('user_profiles').select('full_name, department').eq('location_id', currentLocationId).eq('role', 'technician'),
                    supabaseClient.from('step_thresholds').select('*').eq('location_id', currentLocationId),
                    supabaseClient.from('tag_definitions').select('*').eq('location_id', currentLocationId),
                    vehicleIds.length > 0
                        ? supabaseClient.from('vehicle_notes').select('*').in('vehicle_id', vehicleIds).order('created_at', { ascending: false })
                        : Promise.resolve({ data: [] })
                ]);

                console.log('📋 techData:', JSON.stringify(techData), '| error:', techErr?.message);
                console.log('📋 profileTechData (ALL technician role users):', JSON.stringify(profileTechData), '| error:', profileTechErr?.message);
                console.log('📋 currentLocationId:', currentLocationId);
                
                if (workflowData) {
                    workflows = {};
                    workflowData.forEach(w => {
                        workflows[w.workflow_key] = {
                            name: w.name,
                            steps: w.steps || [],
                            color: w.color
                        };
                    });
                    console.log(`✅ Loaded ${workflowData.length} workflows`);
                }
                
                // Build technicians object from technicians table
                technicians = {};
                const addToTechnicians = (name, dept) => {
                    if (!name || !dept) return;
                    if (!technicians[dept]) technicians[dept] = [];
                    if (!technicians[dept].includes(name)) technicians[dept].push(name);
                };
                (techData || []).forEach(t => addToTechnicians(t.name, t.department));
                (profileTechData || []).forEach(t => addToTechnicians(t.full_name, t.department));

                // If technicians table is empty, sync from user_profiles automatically
                if ((techData || []).length === 0 && (profileTechData || []).length > 0) {
                    console.log('🔄 Syncing technicians from user_profiles to technicians table...');
                    const syncRows = profileTechData.map(t => ({
                        name: t.full_name,
                        department: t.department,
                        location_id: currentLocationId,
                        status: 'available'
                    }));
                    const { error: syncErr } = await supabaseClient
                        .from('technicians')
                        .upsert(syncRows, { onConflict: 'name,location_id' });
                    if (syncErr) console.warn('Sync warning:', syncErr.message);
                    else console.log('✅ Synced', syncRows.length, 'technicians to technicians table');
                }

                // If profileTechData was empty (RLS blocking it), fall back to direct SQL
                if ((profileTechData || []).length === 0 && (techData || []).length === 0) {
                    console.warn('⚠️ Both tech sources empty — RLS may be blocking user_profiles read.');
                    console.warn('Fix: Run this in Supabase SQL editor:');
                    console.warn('INSERT INTO technicians (name, department, location_id, status)');
                    console.warn('SELECT full_name, department, location_id, \'available\'');
                    console.warn('FROM user_profiles WHERE role = \'technician\'');
                    console.warn('ON CONFLICT DO NOTHING;');
                }

                console.log('✅ Technicians loaded:', Object.entries(technicians).map(([k,v]) => k + ': [' + v.join(', ') + ']').join(' | ') || '(none)');
                
                if (thresholdData) {
                    stepThresholds = {};
                    thresholdData.forEach(t => {
                        stepThresholds[t.step_name] = t.threshold_hours;
                    });
                    console.log(`✅ Loaded step thresholds`);
                }
                
                if (tagData) {
                    tagDefinitions = {};
                    tagData.forEach(t => {
                        tagDefinitions[t.tag_name] = {
                            color: t.color,
                            skipsStep: t.skips_step
                        };
                    });
                    console.log(`✅ Loaded ${tagData.length} tag definitions`);
                }
                
                // Assign notes to vehicles (single batched query instead of N+1)
                if (allNotes && allNotes.length > 0) {
                    const notesByVehicle = {};
                    for (const n of allNotes) {
                        if (!notesByVehicle[n.vehicle_id]) notesByVehicle[n.vehicle_id] = [];
                        notesByVehicle[n.vehicle_id].push({
                            text: n.note_text,
                            timestamp: new Date(n.created_at),
                            user: n.username,
                            id: n.id
                        });
                    }
                    for (const vehicle of vehicles) {
                        vehicle.noteHistory = notesByVehicle[vehicle.id] || [];
                    }
                }
                
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }
        
        async function switchLocation(locationId) {
            if (!currentUser || currentUser.role !== 'superadmin') {
                alert('Only super admin can switch locations');
                return;
            }
            
            console.log('🔄 Switching to location:', locationId);
            currentLocationId = locationId;
            
            const selectedLocation = userLocations.find(l => l.id === locationId);
            console.log('📍 Now viewing:', selectedLocation?.name);
            
            await loadDataFromSupabase();
            render();

            // If user management tab is open, reload it for the new location
            if (currentAdminTab === 'usermgmt') {
                setTimeout(() => loadUserManagementList(), 150);
            }
        }
        
        function handleLocationSwitch(locationId) {
            console.log('🎯 Location dropdown changed to:', locationId);
            switchLocation(locationId).catch(err => {
                console.error('❌ Error switching location:', err);
                alert('Error switching location: ' + err.message);
            });
        }
        
        // Event Handlers
        async function login() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Show spinner, disable form
            const btn = document.getElementById('loginBtn');
            const spinner = document.getElementById('loginSpinner');
            const spinnerMsg = document.getElementById('loginSpinnerMsg');
            const form = document.getElementById('loginForm');
            if (btn) btn.style.display = 'none';
            if (form) { form.querySelector('input[type=text]').disabled = true; form.querySelector('input[type=password]').disabled = true; }
            if (spinner) spinner.classList.add('active');

            function setMsg(msg) { if (spinnerMsg) spinnerMsg.textContent = msg; }
            function resetLogin(errMsg) {
                if (btn) btn.style.display = 'block';
                if (spinner) spinner.classList.remove('active');
                if (form) { form.querySelector('input[type=text]').disabled = false; form.querySelector('input[type=password]').disabled = false; }
                if (errMsg) alert(errMsg);
            }

            // Try Supabase first if configured
            if (USE_SUPABASE && supabaseClient) {
                try {
                    setMsg('Signing in…');
                    console.log('🔐 Attempting Supabase login...');
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) {
                        console.error('Auth error:', error);
                        resetLogin('Invalid credentials: ' + error.message);
                        return;
                    }
                    
                    console.log('✅ Auth successful');
                    
                    if (data.user) {
                        setMsg('Loading your profile…');
                        await loadUserProfileFromSupabase(data.user.id);
                        setMsg('Loading location data…');
                        currentView = currentUser.role === 'technician' ? 'technician' : 'dashboard';
                        resetInactivityTimer();
                        render();
                    }
                } catch (err) {
                    console.error('Login exception:', err);
                    resetLogin('Login error: ' + err.message);
                }
            } else {
                // Fallback to mock authentication
                const username = email;
                if (users[username] && users[username].password === password) {
                    setMsg('Loading…');
                    currentUser = {
                        username: username,
                        ...users[username]
                    };
                    currentView = currentUser.role === 'technician' ? 'technician' : 'dashboard';
                    resetInactivityTimer();
                    render();
                } else {
                    alert('Invalid credentials');
                }
            }
        }

        function openAwaitingModal() {
            const awaitingVehicles = vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING');
            const modalHTML = `
                <div id="awaitingModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="if(event.target===this)closeAwaitingModal()">
                    <div style="background:white;border-radius:10px;padding:24px;max-width:960px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:2px solid #f39c12;padding-bottom:12px;">
                            <h2 style="margin:0;color:#7c2d12;font-size:20px;">&#9203; Awaiting Arrival (${awaitingVehicles.length})</h2>
                            <button onclick="closeAwaitingModal()" style="background:#e53e3e;color:white;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:14px;font-weight:bold;">✕ Close</button>
                        </div>

                        <!-- BULK ASSIGN ALL PANEL -->
                        ${awaitingVehicles.length > 0 ? `
                        <div style="background:linear-gradient(135deg,#1a365d,#2b6cb0);border-radius:10px;padding:18px;margin-bottom:20px;color:white;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                                <span style="font-size:22px;">🤖</span>
                                <div>
                                    <div style="font-size:15px;font-weight:bold;">Assign All to Workflow</div>
                                    <div style="font-size:12px;opacity:0.85;">AI round-robin will distribute techs fairly across all ${awaitingVehicles.length} vehicle${awaitingVehicles.length > 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                                <select id="bulkWorkflowSelect" style="flex:1;min-width:200px;padding:10px;font-size:14px;border:2px solid rgba(255,255,255,0.4);border-radius:6px;background:rgba(255,255,255,0.15);color:white;">
                                    <option value="" style="color:#2d3748;">-- Select Workflow for All --</option>
                                    ${Object.entries(workflows).map(([id, wf]) => `<option value="${id}" style="color:#2d3748;">${wf.name}</option>`).join('')}
                                </select>
                                <button onclick="assignAllAwaitingToWorkflow(document.getElementById('bulkWorkflowSelect').value)"
                                    style="padding:10px 22px;background:#f6e05e;color:#1a365d;border:none;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer;white-space:nowrap;">
                                    ⚡ Assign All Now
                                </button>
                            </div>
                            <div id="bulkAssignProgress" style="display:none;margin-top:10px;font-size:13px;padding:8px;background:rgba(255,255,255,0.2);border-radius:4px;text-align:center;"></div>
                        </div>
                        ` : ''}

                        <!-- INDIVIDUAL CARDS -->
                        ${awaitingVehicles.length > 0 ? `
                        <div style="font-size:12px;color:#718096;margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;">Or assign individually:</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:15px;">
                            ${awaitingVehicles.map(vehicle => `
                                <div style="background:#fffbeb;padding:15px;border-radius:8px;border:2px solid #f39c12;">
                                    <div style="font-size:14px;font-weight:bold;margin-bottom:6px;color:#2d3748;cursor:pointer;" onclick="closeAwaitingModal();showVehicleDetails('${vehicle.vin}')">
                                        ${vehicle.year || ''} ${vehicle.make || ''} ${vehicle.model || ''}
                                    </div>
                                    <div style="font-size:12px;color:#718096;margin-bottom:10px;">
                                        <div><strong>Stock:</strong> ${vehicle.stockNumber || 'N/A'}</div>
                                        <div><strong>VIN:</strong> ${vehicle.vin}</div>
                                        <div><strong>Miles:</strong> ${vehicle.miles?.toLocaleString() || 'N/A'}</div>
                                    </div>
                                    <label style="display:block;margin-bottom:4px;font-size:11px;font-weight:bold;color:#4a5568;">Assign Workflow:</label>
                                    <select id="awmodal_workflow_${vehicle.vin}" style="width:100%;padding:7px;font-size:12px;border:2px solid #cbd5e0;border-radius:4px;margin-bottom:8px;">
                                        <option value="">-- Select Workflow --</option>
                                        ${Object.entries(workflows).map(([id, wf]) => `<option value="${id}">${wf.name}</option>`).join('')}
                                    </select>
                                    <button onclick="assignWorkflowFromModal('${vehicle.vin}')" style="width:100%;background:#48bb78;color:white;border:none;border-radius:6px;padding:9px;font-size:13px;font-weight:bold;cursor:pointer;">
                                        ✅ Assign &amp; Start Recon
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        ` : `<div style="text-align:center;padding:40px;color:#718096;"><div style="font-size:48px;margin-bottom:12px;">✅</div><div style="font-size:18px;font-weight:bold;">No vehicles awaiting!</div><div style="font-size:14px;margin-top:8px;">All vehicles have been assigned to workflows.</div></div>`}

                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAwaitingModal() {
            const modal = document.getElementById('awaitingModal');
            if (modal) modal.remove();
        }

        function assignWorkflowFromModal(vin) {
            const select = document.getElementById('awmodal_workflow_' + vin);
            if (!select || !select.value) {
                alert('Please select a workflow first');
                return;
            }
            const tempId = 'workflow_' + vin;
            const existing = document.getElementById(tempId);
            if (!existing) {
                const temp = document.createElement('select');
                temp.id = tempId;
                const opt = document.createElement('option');
                opt.value = select.value;
                opt.selected = true;
                temp.appendChild(opt);
                document.body.appendChild(temp);
                assignWorkflowToVehicle(vin).then(() => temp.remove());
            } else {
                existing.value = select.value;
                assignWorkflowToVehicle(vin);
            }
            closeAwaitingModal();
        }

        async function logout() {
            if (USE_SUPABASE && supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentUser = null;
            userLocations = [];
            currentLocationId = null;
            currentView = 'dashboard';
            stopInactivityTimer();
            render();
        }

        // ==================== SESSION TIMEOUT & BROWSER CLOSE ====================

        const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes of inactivity
        let inactivityTimer = null;
        let sessionWarningTimer = null;
        let sessionWarningShown = false;

        function resetInactivityTimer() {
            if (!currentUser) return; // Only track when logged in
            clearTimeout(inactivityTimer);
            clearTimeout(sessionWarningTimer);
            if (sessionWarningShown) {
                const warn = document.getElementById('sessionWarningBanner');
                if (warn) warn.remove();
                sessionWarningShown = false;
            }
            // Warn 2 minutes before timeout
            sessionWarningTimer = setTimeout(showSessionWarning, SESSION_TIMEOUT_MS - 2 * 60 * 1000);
            // Force logout after full timeout
            inactivityTimer = setTimeout(() => {
                alert('⏱️ Your session has expired due to inactivity. Please log in again.');
                logout();
            }, SESSION_TIMEOUT_MS);
        }

        function stopInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(sessionWarningTimer);
            inactivityTimer = null;
            sessionWarningTimer = null;
            const warn = document.getElementById('sessionWarningBanner');
            if (warn) warn.remove();
            sessionWarningShown = false;
        }

        function showSessionWarning() {
            if (!currentUser || sessionWarningShown) return;
            sessionWarningShown = true;
            const banner = document.createElement('div');
            banner.id = 'sessionWarningBanner';
            banner.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#e53e3e;color:white;padding:14px 24px;border-radius:8px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:14px;font-size:14px;font-weight:600;max-width:460px;width:90%;';
            banner.innerHTML = '⚠️ Your session will expire in 2 minutes due to inactivity.'
                + '<button onclick="resetInactivityTimer()" style="background:white;color:#e53e3e;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-weight:bold;white-space:nowrap;flex-shrink:0;">Stay Logged In</button>';
            document.body.appendChild(banner);
        }

        // Track user activity to reset the timer
        ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll', 'click'].forEach(evt =>
            document.addEventListener(evt, () => { if (currentUser) resetInactivityTimer(); }, { passive: true })
        );

        // Sign out when browser tab/window is closed or navigated away
        // Uses sessionStorage to distinguish tab close vs page refresh
        window.addEventListener('beforeunload', () => {
            // Mark that we're leaving the page
            sessionStorage.setItem('recon_tab_leaving', '1');
        });

        // On page load, check if we left abruptly (not a refresh)
        // We use a "ping" key: refreshes restore it quickly, true closes do not
        (function checkTabClose() {
            const wasLeaving = sessionStorage.getItem('recon_tab_leaving');
            sessionStorage.removeItem('recon_tab_leaving');
            // If the user closed & reopened (new session), sign them out of Supabase
            // so they must log in again. The init() function handles showing the login screen.
            // This is handled naturally because sessionStorage is cleared on tab close.
        })();

        // Logout when the tab becomes hidden long-term (optional aggressive mode — disabled by default)
        // Uncomment the block below to also log out when the tab is hidden for > 60 minutes:
        /*
        let hiddenSince = null;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                hiddenSince = Date.now();
            } else {
                if (hiddenSince && (Date.now() - hiddenSince) > 60 * 60 * 1000) {
                    alert('🔒 You were away too long. Please log in again.');
                    logout();
                }
                hiddenSince = null;
            }
        });
        */

        // ==================== END SESSION TIMEOUT ====================

        function switchView(view) {
            currentView = view;
            selectedStepFilter = 'all'; // Reset filter when switching views
            render();
        }

        function filterByStep(step) {
            selectedStepFilter = step;
            selectedStatFilter = 'all';
            selectedTechFilter = 'all';
            render();
        }

        function filterByTech(tech) {
            selectedTechFilter = selectedTechFilter === tech ? 'all' : tech;
            render();
        }

        function filterByStat(stat) {
            selectedStatFilter = stat;
            selectedStepFilter = 'all';
            selectedTechFilter = 'all';
            render();
        }

        function getVehiclesByStat(stat) {
            switch(stat) {
                case 'total':
                    return vehicles;
                case 'awaiting':
                    return vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING');
                case 'inProgress':
                    return vehicles.filter(v => v.currentStep !== 'Finished' && v.workflow && v.workflow !== 'AWAITING');
                case 'completed':
                    return vehicles.filter(v => v.currentStep === 'Finished');
                case 'overdue':
                    return vehicles.filter(v => isOverdue(v) && v.currentStep !== 'Finished');
                case 'suggested':
                    return vehicles.filter(v => {
                        if (v.currentStep === 'Finished') return false;
                        if (!v.workflow || v.workflow === 'AWAITING') return false;
                        const suggestedStep = getSuggestedAlternateStep(v);
                        const availableTech = getAvailableTechnician(v.currentStep);
                        return suggestedStep !== null || (availableTech && availableTech !== v.assignedTech);
                    });
                default:
                    return vehicles;
            }
        }

        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const name = document.getElementById('newUserFullName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const department = document.getElementById('newUserDepartment').value;

            if (!username || !password || !name) {
                alert('Please fill in all required fields');
                return;
            }

            if (users[username]) {
                alert('Username already exists');
                return;
            }

            users[username] = {
                password: password,
                role: role,
                name: name,
                department: role === 'technician' ? department : null
            };

            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserFullName').value = '';
            
            render();
            alert(`✓ User ${name} added successfully`);
        }

        function removeUser(username) {
            if (username === 'admin') {
                alert('Cannot remove admin user');
                return;
            }

            if (confirm(`Remove user ${users[username].name}?`)) {
                delete users[username];
                render();
                alert('✓ User removed');
            }
        }

        function addStep() {
            const stepName = document.getElementById('newStepName').value.trim();
            const insertBefore = document.getElementById('insertBeforeStep').value;

            if (!stepName) {
                alert('Please enter a step name');
                return;
            }

            if (STEPS.includes(stepName)) {
                alert('Step already exists');
                return;
            }

            // Find insertion point
            const insertIndex = STEPS.indexOf(insertBefore);
            STEPS.splice(insertIndex, 0, stepName);

            // Initialize step data
            stepThresholds[stepName] = 2;
            technicians[stepName] = [];

            document.getElementById('newStepName').value = '';
            
            render();
            alert(`✓ Step "${stepName}" added`);
        }

        function removeStep(step) {
            if (vehicles.some(v => v.currentStep === step)) {
                alert('Cannot remove step - vehicles are currently in this step');
                return;
            }

            if (confirm(`Remove step "${step}"?`)) {
                const index = STEPS.indexOf(step);
                STEPS.splice(index, 1);
                delete stepThresholds[step];
                delete technicians[step];
                
                render();
                alert(`✓ Step "${step}" removed`);
            }
        }

        function moveStepUp(step) {
            const index = STEPS.indexOf(step);
            if (index <= 0) return;
            
            [STEPS[index], STEPS[index - 1]] = [STEPS[index - 1], STEPS[index]];
            render();
        }

        function moveStepDown(step) {
            const index = STEPS.indexOf(step);
            if (index >= STEPS.length - 1) return;
            
            [STEPS[index], STEPS[index + 1]] = [STEPS[index + 1], STEPS[index]];
            render();
        }

        async function removeTechnicianFromStep(step, techName) {
            if (!technicians[step]) return;
            technicians[step] = technicians[step].filter(t => t !== techName);

            if (supabaseClient && currentLocationId) {
                await supabaseClient.from('technicians')
                    .delete()
                    .eq('location_id', currentLocationId)
                    .eq('department', step)
                    .eq('name', techName);
            }
            render();
        }

        async function addTechnicianToStep(step) {
            const techName = prompt(`Enter technician name for ${step}:`);
            if (!techName || !techName.trim()) return;
            const name = techName.trim();

            if (!technicians[step]) technicians[step] = [];
            if (technicians[step].includes(name)) {
                alert('Technician already assigned to this step');
                return;
            }

            technicians[step].push(name);

            // Save to Supabase
            if (supabaseClient && currentLocationId) {
                const { error } = await supabaseClient.from('technicians').insert({
                    name: name,
                    department: step,
                    location_id: currentLocationId,
                    status: 'available'
                });
                if (error) {
                    console.error('Failed to save tech to Supabase:', error.message);
                    alert('Saved locally but failed to save to server: ' + error.message);
                }
            }

            render();
            alert(`✓ ${name} added to ${step}`);
        }

        function switchAdminTab(tab) {
            currentAdminTab = tab;
            if (tab === 'dashboard') {
                setTimeout(() => loadManagementDashboard(), 100);
            } else if (tab === 'usermgmt') {
                setTimeout(() => loadUserManagementList(), 100);
            } else if (tab === 'locations') {
                setTimeout(() => refreshLocationsList(), 100);
            }
            render();
        }

        // ============================================
        // MANAGEMENT DASHBOARD FUNCTIONS
        // ============================================
        
        async function loadManagementDashboard() {
            if (!supabaseClient) return;
            
            try {
                // Load locations
                const { data: locations, error: locError } = await supabaseClient
                    .from('locations')
                    .select('*')
                    .order('name');
                
                // Load users with location info
                const { data: users, error: userError } = await supabaseClient
                    .from('user_profiles')
                    .select(`
                        *,
                        locations (name, city, state)
                    `)
                    .order('created_at', { ascending: false });
                
                if (locations) {
                    const totalLocsEl = document.getElementById('totalLocations');
                    if (totalLocsEl) totalLocsEl.textContent = locations.length;
                    
                    const filterSelect = document.getElementById('locationFilter');
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="all">All Locations</option>' +
                            locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
                    }
                    
                    renderLocationsTable(locations, users);
                }
                
                if (users) {
                    const totalUsersEl = document.getElementById('totalUsers');
                    const totalAdminsEl = document.getElementById('totalAdmins');
                    const totalSuperAdminsEl = document.getElementById('totalSuperAdmins');
                    
                    if (totalUsersEl) totalUsersEl.textContent = users.length;
                    if (totalAdminsEl) totalAdminsEl.textContent = users.filter(u => u.role === 'administrator').length;
                    if (totalSuperAdminsEl) totalSuperAdminsEl.textContent = users.filter(u => u.role === 'superadmin').length;
                    
                    renderUsersTable(users);
                }
                
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }
        
        function renderLocationsTable(locations, users) {
            const container = document.getElementById('locationsTable');
            if (!container) return;
            
            const html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Location Name</th>
                            <th style="text-align: left; padding: 12px; font-size: 13px;">City, State</th>
                            <th style="text-align: center; padding: 12px; font-size: 13px;">Users</th>
                            <th style="text-align: center; padding: 12px; font-size: 13px;">Admins</th>
                            <th style="text-align: center; padding: 12px; font-size: 13px;">Techs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${locations.map(loc => {
                            const locationUsers = users ? users.filter(u => u.location_id === loc.id) : [];
                            const admins = locationUsers.filter(u => u.role === 'administrator').length;
                            const techs = locationUsers.filter(u => u.role === 'technician').length;
                            
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0;">
                                    <td style="padding: 12px; font-weight: bold;">${loc.name}</td>
                                    <td style="padding: 12px;">${loc.city}, ${loc.state}</td>
                                    <td style="padding: 12px; text-align: center;">${locationUsers.length}</td>
                                    <td style="padding: 12px; text-align: center;">${admins}</td>
                                    <td style="padding: 12px; text-align: center;">${techs}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function renderUsersTable(users, filterLocationId = 'all') {
            const container = document.getElementById('usersTable');
            if (!container) return;
            
            const filtered = filterLocationId === 'all' 
                ? users 
                : users.filter(u => u.location_id === filterLocationId);
            
            const html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Username</th>
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Full Name</th>
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Role</th>
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Location</th>
                            <th style="text-align: left; padding: 12px; font-size: 13px;">Department</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.length > 0 ? filtered.map(u => `
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 12px;">${u.username}</td>
                                <td style="padding: 12px;">${u.full_name}</td>
                                <td style="padding: 12px;">
                                    <span style="padding: 4px 8px; background: ${
                                        u.role === 'superadmin' ? '#fce7f3' : 
                                        u.role === 'administrator' ? '#fef3c7' : 
                                        '#dbeafe'
                                    }; border-radius: 4px; font-size: 11px;">
                                        ${u.role}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${u.locations ? u.locations.name : '🌟 All Locations'}</td>
                                <td style="padding: 12px;">${u.department || '-'}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #718096;">No users found</td></tr>'}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        async function filterUsersByLocation(locationId) {
            const { data: users } = await supabaseClient
                .from('user_profiles')
                .select(`
                    *,
                    locations (name, city, state)
                `);
            
            renderUsersTable(users, locationId);
        }
        
        function showAddLocationForm() {
            const modal = document.getElementById('addLocationModal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeAddLocationModal() {
            const modal = document.getElementById('addLocationModal');
            if (modal) modal.style.display = 'none';
            document.getElementById('newLocationName').value = '';
            document.getElementById('newLocationAddress').value = '';
            document.getElementById('newLocationCity').value = '';
            document.getElementById('newLocationState').value = '';
        }
        

        // ============================================
        // LOCATION MANAGEMENT TAB FUNCTIONS
        // ============================================

        async function createLocationFromTab() {
            const name    = (document.getElementById('locMgmtName')?.value || '').trim();
            const address = (document.getElementById('locMgmtAddress')?.value || '').trim();
            const city    = (document.getElementById('locMgmtCity')?.value || '').trim();
            const state   = (document.getElementById('locMgmtState')?.value || '').trim().toUpperCase();

            if (!name || !city || !state) {
                alert('Please fill in Name, City, and State');
                return;
            }
            if (state.length !== 2) {
                alert('State must be 2 letters (e.g. FL)');
                return;
            }

            try {
                // Create the location record — no workflows, no steps seeded
                const { data, error } = await supabaseClient
                    .from('locations')
                    .insert({ name, address, city, state })
                    .select().single();

                if (error) throw new Error(error.message);

                // New location starts completely empty — no workflows or steps copied
                console.log(`✅ New blank location created: ${name} (id: ${data.id})`);

                alert(`✅ Location "${name}" created!\n\nThis location starts with no workflows or steps. Configure them in the Admin Panel after switching to this location.`);
                document.getElementById('locMgmtName').value = '';
                document.getElementById('locMgmtAddress').value = '';
                document.getElementById('locMgmtCity').value = '';
                document.getElementById('locMgmtState').value = '';

                // Refresh superadmin location list and the locations dropdown
                await refreshLocationsList();
                await loadAllLocationsForSuperAdmin();
            } catch (err) {
                alert('❌ Error creating location: ' + err.message);
            }
        }

        async function refreshLocationsList() {
            const container = document.getElementById('locMgmtList');
            if (!container) return;
            container.innerHTML = 'Loading...';

            try {
                const { data: locs, error } = await supabaseClient
                    .from('locations')
                    .select('*')
                    .order('name');

                if (error) throw new Error(error.message);

                if (!locs || locs.length === 0) {
                    container.innerHTML = '<p style="color:#718096;">No locations found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:2px solid #e2e8f0;background:#f7fafc;">
                                <th style="text-align:left;padding:10px;font-size:13px;">Name</th>
                                <th style="text-align:left;padding:10px;font-size:13px;">City, State</th>
                                <th style="text-align:left;padding:10px;font-size:13px;">Address</th>
                                <th style="text-align:left;padding:10px;font-size:13px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${locs.map(loc => `
                                <tr style="border-bottom:1px solid #e2e8f0;">
                                    <td style="padding:10px;font-weight:bold;">${loc.name}</td>
                                    <td style="padding:10px;">${loc.city}, ${loc.state}</td>
                                    <td style="padding:10px;color:#718096;">${loc.address || '-'}</td>
                                    <td style="padding:10px;">
                                        <button onclick="deleteLocation('${loc.id}', '${loc.name.replace(/'/g, "\'")}')"
                                            style="background:#e53e3e;color:white;border:none;border-radius:4px;padding:5px 12px;cursor:pointer;font-size:12px;">
                                            🗑 Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:#e53e3e;">❌ ' + err.message + '</p>';
            }
        }

        async function deleteLocation(locationId, locationName) {
            if (!confirm('⚠️ Delete location "' + locationName + '"?\n\nThis will NOT delete users or vehicles at this location — just the location record itself.')) return;

            try {
                const { error } = await supabaseClient
                    .from('locations')
                    .delete()
                    .eq('id', locationId);

                if (error) throw new Error(error.message);
                alert('✅ Location deleted.');
                await refreshLocationsList();
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        // ── Delete user ──

        // ============================================
        // EDIT USER FUNCTIONS
        // ============================================

        async function openEditUserModal(userId, username, fullName, role, locationId, department) {
            // Guard: only superadmins can edit superadmin accounts
            if (role === 'superadmin' && currentUser && currentUser.role !== 'superadmin') {
                alert('⛔ Only a Super Admin can edit another Super Admin account.');
                return;
            }

            // Load locations for the dropdown
            const { data: locations } = await supabaseClient.from('locations').select('id, name').order('name');

            const locOptions = (locations || []).map(l =>
                `<option value="${l.id}" ${l.id === locationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');

            const modalHTML = `
                <div id="editUserModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;">
                    <div style="background:white;border-radius:10px;padding:28px;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;font-size:18px;">✏️ Edit User — ${username}</h2>
                            <button onclick="closeEditUserModal()" style="background:#718096;color:white;border:none;border-radius:6px;padding:5px 12px;cursor:pointer;">✕</button>
                        </div>

                        <input type="hidden" id="editUserId" value="${userId}">
                        <input type="hidden" id="editUsername" value="${username}">

                        <div style="margin-bottom:14px;">
                            <label style="display:block;font-weight:600;margin-bottom:5px;font-size:13px;">Full Name</label>
                            <input type="text" id="editFullName" value="${fullName}" style="width:100%;padding:9px;border:2px solid #cbd5e0;border-radius:6px;font-size:14px;">
                        </div>

                        <div style="margin-bottom:14px;">
                            <label style="display:block;font-weight:600;margin-bottom:5px;font-size:13px;">Role</label>
                            <select id="editRole" onchange="document.getElementById('editLocationGroup').style.display = this.value === 'superadmin' ? 'none' : 'block'"
                                style="width:100%;padding:9px;border:2px solid #cbd5e0;border-radius:6px;font-size:14px;">
                                <option value="technician"   ${role === 'technician'   ? 'selected' : ''}>Technician</option>
                                <option value="manager"      ${role === 'manager'      ? 'selected' : ''}>Manager</option>
                                <option value="administrator"${role === 'administrator'? 'selected' : ''}>Administrator</option>
                                <option value="superadmin"   ${role === 'superadmin'   ? 'selected' : ''}>Super Admin</option>
                            </select>
                        </div>

                        <div id="editLocationGroup" style="margin-bottom:14px;${role === 'superadmin' ? 'display:none;' : ''}">
                            <label style="display:block;font-weight:600;margin-bottom:5px;font-size:13px;">📍 Location (Store)</label>
                            <select id="editLocation" style="width:100%;padding:9px;border:2px solid #4299e1;border-radius:6px;font-size:14px;border-width:2px;">
                                <option value="">— No Location —</option>
                                ${locOptions}
                            </select>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block;font-weight:600;margin-bottom:5px;font-size:13px;">Department <span style="font-weight:400;color:#718096;">(technicians only)</span></label>
                            <select id="editDepartment" style="width:100%;padding:9px;border:2px solid #cbd5e0;border-radius:6px;font-size:14px;">
                                <option value="" ${!department ? 'selected' : ''}>— None —</option>
                                ${STEPS.filter(s => s !== 'Finished').map(s =>
                                    '<option value="' + s + '" ' + (s === department ? 'selected' : '') + '>' + s + '</option>'
                                ).join('')}
                            </select>
                        </div>

                        <div style="display:flex;gap:10px;">
                            <button onclick="saveEditUser()" style="flex:1;background:#48bb78;color:white;border:none;border-radius:6px;padding:11px;font-size:14px;font-weight:bold;cursor:pointer;">
                                ✅ Save Changes
                            </button>
                            <button onclick="closeEditUserModal()" style="flex:1;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;padding:11px;font-size:14px;cursor:pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) modal.remove();
        }

        async function saveEditUser() {
            const userId     = document.getElementById('editUserId').value;
            const username   = document.getElementById('editUsername').value;
            const fullName   = document.getElementById('editFullName').value.trim();
            const role       = document.getElementById('editRole').value;
            const locationId = document.getElementById('editLocation')?.value || null;
            const department = document.getElementById('editDepartment').value.trim();

            if (!fullName) { alert('Full name is required'); return; }

            // Guard: only superadmins can assign or change the superadmin role
            if (role === 'superadmin' && currentUser && currentUser.role !== 'superadmin') {
                alert('⛔ Only a Super Admin can assign the Super Admin role.');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .rpc('update_user_profile', {
                        target_user_id: userId,
                        new_full_name:  fullName,
                        new_role:       role,
                        new_location_id: role === 'superadmin' ? null : (locationId || null),
                        new_department:  department || null
                    });

                if (error) throw new Error(error.message);

                alert('✅ User "' + username + '" updated!');
                closeEditUserModal();
                await loadUserManagementList();
            } catch (err) {
                alert('❌ Error saving changes: ' + err.message);
            }
        }

        async function deleteUser(userId, username, userRole) {
            // Guard: never delete a superadmin account
            if (userRole === 'superadmin') {
                alert('⛔ Super Admin accounts cannot be deleted.');
                return;
            }
            // Guard: never let someone delete themselves
            if (currentUser && userId === currentUser.id) {
                alert('⛔ You cannot delete your own account.');
                return;
            }
            // Guard: administrators cannot delete other administrators
            if (currentUser && currentUser.role === 'administrator' && userRole === 'administrator') {
                alert('⛔ Administrators cannot delete other administrator accounts.');
                return;
            }

            if (!confirm('⚠️ Delete user "' + username + '"?\n\nThis permanently removes them from the app AND Supabase Auth so their email can be reused.')) return;

            try {
                // Step 1: delete from user_profiles (via RPC to bypass RLS)
                const { error: profileErr } = await supabaseClient
                    .rpc('delete_user_profile', { target_user_id: userId });
                if (profileErr) throw new Error('Profile delete failed: ' + profileErr.message);

                // Step 2: delete from auth.users via admin RPC
                // Requires a SECURITY DEFINER function in Supabase — see note below
                const { error: authErr } = await supabaseClient
                    .rpc('delete_auth_user', { target_user_id: userId });

                if (authErr) {
                    // If the RPC doesn't exist yet, warn but don't block — profile is gone at least
                    console.warn('Auth delete warning:', authErr.message);
                    alert('✅ User "' + username + '" removed from app.\n\n⚠️ Could not delete from Supabase Auth: ' + authErr.message + '\n\nRun this SQL in Supabase to enable full deletion:\n\nCREATE OR REPLACE FUNCTION delete_auth_user(target_user_id uuid)\nRETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $\nBEGIN\n  DELETE FROM auth.users WHERE id = target_user_id;\nEND;\n$;');
                } else {
                    alert('✅ User "' + username + '" fully deleted — profile and auth account removed. Email can be reused.');
                }

                await loadUserManagementList();
            } catch (err) {
                alert('❌ Error deleting user: ' + err.message);
            }
        }

        async function saveNewLocation() {
            const name = document.getElementById('newLocationName').value.trim();
            const address = document.getElementById('newLocationAddress').value.trim();
            const city = document.getElementById('newLocationCity').value.trim();
            const state = document.getElementById('newLocationState').value.toUpperCase().trim();
            
            if (!name || !city || !state) {
                alert('Please fill in required fields (Name, City, State)');
                return;
            }
            
            try {
                // Create the location record — no workflows, no steps seeded
                const { data, error } = await supabaseClient
                    .from('locations')
                    .insert({ name, address, city, state })
                    .select()
                    .single();
                
                if (error) {
                    alert('Error creating location: ' + error.message);
                    return;
                }

                // New location starts completely empty — no workflows or steps copied
                console.log(`✅ New blank location created: ${name} (id: ${data.id})`);
                
                alert(`✅ Location "${name}" created!\n\nThis location starts with no workflows or steps. Configure them in the Admin Panel after switching to this location.`);
                closeAddLocationModal();
                await loadManagementDashboard();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================
        
        function downloadImportTemplate() {
            const headers = ['VIN', 'Stock Number', 'Year', 'Make', 'Model', 'Miles', 'Appraisal Notes', 'Skip Steps'];
            const example = ['1HGBH41JXMN109186', 'A12345', '2022', 'Honda', 'Accord', '35000', 'Trade-in good condition', ''];
            const csv = [headers.join(','), example.join(',')].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vehicle-import-template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleDepartmentField() {
            const role = document.getElementById('newUserRole').value;
            const deptField = document.getElementById('departmentFieldGroup');
            const locField = document.getElementById('locationFieldGroup');
            
            if (deptField) {
                if (role === 'technician') {
                    deptField.style.display = 'block';
                } else {
                    deptField.style.display = 'none';
                }
            }
            
            if (locField) {
                if (role === 'superadmin') {
                    locField.style.display = 'none';
                } else {
                    locField.style.display = 'block';
                }
            }
        }
        
        async function createNewUser(event) {
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const username = document.getElementById('newUserUsername').value.trim();
            const fullName = document.getElementById('newUserFullName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const locationId = role === 'superadmin' ? null : document.getElementById('newUserLocation').value;
            const department = role === 'technician' ? document.getElementById('newUserDepartment').value : null;
            
            // Validation
            if (!email || !password || !username || !fullName) {
                alert('Please fill in all required fields (Email, Password, Username, Full Name)');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ Creating user...';
            btn.disabled = true;

            try {
                console.log('📝 Creating user via signUp...');

                // Step 1: Sign up the new user
                // This creates them in auth.users
                const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username,
                            full_name: fullName
                        }
                    }
                });

                if (signUpError) {
                    throw new Error(signUpError.message);
                }

                if (!signUpData?.user) {
                    throw new Error('User creation failed - no user returned');
                }

                console.log('✅ Auth user created:', signUpData.user.id);

                // Step 2: Create the user profile via secure function (bypasses RLS)
                const { error: profileError } = await supabaseClient.rpc('create_user_profile', {
                    user_id: signUpData.user.id,
                    user_username: username,
                    user_full_name: fullName,
                    user_role: role,
                    user_location_id: role === 'superadmin' ? null : locationId,
                    user_department: department || null
                });

                if (profileError) {
                    console.error('Profile error:', profileError);
                    throw new Error('User created but profile failed: ' + profileError.message);
                }

                console.log('✅ Profile created for:', signUpData.user.id);

                // Success!
                alert(`✅ User created successfully!\n\nThey can now login with:\nEmail: ${email}\nPassword: (the password you set)`);

                // Clear form
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserUsername').value = '';
                document.getElementById('newUserFullName').value = '';
                const deptField = document.getElementById('newUserDepartment');
                if (deptField) deptField.value = '';

                // Reload users list and refresh technicians in memory
                await loadUserManagementList();
                if (role === 'technician' && supabaseClient && currentLocationId) {
                    const { data: freshTechs } = await supabaseClient
                        .from('user_profiles')
                        .select('full_name, department')
                        .eq('location_id', currentLocationId)
                        .eq('role', 'technician');
                    if (freshTechs) {
                        freshTechs.forEach(t => {
                            if (!t.full_name || !t.department) return;
                            if (!technicians[t.department]) technicians[t.department] = [];
                            if (!technicians[t.department].includes(t.full_name))
                                technicians[t.department].push(t.full_name);
                        });
                        console.log('🔄 Technicians refreshed live:', JSON.stringify(technicians));
                        render(); // re-render so tech bubbles update immediately
                    }
                }

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('❌ Error:', error);

                let errorMessage = error.message;
                if (error.message.includes('already registered') || error.message.includes('already been registered')) {
                    errorMessage = '❌ This email is already registered!\n\nPlease use a different email address.';
                } else if (error.message.includes('Password')) {
                    errorMessage = '❌ Password error: ' + error.message;
                } else if (error.message.includes('email')) {
                    errorMessage = '❌ Email error: ' + error.message;
                }

                alert(errorMessage);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
            
        async function loadUserManagementList() {
            if (!supabaseClient) return;

            const usersList = document.getElementById('userManagementList');
            if (usersList) usersList.innerHTML = '<p style="color:#718096;">Loading...</p>';

            try {
                // Use SECURITY DEFINER function to bypass RLS, then filter by current location
                const { data: allProfiles, error } = await supabaseClient
                    .rpc('get_all_user_profiles');
                
                // Filter to current location only (superadmins see all locations via the store switcher)
                const profiles = allProfiles ? allProfiles.filter(p => 
                    p.role === 'superadmin' ||  // always show superadmins
                    p.location_id === currentLocationId
                ) : [];

                if (error) {
                    console.error('Error loading users:', error);
                    if (usersList) usersList.innerHTML = `<p style="color:#e53e3e;padding:10px;background:#fff5f5;border-radius:6px;border:1px solid #fc8181;">❌ Error: ${error.message}</p>`;
                    return;
                }

                if (!usersList) return;

                // Load locations separately to resolve names
                const { data: locations } = await supabaseClient.from('locations').select('id, name');
                const locMap = {};
                if (locations) locations.forEach(l => locMap[l.id] = l.name);

                if (profiles && profiles.length > 0) {
                    usersList.innerHTML = `
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="border-bottom:2px solid #e2e8f0;background:#f7fafc;">
                                    <th style="text-align:left;padding:10px;">Username</th>
                                    <th style="text-align:left;padding:10px;">Full Name</th>
                                    <th style="text-align:left;padding:10px;">Role</th>
                                    <th style="text-align:left;padding:10px;">Location</th>
                                    <th style="text-align:left;padding:10px;">Department</th>
                                    <th style="text-align:left;padding:10px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${profiles.filter(p => p.role !== 'superadmin').map(p => `
                                    <tr style="border-bottom:1px solid #e2e8f0;">
                                        <td style="padding:10px;">${p.username || '-'}</td>
                                        <td style="padding:10px;">${p.full_name || '-'}</td>
                                        <td style="padding:10px;">
                                            <span style="padding:3px 8px;border-radius:4px;font-size:12px;font-weight:bold;background:${p.role === 'superadmin' ? '#fce7f3' : p.role === 'administrator' ? '#e6f7ff' : '#f0fdf4'};color:${p.role === 'superadmin' ? '#831843' : p.role === 'administrator' ? '#2c5282' : '#22543d'};">
                                                ${p.role}
                                            </span>
                                        </td>
                                        <td style="padding:10px;">${p.location_id ? (locMap[p.location_id] || p.location_id) : 'All Locations'}</td>
                                        <td style="padding:10px;">${p.department || '-'}</td>
                                        <td style="padding:10px;display:flex;gap:6px;">
                                            <button onclick="openEditUserModal('${p.id}','${p.username}','${p.full_name}','${p.role}','${p.location_id || ''}','${p.department || ''}')"
                                                style="background:#4299e1;color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:12px;">
                                                ✏️ Edit
                                            </button>
                                            ${p.role !== 'superadmin' && p.id !== (currentUser && currentUser.id) ? `
                                            <button onclick="deleteUser('${p.id}', '${p.username}', '${p.role}')"
                                                style="background:#e53e3e;color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:12px;">
                                                🗑 Delete
                                            </button>` : `
                                            <span style="font-size:11px;color:#a0aec0;padding:5px 6px;">${p.id === (currentUser && currentUser.id) ? '(you)' : '🔒 Protected'}</span>`}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    usersList.innerHTML = '<p style="color:#718096;">No users found.</p>';
                }

            } catch (err) {
                console.error('Error loading users:', err);
                if (usersList) usersList.innerHTML = '<p style="color:#e53e3e;">❌ ' + err.message + '</p>';
            }
        }

        function addTagToVehicle(vin, tagName) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            if (!vehicle.vehicleTags) vehicle.vehicleTags = [];
            
            if (vehicle.vehicleTags.includes(tagName)) {
                alert('Tag already applied to this vehicle');
                return;
            }

            vehicle.vehicleTags.push(tagName);
            
            // Apply tag effects
            const tagDef = tagDefinitions[tagName];
            if (tagDef && tagDef.skipsStep) {
                if (!vehicle.skippedSteps.includes(tagDef.skipsStep)) {
                    vehicle.skippedSteps.push(tagDef.skipsStep);
                    if (!vehicle.tags.includes(`Skip ${tagDef.skipsStep}`)) {
                        vehicle.tags.push(`Skip ${tagDef.skipsStep}`);
                    }
                }
            }

            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Tag added: ${tagName}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            render();
            alert(`✓ Tag "${tagName}" added`);
        }

        function removeTagFromVehicle(vin, tagName) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            vehicle.vehicleTags = (vehicle.vehicleTags || []).filter(t => t !== tagName);
            
            // Remove tag effects
            const tagDef = tagDefinitions[tagName];
            if (tagDef && tagDef.skipsStep) {
                vehicle.skippedSteps = vehicle.skippedSteps.filter(s => s !== tagDef.skipsStep);
                vehicle.tags = vehicle.tags.filter(t => t !== `Skip ${tagDef.skipsStep}`);
            }

            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Tag removed: ${tagName}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            render();
        }

        function createNewTag() {
            const tagName = document.getElementById('newTagName').value.trim();
            const tagType = document.getElementById('newTagType').value;
            const skipStep = document.getElementById('tagSkipStep').value;

            if (!tagName) {
                alert('Please enter a tag name');
                return;
            }

            if (tagDefinitions[tagName]) {
                alert('Tag already exists');
                return;
            }

            const newTag = {
                color: '#bee3f8'
            };

            if (tagType === 'skip' && skipStep) {
                newTag.skipsStep = skipStep;
            } else if (tagType === 'priority') {
                newTag.priority = true;
                newTag.color = '#fbd38d';
            } else {
                newTag.special = true;
            }

            tagDefinitions[tagName] = newTag;

            document.getElementById('newTagName').value = '';
            
            render();
            alert(`✓ Tag "${tagName}" created`);
        }

        function deleteTag(tagName) {
            if (confirm(`Delete tag "${tagName}"? This will remove it from all vehicles.`)) {
                // Remove from all vehicles
                vehicles.forEach(v => {
                    if (v.vehicleTags) {
                        v.vehicleTags = v.vehicleTags.filter(t => t !== tagName);
                    }
                });

                delete tagDefinitions[tagName];
                render();
                alert(`✓ Tag "${tagName}" deleted`);
            }
        }

        function editStepName(oldName) {
            const newName = prompt(`Enter new name for "${oldName}":`, oldName);
            if (!newName || newName === oldName) return;

            if (STEPS.includes(newName)) {
                alert('A step with this name already exists');
                return;
            }

            // Update in STEPS array
            const index = STEPS.indexOf(oldName);
            STEPS[index] = newName;

            // Update thresholds
            stepThresholds[newName] = stepThresholds[oldName];
            delete stepThresholds[oldName];

            // Update technicians
            technicians[newName] = technicians[oldName] || [];
            delete technicians[oldName];

            // Update substeps
            if (substeps[oldName]) {
                substeps[newName] = substeps[oldName];
                delete substeps[oldName];
            }

            // Update vehicles
            vehicles.forEach(v => {
                if (v.currentStep === oldName) v.currentStep = newName;
                if (v.completedSteps.includes(oldName)) {
                    const idx = v.completedSteps.indexOf(oldName);
                    v.completedSteps[idx] = newName;
                }
                if (v.skippedSteps.includes(oldName)) {
                    const idx = v.skippedSteps.indexOf(oldName);
                    v.skippedSteps[idx] = newName;
                }
            });

            render();
            alert(`✓ Step renamed to "${newName}"`);
        }

        function toggleStepExpansion(stepName) {
            if (expandedSteps.has(stepName)) {
                expandedSteps.delete(stepName);
            } else {
                expandedSteps.add(stepName);
            }
            render();
        }

        function addSubstep(stepName) {
            const substepName = prompt(`Enter new substep name for ${stepName}:`);
            if (!substepName) return;

            if (!substeps[stepName]) {
                substeps[stepName] = [];
            }

            if (substeps[stepName].includes(substepName)) {
                alert('Substep already exists');
                return;
            }

            substeps[stepName].push(substepName);
            render();
            alert(`✓ Substep "${substepName}" added to ${stepName}`);
        }

        function removeSubstep(stepName, substepName) {
            if (confirm(`Remove substep "${substepName}" from ${stepName}?`)) {
                substeps[stepName] = substeps[stepName].filter(s => s !== substepName);
                
                // Clean up if no substeps remain
                if (substeps[stepName].length === 0) {
                    delete substeps[stepName];
                }
                
                render();
                alert(`✓ Substep "${substepName}" removed`);
            }
        }

        function moveSubstepUp(stepName, substepName) {
            const list = substeps[stepName];
            const index = list.indexOf(substepName);
            if (index <= 0) return;

            [list[index], list[index - 1]] = [list[index - 1], list[index]];
            render();
        }

        function moveSubstepDown(stepName, substepName) {
            const list = substeps[stepName];
            const index = list.indexOf(substepName);
            if (index >= list.length - 1) return;

            [list[index], list[index + 1]] = [list[index + 1], list[index]];
            render();
        }

        function editSubstepName(stepName, oldName) {
            const newName = prompt(`Rename substep "${oldName}" to:`, oldName);
            if (!newName || newName === oldName) return;

            const index = substeps[stepName].indexOf(oldName);
            substeps[stepName][index] = newName;
            
            render();
            alert(`✓ Substep renamed to "${newName}"`);
        }

        // Workflow Management Functions
        function filterByWorkflow(workflowId) {
            currentWorkflowFilter = workflowId;
            selectedStatFilter = 'all';
            selectedStepFilter = 'all';
            render();
        }

        async function testWorkflowDB() {
            const lines = [];
            lines.push(`supabaseClient: ${!!supabaseClient}`);
            lines.push(`currentLocationId: ${currentLocationId}`);

            if (!supabaseClient) { alert('❌ No Supabase client.\n\n' + lines.join('\n')); return; }
            if (!currentLocationId) { alert('❌ No location selected (currentLocationId is null).\nYou must be logged in with a location assigned.\n\n' + lines.join('\n')); return; }

            // Try a SELECT first
            const { data: sel, error: selErr } = await supabaseClient
                .from('workflows').select('id, workflow_key, name').eq('location_id', currentLocationId).limit(3);
            lines.push(`SELECT result: ${selErr ? '❌ ' + selErr.message : '✅ ' + (sel?.length ?? 0) + ' rows'}`);

            // Try an INSERT with a test row
            const testKey = '_test_' + Date.now();
            const { data: ins, error: insErr } = await supabaseClient
                .from('workflows').insert({ workflow_key: testKey, name: 'DB TEST', steps: [], color: '#000000', location_id: currentLocationId }).select();
            lines.push(`INSERT result: ${insErr ? '❌ ' + insErr.message + ' (code: ' + insErr.code + ')' : '✅ Inserted id=' + ins?.[0]?.id}`);

            // Clean up test row if insert succeeded
            if (!insErr && ins?.[0]?.id) {
                await supabaseClient.from('workflows').delete().eq('id', ins[0].id);
                lines.push('Cleanup: ✅ test row deleted');
            }

            alert('🧪 Workflow DB Test Results:\n\n' + lines.join('\n'));
        }

        async function createWorkflow() {
            const name = prompt('Enter new workflow name:');
            if (!name) return;
            
            const id = name.replace(/\s+/g, '-').toLowerCase();
            if (workflows[id]) {
                alert('A workflow with this name already exists');
                return;
            }

            const color = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            workflows[id] = { name, steps: [], color };

            // Persist to Supabase
            if (supabaseClient && currentLocationId) {
                console.log('💾 Attempting to save workflow to Supabase...');
                console.log('   supabaseClient:', !!supabaseClient);
                console.log('   currentLocationId:', currentLocationId);
                console.log('   payload:', { workflow_key: id, name, steps: [], color, location_id: currentLocationId });

                const { data, error } = await supabaseClient.from('workflows').insert({
                    workflow_key: id,
                    name: name,
                    steps: [],
                    color: color,
                    location_id: currentLocationId
                }).select();

                if (error) {
                    console.error('❌ Supabase insert error:', error);
                    alert(`❌ Workflow could NOT be saved to database!\n\nError: ${error.message}\nCode: ${error.code}\nDetails: ${error.details || 'none'}\nHint: ${error.hint || 'none'}\n\nThis usually means:\n• Missing RLS policy on workflows table\n• Column name mismatch\n• The workflows table may not exist yet`);
                } else {
                    console.log('✅ Workflow saved to Supabase:', data);
                }
            } else {
                console.warn('⚠️ Skipping Supabase save:', { hasClient: !!supabaseClient, locationId: currentLocationId });
                alert(`⚠️ Workflow saved in memory only!\n\nReason: ${!supabaseClient ? 'No Supabase client' : 'No location selected (currentLocationId is null)'}`);
            }
            
            render();
            alert(`✓ Workflow "${name}" created. Configure steps in Admin Panel → Workflows tab.`);
        }

        async function deleteWorkflow(workflowId) {
            if (!confirm(`Delete workflow "${workflows[workflowId].name}"? Vehicles using this workflow will be moved to CPO.`)) return;

            vehicles.forEach(v => { if (v.workflow === workflowId) v.workflow = 'CPO'; });
            delete workflows[workflowId];

            if (supabaseClient && currentLocationId) {
                const { error } = await supabaseClient.from('workflows')
                    .delete()
                    .eq('workflow_key', workflowId)
                    .eq('location_id', currentLocationId);
                if (error) console.error('❌ Error deleting workflow from DB:', error.message);
                else console.log('✅ Workflow deleted from Supabase');
            }

            render();
            alert('✓ Workflow deleted');
        }

        async function editWorkflowName(workflowId) {
            const workflow = workflows[workflowId];
            const newName = prompt(`Enter new name for workflow:`, workflow.name);
            
            if (!newName || newName === workflow.name) return;
            
            workflow.name = newName;

            if (supabaseClient && currentLocationId) {
                const { error } = await supabaseClient.from('workflows')
                    .update({ name: newName })
                    .eq('workflow_key', workflowId)
                    .eq('location_id', currentLocationId);
                if (error) console.error('❌ Error updating workflow name in DB:', error.message);
                else console.log('✅ Workflow name updated in Supabase');
            }

            render();
            alert(`✓ Workflow renamed to "${newName}"`);
        }

        function editWorkflowColor(workflowId) {
            const workflow = workflows[workflowId];

            const palette = [
                { color: '#e53e3e', label: 'Red'        },
                { color: '#dd6b20', label: 'Orange'     },
                { color: '#d69e2e', label: 'Yellow'     },
                { color: '#38a169', label: 'Green'      },
                { color: '#319795', label: 'Teal'       },
                { color: '#3182ce', label: 'Blue'       },
                { color: '#553c9a', label: 'Purple'     },
                { color: '#b83280', label: 'Pink'       },
                { color: '#2d3748', label: 'Charcoal'   },
                { color: '#718096', label: 'Gray'       },
                { color: '#ed8936', label: 'Amber'      },
                { color: '#48bb78', label: 'Mint'       },
                { color: '#4299e1', label: 'Sky'        },
                { color: '#9f7aea', label: 'Lavender'   },
                { color: '#f687b3', label: 'Rose'       },
                { color: '#81e6d9', label: 'Aqua'       },
            ];

            const swatches = palette.map(p => `
                <button onclick="applyWorkflowColor('${workflowId}', '${p.color}')"
                    title="${p.label}"
                    style="width:48px;height:48px;background:${p.color};border:3px solid ${workflow.color === p.color ? '#1a202c' : 'transparent'};
                           border-radius:8px;cursor:pointer;transition:transform 0.1s;box-shadow:0 2px 4px rgba(0,0,0,0.2);"
                    onmouseover="this.style.transform='scale(1.15)'" onmouseout="this.style.transform='scale(1)'">
                </button>
            `).join('');

            const modal = `
                <div id="colorPickerModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);
                     z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px;">
                    <div style="background:white;border-radius:12px;padding:24px;max-width:340px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                            <div>
                                <div style="font-size:16px;font-weight:bold;color:#1a202c;">Pick a Color</div>
                                <div style="font-size:12px;color:#718096;margin-top:2px;">for "${workflow.name}"</div>
                            </div>
                            <button onclick="document.getElementById('colorPickerModal').remove()"
                                style="background:#e2e8f0;border:none;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:14px;">✕</button>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                            ${swatches}
                        </div>
                        <div style="margin-top:16px;padding:10px;background:#f7fafc;border-radius:6px;display:flex;align-items:center;gap:10px;">
                            <div style="width:32px;height:32px;background:${workflow.color};border-radius:6px;border:2px solid #e2e8f0;flex-shrink:0;"></div>
                            <span style="font-size:13px;color:#4a5568;">Current color</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function applyWorkflowColor(workflowId, color) {
            document.getElementById('colorPickerModal')?.remove();
            const workflow = workflows[workflowId];
            if (!workflow || workflow.color === color) return;

            workflow.color = color;

            if (supabaseClient && currentLocationId) {
                const { error } = await supabaseClient.from('workflows')
                    .update({ color })
                    .eq('workflow_key', workflowId)
                    .eq('location_id', currentLocationId);
                if (error) console.error('Error updating workflow color:', error.message);
            }

            render();
        }

        // Temporary storage for workflow step ordering
        let workflowEditState = {};

        function clickWorkflowStep(workflowId, step) {
            const workflow = workflows[workflowId];
            
            // Initialize edit state if needed
            if (!workflowEditState[workflowId]) {
                workflowEditState[workflowId] = [...workflow.steps];
            }
            
            const tempSteps = workflowEditState[workflowId];
            const index = tempSteps.indexOf(step);
            
            if (index > -1) {
                // Step already in list - remove it
                tempSteps.splice(index, 1);
            } else {
                // Add step to end of list
                tempSteps.push(step);
            }
            
            // Update button visuals without saving
            updateWorkflowStepButtons(workflowId);
        }
        
        function updateWorkflowStepButtons(workflowId) {
            const tempSteps = workflowEditState[workflowId] || workflows[workflowId].steps;
            
            STEPS.filter(s => s !== 'Finished').forEach(step => {
                const btnId = `step_btn_${workflowId}_${step.replace(/\s/g, '_')}`;
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                const stepIndex = tempSteps.indexOf(step);
                const isIncluded = stepIndex > -1;
                
                // Update button styling and number badge
                btn.style.background = isIncluded ? '#e6ffed' : 'white';
                btn.style.border = isIncluded ? '2px solid #48bb78' : '2px solid #e2e8f0';
                btn.style.fontWeight = isIncluded ? 'bold' : 'normal';
                
                // Update or remove number badge
                const existingBadge = btn.querySelector('span:first-child');
                if (isIncluded) {
                    const badgeHTML = `<span style="position: absolute; top: 2px; right: 2px; background: #48bb78; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${stepIndex + 1}</span>`;
                    if (existingBadge && existingBadge.style.position === 'absolute') {
                        existingBadge.outerHTML = badgeHTML;
                    } else {
                        btn.insertAdjacentHTML('afterbegin', badgeHTML);
                    }
                } else {
                    if (existingBadge && existingBadge.style.position === 'absolute') {
                        existingBadge.remove();
                    }
                }
            });
        }
        
        async function saveWorkflowOrder(workflowId) {
            if (!workflowEditState[workflowId]) {
                alert('No changes to save');
                return;
            }
            
            const workflow = workflows[workflowId];
            workflow.steps = [...workflowEditState[workflowId]];
            delete workflowEditState[workflowId];

            if (supabaseClient && currentLocationId) {
                const { error } = await supabaseClient.from('workflows')
                    .update({ steps: workflow.steps })
                    .eq('workflow_key', workflowId)
                    .eq('location_id', currentLocationId);
                if (error) {
                    console.error('❌ Error saving workflow steps to DB:', error.message);
                    alert(`Steps saved locally but DB save failed: ${error.message}`);
                    return;
                }
                console.log('✅ Workflow steps saved to Supabase');
            } else {
                console.warn('⚠️ No supabaseClient or currentLocationId — steps saved in memory only');
            }
            
            render();
            alert(`✓ Step order saved for ${workflow.name}`);
        }
        
        function clearWorkflowSteps(workflowId) {
            if (!confirm('Clear all steps from this workflow?')) return;
            
            workflowEditState[workflowId] = [];
            updateWorkflowStepButtons(workflowId);
        }

        function toggleWorkflowStep(workflowId, step) {
            // Legacy function - redirect to new click system
            clickWorkflowStep(workflowId, step);
        }

        function applyWorkflowToVehicle(vehicle, workflowId) {
            const workflow = workflows[workflowId];
            vehicle.workflow = workflowId;
            
            // Set skipped steps (steps not in this workflow)
            vehicle.skippedSteps = STEPS.filter(s => !workflow.steps.includes(s) && s !== 'Finished');
            
            // Move to first step in workflow
            const firstStep = workflow.steps[0];
            if (firstStep && firstStep !== 'Finished') {
                vehicle.currentStep = firstStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(firstStep);
            }
            
            render();
            alert(`✓ Vehicle assigned to ${workflow.name} workflow`);
        }
        
        // ============================================================
        // AI ROUND-ROBIN TECHNICIAN ASSIGNMENT
        // Uses workload counts to fairly distribute assignments
        // ============================================================

        // Track per-step round-robin counters for AI assignment
        let rrCounters = {}; // { stepName: { techName: assignmentCount } }

        function aiRoundRobinAssign(step) {
            const techList = Array.isArray(technicians)
                ? technicians.filter(t => t.department === step || t.step === step).map(t => t.name || t)
                : (technicians[step] || []);

            if (techList.length === 0) return assignTechnician(step); // fallback
            if (techList.length === 1) return techList[0];

            // Init counters for this step if needed
            if (!rrCounters[step]) {
                rrCounters[step] = {};
                techList.forEach(t => { rrCounters[step][t] = 0; });
            }

            // Count current live assignments for each tech in this step
            techList.forEach(tech => {
                rrCounters[step][tech] = vehicles.filter(v =>
                    v.assignedTech === tech &&
                    v.currentStep === step &&
                    v.currentStep !== 'Finished'
                ).length;
            });

            // Pick the tech with the fewest current assignments (true round-robin)
            let bestTech = techList[0];
            let minLoad = rrCounters[step][bestTech];
            techList.forEach(tech => {
                if (rrCounters[step][tech] < minLoad) {
                    minLoad = rrCounters[step][tech];
                    bestTech = tech;
                }
            });

            // Increment counter so next call in the same batch rotates fairly
            rrCounters[step][bestTech]++;
            lastAssignment[step] = bestTech;
            return bestTech;
        }

        async function assignWorkflowToVehicle(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const workflowSelect = document.getElementById(`workflow_${vin}`);
            const workflowId = workflowSelect.value;
            
            if (!workflowId) {
                alert('Please select a workflow');
                return;
            }
            
            const workflow = workflows[workflowId];
            if (!workflow) return;
            
            // Apply workflow
            vehicle.workflow = workflowId;
            vehicle.skippedSteps = STEPS.filter(s => !workflow.steps.includes(s) && s !== 'Finished');
            
            // Set to first step in workflow using AI round-robin
            const firstStep = workflow.steps[0];
            if (firstStep && firstStep !== 'Finished') {
                vehicle.currentStep = firstStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = aiRoundRobinAssign(firstStep);
            }
            
            // Add note to history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Workflow assigned: ${workflow.name}. Started in ${firstStep || 'N/A'}. Tech: ${vehicle.assignedTech}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            // Persist to Supabase
            if (supabaseClient && vehicle.id) {
                try {
                    await supabaseClient.from('vehicles').update({
                        workflow: vehicle.workflow,
                        current_step: vehicle.currentStep,
                        step_start_time: vehicle.stepStartTime.toISOString(),
                        assigned_tech: vehicle.assignedTech,
                        skipped_steps: vehicle.skippedSteps
                    }).eq('id', vehicle.id);
                } catch (e) {
                    console.warn('Supabase update failed (vehicle will update locally):', e.message);
                }
            }
            
            render();
            alert(`✓ Vehicle assigned to ${workflow.name} workflow and moved to ${firstStep} → Tech: ${vehicle.assignedTech}`);
        }

        // ============================================================
        // BULK ASSIGN ALL AWAITING VEHICLES
        // ============================================================
        async function assignAllAwaitingToWorkflow(workflowId) {
            const awaitingVehicles = vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING');
            
            if (awaitingVehicles.length === 0) {
                alert('No vehicles in the awaiting bucket.');
                return;
            }

            if (!workflowId) {
                alert('Please select a workflow to assign all vehicles to.');
                return;
            }

            const workflow = workflows[workflowId];
            if (!workflow) return;

            const confirmed = confirm(`Assign ALL ${awaitingVehicles.length} waiting vehicles to "${workflow.name}" workflow?\n\nAI round-robin will distribute technicians fairly across all vehicles.`);
            if (!confirmed) return;

            // Reset round-robin counters for a clean batch assignment
            rrCounters = {};

            const firstStep = workflow.steps[0];
            const results = [];
            let successCount = 0;
            let failCount = 0;

            // Show progress in the modal
            const progressDiv = document.getElementById('bulkAssignProgress');
            if (progressDiv) {
                progressDiv.style.display = 'block';
                progressDiv.textContent = `Assigning 0 / ${awaitingVehicles.length}...`;
            }

            for (let i = 0; i < awaitingVehicles.length; i++) {
                const vehicle = awaitingVehicles[i];

                vehicle.workflow = workflowId;
                vehicle.skippedSteps = STEPS.filter(s => !workflow.steps.includes(s) && s !== 'Finished');
                
                if (firstStep && firstStep !== 'Finished') {
                    vehicle.currentStep = firstStep;
                    vehicle.stepStartTime = new Date();
                    vehicle.assignedTech = aiRoundRobinAssign(firstStep);
                }

                if (!vehicle.noteHistory) vehicle.noteHistory = [];
                vehicle.noteHistory.push({
                    text: `[Bulk Assign] Workflow: ${workflow.name}. Step: ${firstStep}. Tech: ${vehicle.assignedTech}`,
                    timestamp: new Date(),
                    user: currentUser ? currentUser.username : 'Unknown',
                    id: Date.now() + Math.random()
                });

                // Persist to Supabase
                if (supabaseClient && vehicle.id) {
                    try {
                        const { error } = await supabaseClient.from('vehicles').update({
                            workflow: vehicle.workflow,
                            current_step: vehicle.currentStep,
                            step_start_time: vehicle.stepStartTime.toISOString(),
                            assigned_tech: vehicle.assignedTech,
                            skipped_steps: vehicle.skippedSteps
                        }).eq('id', vehicle.id);
                        if (error) { failCount++; } else { successCount++; }
                    } catch (e) {
                        failCount++;
                        console.warn('Supabase update failed for', vehicle.stockNumber, e.message);
                    }
                } else {
                    successCount++;
                }

                results.push({ stockNumber: vehicle.stockNumber, tech: vehicle.assignedTech });

                if (progressDiv) {
                    progressDiv.textContent = `Assigning ${i + 1} / ${awaitingVehicles.length}...`;
                }
            }

            closeAwaitingModal();
            render();

            // Build summary
            const techCounts = {};
            results.forEach(r => { techCounts[r.tech] = (techCounts[r.tech] || 0) + 1; });
            const techSummary = Object.entries(techCounts).map(([t, c]) => `  • ${t}: ${c} vehicle${c > 1 ? 's' : ''}`).join('\n');

            let msg = `✅ Bulk Assignment Complete!\n\n`;
            msg += `Workflow: ${workflow.name}\n`;
            msg += `First Step: ${firstStep}\n`;
            msg += `Vehicles Assigned: ${awaitingVehicles.length}\n`;
            if (supabaseClient) msg += `DB Updated: ${successCount} | Failed: ${failCount}\n`;
            msg += `\n🔄 Tech Distribution (AI Round-Robin):\n${techSummary}`;
            alert(msg);
        }

        function validateWorkflowCompletion(vehicle) {
            // Ensure vehicle has completed all required steps in their workflow before finishing
            const workflow = workflows[vehicle.workflow];
            if (!workflow) return true; // No workflow = allow completion
            
            const requiredSteps = workflow.steps.filter(s => s !== 'Finished' && s !== 'Quality Control');
            const missingSteps = requiredSteps.filter(s => 
                !vehicle.completedSteps.includes(s) && !vehicle.skippedSteps.includes(s)
            );
            
            if (missingSteps.length > 0) {
                alert(`❌ Cannot finish vehicle. Missing required steps:\n${missingSteps.join(', ')}`);
                return false;
            }
            
            return true;
        }

        // Auto-reassign logic with ML-like optimization
        async function autoReassignAll() {
            if (!confirm('Auto-reassign will analyze all vehicles and optimize assignments based on:\n• Queue lengths\n• Technician availability\n• Historical completion times\n\nProceed?')) {
                return;
            }

            // ── Show animated progress overlay ──
            document.body.insertAdjacentHTML('beforeend', `
                <div id="autoReassignOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:4000;display:flex;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:16px;padding:32px 36px;width:100%;max-width:400px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,0.3);">
                        <div style="font-size:40px;margin-bottom:10px;animation:arSpin 1s linear infinite;display:inline-block;">⚙️</div>
                        <div style="font-size:17px;font-weight:700;color:#2d3748;margin-bottom:4px;">Auto-Reassigning</div>
                        <div id="arMsg" style="font-size:13px;color:#718096;margin-bottom:18px;min-height:20px;">Analyzing vehicles…</div>
                        <div style="background:#edf2f7;border-radius:999px;height:8px;overflow:hidden;margin-bottom:20px;">
                            <div id="arBar" style="height:100%;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:999px;transition:width 0.25s ease;"></div>
                        </div>
                        <div style="display:flex;justify-content:center;gap:12px;">
                            <div style="text-align:center;">
                                <div id="arSteps" style="font-size:26px;font-weight:800;color:#553c9a;">0</div>
                                <div style="font-size:10px;font-weight:700;color:#805ad5;letter-spacing:.5px;">STEP CHANGES</div>
                            </div>
                            <div style="width:1px;background:#e2e8f0;"></div>
                            <div style="text-align:center;">
                                <div id="arTechs" style="font-size:26px;font-weight:800;color:#2b6cb0;">0</div>
                                <div style="font-size:10px;font-weight:700;color:#4299e1;letter-spacing:.5px;">TECH CHANGES</div>
                            </div>
                            <div style="width:1px;background:#e2e8f0;"></div>
                            <div style="text-align:center;">
                                <div id="arSaved" style="font-size:26px;font-weight:800;color:#276749;">0</div>
                                <div style="font-size:10px;font-weight:700;color:#38a169;letter-spacing:.5px;">SAVED</div>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes arSpin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
                </style>
            `);

            const setMsg  = t => { const e = document.getElementById('arMsg');   if(e) e.textContent = t; };
            const setBar  = p => { const e = document.getElementById('arBar');   if(e) e.style.width = p + '%'; };
            const setNum  = (id,n) => { const e = document.getElementById(id);   if(e) e.textContent = n; };

            await new Promise(r => setTimeout(r, 80)); // let overlay paint

            let stepChangeCount = 0;
            let techChangeCount = 0;
            const eligible = vehicles.filter(v => !reassignableLocks.has(v.vin) && v.currentStep !== 'Finished');

            setMsg('Scanning ' + eligible.length + ' vehicles…');
            setBar(15);
            await new Promise(r => setTimeout(r, 120));

            eligible.forEach((vehicle, i) => {
                const suggestedStep = getSuggestedAlternateStep(vehicle);
                if (suggestedStep) {
                    vehicle.currentStep = suggestedStep;
                    vehicle.stepStartTime = new Date();
                    vehicle.assignedTech = assignTechnician(suggestedStep);
                    stepChangeCount++;
                }
                const availableTech = getAvailableTechnician(vehicle.currentStep);
                if (availableTech && availableTech !== vehicle.assignedTech) {
                    vehicle.assignedTech = availableTech;
                    vehicle.stepStartTime = new Date();
                    techChangeCount++;
                }
                setBar(15 + 50 * (i + 1) / eligible.length);
                setNum('arSteps', stepChangeCount);
                setNum('arTechs', techChangeCount);
            });

            setMsg('Saving to server…');
            setBar(70);
            await new Promise(r => setTimeout(r, 80));

            let saved = 0;
            await Promise.all(eligible.map(async v => {
                await persistVehicleState(v);
                saved++;
                setNum('arSaved', saved);
                setBar(70 + 28 * saved / eligible.length);
            }));

            setBar(100);
            setMsg('✓ Done!');
            await new Promise(r => setTimeout(r, 600));

            const overlay = document.getElementById('autoReassignOverlay');
            if (overlay) overlay.remove();

            render();
            if (stepChangeCount + techChangeCount > 0) {
                alert('✓ Auto-reassignment complete!\n\n' + (stepChangeCount + techChangeCount) + ' total changes:\n• ' + stepChangeCount + ' step changes\n• ' + techChangeCount + ' technician changes');
            }
        }

        function toggleReassignLock(vin) {
            if (reassignableLocks.has(vin)) {
                reassignableLocks.delete(vin);
            } else {
                reassignableLocks.add(vin);
            }
            
            render();
        }

        function checkStepDependencies(vehicle, targetStep) {
            const dependencies = stepDependencies[targetStep];
            if (!dependencies) return { valid: true, missing: [] };

            const missing = dependencies.filter(dep => 
                !vehicle.completedSteps.includes(dep) && 
                !vehicle.skippedSteps.includes(dep)
            );

            return {
                valid: missing.length === 0,
                missing: missing
            };
        }

        function addStepDependency(step) {
            const dependencyStep = prompt(`Which step must be completed BEFORE ${step}?\n\nAvailable steps:\n${STEPS.filter(s => s !== step).join(', ')}`);
            
            if (!dependencyStep) return;
            if (!STEPS.includes(dependencyStep)) {
                alert('Invalid step name');
                return;
            }

            if (!stepDependencies[step]) {
                stepDependencies[step] = [];
            }

            if (stepDependencies[step].includes(dependencyStep)) {
                alert('Dependency already exists');
                return;
            }

            stepDependencies[step].push(dependencyStep);
            render();
            alert(`✓ ${step} now requires ${dependencyStep} to be completed first`);
        }

        function removeStepDependency(step, dependency) {
            if (confirm(`Remove requirement that ${dependency} must be completed before ${step}?`)) {
                stepDependencies[step] = stepDependencies[step].filter(d => d !== dependency);
                if (stepDependencies[step].length === 0) {
                    delete stepDependencies[step];
                }
                render();
            }
        }

        // Initialize file system structure
        function initializeFileSystem() {
            // In production, this would use actual file system APIs
            // For mockup, we'll simulate the structure
            console.log(`Creating directory structure at: ${baseDirectory}`);
            console.log(`History directory: ${historyDirectory}`);
            console.log(`Photos directory: ${photosDirectory}`);
            
            // Create sample structure documentation
            const structure = `
File System Structure:
=====================

${baseDirectory}/
├── recon_history/
│   ├── 2025/
│   │   ├── 02/
│   │   │   ├── A12345_completed_20250212.json
│   │   │   └── B98765_completed_20250215.json
│   │   └── 03/
│   └── 2024/
│
└── vehicle_photos/
    ├── A12345/
    │   ├── photo1_exterior_20250212_143022.jpg
    │   ├── photo2_interior_20250212_143045.jpg
    │   └── photo3_damage_20250212_143103.jpg
    ├── B98765/
    │   ├── photo1_20250213_091523.jpg
    │   └── photo2_20250213_091547.jpg
    └── C54321/
        └── photo1_20250214_102334.jpg
            `;
            
            console.log(structure);
            
            // Store in localStorage for persistence simulation
            try {
                localStorage.setItem('recon_base_directory', baseDirectory);
                localStorage.setItem('recon_file_structure', structure);
            } catch (e) {
                console.log('LocalStorage not available, using in-memory only');
            }
        }

        function saveVehicleToHistory(vehicle) {
            const completedDate = new Date();
            const year = completedDate.getFullYear();
            const month = String(completedDate.getMonth() + 1).padStart(2, '0');
            
            const historyRecord = {
                vin: vehicle.vin,
                stockNumber: vehicle.stockNumber,
                miles: vehicle.miles,
                appraisalNotes: vehicle.appraisalNotes,
                completedDate: completedDate,
                totalReconTime: Math.floor((completedDate - vehicle.entryTime) / (1000 * 60)), // minutes
                notes: vehicle.notes,
                noteHistory: vehicle.noteHistory || [], // Preserve note history
                photos: vehicle.photos,
                stepHistory: vehicle.stepHistory
            };

            // Add to in-memory history
            vehicleHistory.push(historyRecord);

            // Simulate file save
            const filename = `${vehicle.stockNumber}_completed_${completedDate.toISOString().split('T')[0].replace(/-/g, '')}.json`;
            const filepath = `${historyDirectory}/${year}/${month}/${filename}`;
            
            console.log(`Saving vehicle history to: ${filepath}`);
            console.log(JSON.stringify(historyRecord, null, 2));

            // In production, would use:
            // await fetch('/api/save-history', { method: 'POST', body: JSON.stringify(historyRecord) });
        }

        function savePhotoToFileSystem(vehicle, photoData, filename) {
            const stockNumber = vehicle.stockNumber;
            const vehiclePhotoDir = `${photosDirectory}/${stockNumber}`;
            const filepath = `${vehiclePhotoDir}/${filename}`;

            console.log(`Saving photo to: ${filepath}`);

            // In production, would use:
            // const formData = new FormData();
            // formData.append('file', photoData);
            // formData.append('stockNumber', stockNumber);
            // await fetch('/api/save-photo', { method: 'POST', body: formData });

            return filepath;
        }

        // Initialize on load
        if (typeof window !== 'undefined') {
            window.addEventListener('load', initializeFileSystem);
        }

        function getStepStats(step) {
            const vehiclesInStep = vehicles.filter(v => v.currentStep === step);
            const inStep = vehiclesInStep.length;
            const overdue = vehiclesInStep.filter(v => isOverdue(v)).length;
            
            let movable = 0;
            vehiclesInStep.forEach(vehicle => {
                const suggestedStep = getSuggestedAlternateStep(vehicle);
                if (suggestedStep) movable++;
            });
            
            return { inStep, movable, overdue };
        }

        async function pushToFinished(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            if (!confirm('Push ' + (vehicle.stockNumber || vin) + ' directly to Finished?\n\nThis will skip any incomplete steps. Administrator action.')) return;

            vehicle.currentStep = 'Finished';
            vehicle.stepStartTime = new Date();
            vehicle.assignedTech = null;

            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: 'Manually pushed to Finished by ' + (currentUser ? currentUser.name : 'Admin') + ' (steps bypassed)',
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'admin',
                id: Date.now() + Math.random()
            });

            await persistVehicleState(vehicle);
            render();
        }

        function quickCompleteStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle && vehicle.currentStep !== 'Finished') {
                if (confirm(`Complete ${vehicle.currentStep} for ${vehicle.stockNumber || vin}?`)) {
                    completeStep(vehicle);
                    alert(`✓ Moved to ${vehicle.currentStep}!`);
                }
            }
        }

        function completeTechStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle && vehicle.assignedTech === currentUser.name) {
                completeStep(vehicle);
                alert(`✓ ${vehicle.completedSteps[vehicle.completedSteps.length - 1]} completed for ${vehicle.stockNumber || vin}`);
            }
        }

        function showVehicleDetails(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            // Technicians can only interact with vehicles in their department
            if (currentUser.role === 'technician') {
                const techDept = currentUser.department;
                if (vehicle.currentStep !== techDept) {
                    alert('This vehicle is not in your department. You can only complete vehicles assigned to ' + techDept);
                    return;
                }
                if (vehicle.assignedTech !== currentUser.name) {
                    alert('This vehicle is assigned to ' + vehicle.assignedTech);
                    return;
                }
                
                // Technician can only complete their current step
                if (confirm(`Complete ${techDept} for ${vehicle.stockNumber || vin}?`)) {
                    completeStep(vehicle);
                    alert(`✓ ${techDept} completed for ${vehicle.stockNumber || vin}`);
                }
                return;
            }

            // Admin has full control
            if (isAdmin()) {
                showAdminVehicleDialog(vehicle);
            }
        }

        function buildTechOptions(vehicle) {
            // Log for debugging
            console.log('🔧 buildTechOptions | currentStep:', vehicle.currentStep, '| technicians:', JSON.stringify(technicians));

            // Gather techs for this specific step
            const stepTechs = (technicians[vehicle.currentStep] || []).slice();

            // Gather ALL techs across every step as fallback
            const allTechs = [];
            Object.entries(technicians).forEach(([step, list]) => {
                (list || []).forEach(t => { if (!allTechs.includes(t)) allTechs.push(t); });
            });

            // Decide which list to show — prefer step-specific, fall back to all
            const listToShow = stepTechs.length > 0 ? stepTechs : allTechs;
            const label = stepTechs.length > 0
                ? '— Unassigned —'
                : allTechs.length > 0 ? '— Unassigned (all techs shown) —' : '— No techs configured —';

            let html = '<option value="">' + label + '</option>';

            // If current assignedTech isn't in list, add them at top so they still show
            if (vehicle.assignedTech && !listToShow.includes(vehicle.assignedTech)) {
                html += '<option value="' + vehicle.assignedTech + '" selected>' + vehicle.assignedTech + ' (current)</option>';
            }

            listToShow.forEach(t => {
                html += '<option value="' + t + '" ' + (t === vehicle.assignedTech ? 'selected' : '') + '>' + t + '</option>';
            });

            return html;
        }

        function showAdminVehicleDialog(vehicle) {
            const dialogHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 1100px; width: 100%; max-height: 85vh; overflow-y: auto;">
                        <h2 style="margin-bottom: 5px; font-size: 18px;">Vehicle Details</h2>
                        ${vehicle.year && vehicle.make && vehicle.model ? `
                            <div style="font-size: 15px; color: #4299e1; margin-bottom: 10px; font-weight: 500;">
                                ${vehicle.year} ${vehicle.make} ${vehicle.model}
                            </div>
                        ` : '<div style="margin-bottom: 10px;"></div>'}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 12px;">
                            <div><strong>VIN:</strong> ${vehicle.vin}</div>
                            <div><strong>Stock #:</strong> ${vehicle.stockNumber || 'N/A'}</div>
                            <div><strong>Miles:</strong> ${vehicle.miles?.toLocaleString() || 'N/A'}</div>
                            <div style="grid-column: span 2; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <strong>Move to Step:</strong>
                                <select id="quickMoveSelect_${vehicle.vin}"
                                    style="flex:1; min-width:140px; padding:4px 8px; border:2px solid #4299e1; border-radius:5px; font-size:12px; font-weight:600; color:#2d3748; cursor:pointer;"
                                    onchange="quickMoveFromHeader('${vehicle.vin}', this)">
                                    <option value="${vehicle.currentStep}" selected>
                                        📍 ${vehicle.currentStep}
                                    </option>
                                    ${STEPS.filter(s => s !== vehicle.currentStep).map(s => {
                                        // Determine if step is allowed
                                        const preReqsMet = s !== 'Quality Control' || STEPS.filter(st =>
                                            st !== 'Quality Control' && st !== 'Finished'
                                        ).every(st =>
                                            vehicle.completedSteps.includes(st) || vehicle.skippedSteps.includes(st)
                                        );
                                        const disabled = !preReqsMet ? 'disabled' : '';
                                        const label = !preReqsMet ? s + ' 🔒' : s;
                                        return '<option value="' + s + '" ' + disabled + '>' + label + '</option>';
                                    }).join('')}
                                </select>
                            </div>
                            <div><strong>Time in Step:</strong> ${formatTimeDiff(vehicle.stepStartTime)}</div>
                            <div><strong>Total Time:</strong> ${formatTimeDiff(vehicle.entryTime)}</div>
                            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                                <strong>Assigned Tech:</strong>
                                <select id="techSelect_${vehicle.vin}"
                                    style="flex:1;min-width:130px;padding:4px 8px;border:2px solid #48bb78;border-radius:5px;font-size:12px;font-weight:600;color:#2d3748;cursor:pointer;"
                                    onchange="changeTechFromDialog('${vehicle.vin}', this.value)">
                                    ${buildTechOptions(vehicle)}
                                </select>
                            </div>
                            <div><strong>Photos:</strong> ${vehicle.photos?.length || 0}</div>
                            <div><strong>Notes:</strong> ${(vehicle.noteHistory || []).length}</div>
                        </div>
                        
                        ${vehicle.appraisalNotes ? `
                            <div style="margin-bottom: 15px; padding: 10px; background: #fffbeb; border-radius: 4px; font-size: 12px;">
                                <strong>Appraisal Notes:</strong><br>
                                ${vehicle.appraisalNotes}
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 15px; font-size: 12px;">
                            <strong>Completed:</strong> ${vehicle.completedSteps.join(', ') || 'None'}<br>
                            <strong>Skipped:</strong> ${vehicle.skippedSteps.join(', ') || 'None'}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'notes')" 
                                    class="action-tab-btn" id="btn_notes_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                📝 Notes
                            </button>
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'photos')" 
                                    class="action-tab-btn" id="btn_photos_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                📷 Photos
                            </button>
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'tags')" 
                                    class="action-tab-btn" id="btn_tags_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                🏷️ Tags
                            </button>
                            ${vehicle.stockNumber ? `
                                <button onclick="switchVehicleTab('${vehicle.vin}', 'history')" 
                                        class="action-tab-btn" id="btn_history_${vehicle.vin}"
                                        style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                    📜 History
                                </button>
                            ` : ''}
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'move')" 
                                    class="action-tab-btn" id="btn_move_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                🚗 Move
                            </button>
                            ${vehicle.currentStep !== 'Finished' ? `
                                <button onclick="switchVehicleTab('${vehicle.vin}', 'complete')" 
                                        class="action-tab-btn" id="btn_complete_${vehicle.vin}"
                                        style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                    ✅ Complete
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- All Data View (default - shown when nothing selected) -->
                        <div id="tab_all_${vehicle.vin}" class="tab-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Left Column -->
                                <div>
                                    <!-- Notes Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">📝 Recent Notes</h3>
                                        <div style="max-height: 150px; overflow-y: auto;">
                                            ${(vehicle.noteHistory && vehicle.noteHistory.length > 0) ? 
                                                vehicle.noteHistory.slice().reverse().slice(0, 3).map(note => `
                                                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-left: 3px solid #4299e1; border-radius: 4px;">
                                                        <div style="font-size: 10px; color: #718096; margin-bottom: 3px;">
                                                            <strong>${note.user}</strong> - ${new Date(note.timestamp).toLocaleDateString()}
                                                        </div>
                                                        <div style="color: #2d3748; font-size: 11px;">${note.text}</div>
                                                    </div>
                                                `).join('') 
                                                : '<div style="color: #a0aec0; font-size: 12px; padding: 8px;">No notes yet</div>'
                                            }
                                        </div>
                                        ${(vehicle.noteHistory && vehicle.noteHistory.length > 3) ? `
                                            <div style="margin-top: 8px; font-size: 11px; color: #718096; text-align: center;">
                                                +${vehicle.noteHistory.length - 3} more notes (click Notes to view all)
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Tags Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">🏷️ Tags</h3>
                                        <div style="min-height: 40px;">
                                            ${(vehicle.vehicleTags || []).map(tag => `
                                                <span class="tag-chip" style="background: ${tagDefinitions[tag]?.color || '#bee3f8'}; display: inline-block; margin: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    ${tag}
                                                </span>
                                            `).join('')}
                                            ${(vehicle.vehicleTags || []).length === 0 ? '<div style="color: #a0aec0; font-size: 12px; padding: 8px;">No tags applied</div>' : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div>
                                    <!-- Photos Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">📷 Photos</h3>
                                        <div style="font-size: 12px; color: #4a5568;">
                                            ${vehicle.photos && vehicle.photos.length > 0 ? 
                                                `${vehicle.photos.length} photo(s) uploaded` : 
                                                '<span style="color: #a0aec0;">No photos uploaded</span>'
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- Current Status -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">🚗 Current Status</h3>
                                        <div style="font-size: 12px; line-height: 1.6;">
                                            <div><strong>Step:</strong> ${vehicle.currentStep}</div>
                                            <div><strong>Time in step:</strong> ${formatTimeDiff(vehicle.stepStartTime)}</div>
                                            <div><strong>Total time:</strong> ${formatTimeDiff(vehicle.entryTime)}</div>
                                            <div><strong>Tech:</strong> ${vehicle.assignedTech}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Tab -->
                        <div id="tab_notes_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">📝 Notes History</h3>
                            <div style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 6px;">
                                ${(vehicle.noteHistory && vehicle.noteHistory.length > 0) ? 
                                    vehicle.noteHistory.slice().reverse().map(note => `
                                        <div style="margin-bottom: 12px; padding: 12px; background: white; border-left: 4px solid #4299e1; border-radius: 4px;">
                                            <div style="font-size: 11px; color: #718096; margin-bottom: 5px;">
                                                <strong>${note.user}</strong> - ${new Date(note.timestamp).toLocaleString()}
                                            </div>
                                            <div style="color: #2d3748; font-size: 13px;">${note.text}</div>
                                        </div>
                                    `).join('') 
                                    : '<div style="color: #a0aec0; font-size: 13px; padding: 12px;">No notes yet</div>'
                                }
                            </div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Add New Note:</label>
                            <textarea id="vehicleNotes_${vehicle.vin}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 13px;" placeholder="Enter note..."></textarea>
                            <button class="btn" onclick="addNoteToVehicle('${vehicle.vin}', document.getElementById('vehicleNotes_${vehicle.vin}').value)" style="margin-top: 10px; font-size: 13px; padding: 10px 20px; width: 100%;">
                                ➕ Add Note to History
                            </button>
                        </div>
                        
                        <!-- Photos Tab -->
                        <div id="tab_photos_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">📷 Upload Photos</h3>
                            <input type="file" id="photoUpload_${vehicle.vin}" accept="image/*" multiple 
                                   onchange="handlePhotoUpload('${vehicle.vin}', event)"
                                   style="width: 100%; padding: 15px; border: 3px dashed #cbd5e0; border-radius: 6px; font-size: 13px; background: #f7fafc; cursor: pointer;">
                            ${vehicle.photos && vehicle.photos.length > 0 ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                    <strong style="font-size: 13px;">Uploaded Photos:</strong>
                                    <div style="margin-top: 10px; font-size: 13px; color: #4a5568;">
                                        ${vehicle.photos.length} photo(s) uploaded
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Tags Tab -->
                        <div id="tab_tags_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">🏷️ Vehicle Tags</h3>
                            <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px; min-height: 80px;">
                                <strong style="font-size: 12px; display: block; margin-bottom: 10px;">Current Tags:</strong>
                                ${(vehicle.vehicleTags || []).map(tag => `
                                    <span style="display: inline-flex; align-items: center; background: ${tagDefinitions[tag]?.color || '#bee3f8'}; margin: 5px; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                                        ${tag}
                                        <button onclick="removeTagFromVehicle('${vehicle.vin}', '${tag}'); closeDialog(); showVehicleDetails('${vehicle.vin}');" 
                                                style="margin-left: 8px; background: none; border: none; color: #e53e3e; cursor: pointer; font-weight: bold; font-size: 14px; padding: 0; line-height: 1;">
                                            ✕
                                        </button>
                                    </span>
                                `).join('')}
                                ${(vehicle.vehicleTags || []).length === 0 ? '<div style="color: #a0aec0; font-size: 13px; padding: 10px;">No tags applied</div>' : ''}
                            </div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 13px;">Add New Tag:</label>
                            <select id="addTagSelect_${vehicle.vin}" style="width: 100%; padding: 12px; margin-bottom: 12px; font-size: 13px; border: 2px solid #cbd5e0; border-radius: 6px;">
                                <option value="">-- Select Tag --</option>
                                ${Object.keys(tagDefinitions).filter(t => !(vehicle.vehicleTags || []).includes(t)).map(tag => `
                                    <option value="${tag}">${tag}</option>
                                `).join('')}
                            </select>
                            <button class="btn" onclick="const sel = document.getElementById('addTagSelect_${vehicle.vin}'); if(sel.value) { addTagToVehicle('${vehicle.vin}', sel.value); closeDialog(); showVehicleDetails('${vehicle.vin}'); }" style="width: 100%; font-size: 13px; padding: 12px;">
                                ➕ Add Selected Tag
                            </button>
                        </div>
                        
                        <!-- History Tab -->
                        ${vehicle.stockNumber ? `
                            <div id="tab_history_${vehicle.vin}" class="tab-content" style="display: none;">
                                <h3 style="margin-bottom: 15px; font-size: 15px;">📜 5-Year Vehicle History</h3>
                                <button class="btn" onclick="closeDialog(); viewVehicleHistory('${vehicle.stockNumber}')" 
                                        style="width: 100%; background: #805ad5; font-size: 14px; padding: 15px;">
                                    View Complete Timeline
                                </button>
                                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 6px; font-size: 12px; color: #718096; line-height: 1.6;">
                                    View all historical records, notes, and events for this stock number including past recon visits and completion dates.
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Move Tab -->
                        <div id="tab_move_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">🚗 Move Vehicle to Different Step</h3>
                            <div style="margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 6px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #718096;">
                                    Current Step:
                                </label>
                                <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${vehicle.currentStep}</div>
                            </div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 13px;">Move to:</label>
                            <select id="moveToStep_${vehicle.vin}" style="width: 100%; padding: 15px; margin-bottom: 15px; font-size: 14px; border: 2px solid #cbd5e0; border-radius: 6px;">
                                ${STEPS.map(step => `
                                    <option value="${step}" ${step === vehicle.currentStep ? 'selected' : ''}>
                                        ${step}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn" onclick="moveVehicleToStepFromDialog('${vehicle.vin}')" style="width: 100%; padding: 15px; font-size: 14px; background: #4299e1;">
                                🚗 Move Vehicle
                            </button>
                        </div>
                        
                        <!-- Complete Tab -->
                        ${vehicle.currentStep !== 'Finished' ? `
                            <div id="tab_complete_${vehicle.vin}" class="tab-content" style="display: none;">
                                <h3 style="margin-bottom: 15px; font-size: 15px;">✅ Complete Current Step</h3>
                                <div style="padding: 15px; background: #f7fafc; border-radius: 6px; margin-bottom: 20px;">
                                    <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">
                                        Current Step: <strong style="color: #2d3748; font-size: 15px;">${vehicle.currentStep}</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #718096;">
                                        Time in step: ${formatTimeDiff(vehicle.stepStartTime)}
                                    </div>
                                </div>
                                ${vehicle.currentStep === 'Quality Control' ? `
                                    <button class="btn" onclick="passQC('${vehicle.vin}')" style="width: 100%; background: #48bb78; margin-bottom: 12px; padding: 15px; font-size: 14px;">
                                        ✓ Pass QC - Move to Finished
                                    </button>
                                    <button class="btn" onclick="showRejectQC('${vehicle.vin}')" style="width: 100%; background: #e53e3e; padding: 15px; font-size: 14px;">
                                        ✗ Fail QC - Send Back
                                    </button>
                                ` : `
                                    <button class="btn" onclick="adminCompleteStep('${vehicle.vin}')" style="width: 100%; background: #48bb78; padding: 15px; font-size: 14px;">
                                        ✅ Complete ${vehicle.currentStep}
                                    </button>
                                `}
                            </div>
                        ` : ''}
                        
                        <button class="btn" onclick="closeDialog()" style="width: 100%; background: #718096; padding: 12px; font-size: 14px; margin-top: 20px;">
                            Close
                        </button>
                    </div>
                </div>
                
                <style>
                    .action-tab-btn:hover {
                        background: #f7fafc !important;
                        border-color: #cbd5e0 !important;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .action-tab-btn.active {
                        background: #4299e1 !important;
                        color: white !important;
                        border-color: #4299e1 !important;
                        box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
        
        function switchVehicleTab(vin, tab) {
            // Check if clicking the already active button
            const selectedBtn = document.getElementById(`btn_${tab}_${vin}`);
            if (selectedBtn && selectedBtn.classList.contains('active')) {
                // Unclick - return to overview
                const buttons = document.querySelectorAll('.action-tab-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                const tabs = ['all', 'notes', 'photos', 'tags', 'history', 'move', 'complete'];
                tabs.forEach(t => {
                    const elem = document.getElementById(`tab_${t}_${vin}`);
                    if (elem) elem.style.display = 'none';
                });
                
                // Show overview
                const overviewTab = document.getElementById(`tab_all_${vin}`);
                if (overviewTab) overviewTab.style.display = 'block';
                return;
            }
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.action-tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Hide all tabs
            const tabs = ['all', 'notes', 'photos', 'tags', 'history', 'move', 'complete'];
            tabs.forEach(t => {
                const elem = document.getElementById(`tab_${t}_${vin}`);
                if (elem) elem.style.display = 'none';
            });
            
            // Show selected tab and activate button
            const selectedTab = document.getElementById(`tab_${tab}_${vin}`);
            
            if (selectedTab) selectedTab.style.display = 'block';
            if (selectedBtn) selectedBtn.classList.add('active');
        }
        
        async function changeTechFromDialog(vin, newTech) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            vehicle.assignedTech = newTech || null;
            vehicle.stepStartTime = new Date(); // reset timer on reassign

            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: 'Tech changed to ' + (newTech || 'Unassigned'),
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            await persistVehicleState(vehicle);
            // Refresh the select to reflect saved state without closing dialog
            const sel = document.getElementById('techSelect_' + vin);
            if (sel) sel.style.borderColor = '#48bb78';
        }

        async function quickMoveFromHeader(vin, selectEl) {
            const newStep = selectEl.value;
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle || newStep === vehicle.currentStep) return;

            // QC guard — all prior steps must be complete
            if (newStep === 'Quality Control') {
                const allDone = STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished')
                    .every(s => vehicle.completedSteps.includes(s) || vehicle.skippedSteps.includes(s));
                if (!allDone) {
                    alert('❌ Cannot move to Quality Control — all prior steps must be completed first.');
                    selectEl.value = vehicle.currentStep;
                    return;
                }
            }

            const oldStep = vehicle.currentStep;
            vehicle.currentStep = newStep;
            vehicle.stepStartTime = new Date();
            vehicle.assignedTech = assignTechnician(newStep);

            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: 'Manually moved from ' + oldStep + ' to ' + newStep,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            await persistVehicleState(vehicle);
            closeDialog();
            render();
            alert('✓ ' + (vehicle.stockNumber || vin) + ' moved to ' + newStep);
        }

        async function moveVehicleToStepFromDialog(vin) {
            const newStep = document.getElementById(`moveToStep_${vin}`).value;
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const oldStep = vehicle.currentStep;
            vehicle.currentStep = newStep;
            vehicle.stepStartTime = new Date();
            
            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Vehicle moved from ${oldStep} to ${newStep}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });
            
            await persistVehicleState(vehicle);
            closeDialog();
            render();
            alert(`✓ Vehicle moved to ${newStep}`);
        }

        function closeDialog() {
            const dialog = document.getElementById('vehicleDialog');
            if (dialog) dialog.remove();
        }

        async function moveVehicleToStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            const newStep = document.getElementById('moveToStep').value;
            
            if (vehicle && newStep) {
                // Check dependencies
                const depCheck = checkStepDependencies(vehicle, newStep);
                if (!depCheck.valid) {
                    alert(`❌ Cannot move to ${newStep}\n\nMissing required steps:\n${depCheck.missing.join(', ')}\n\nThese must be completed first.`);
                    return;
                }

                // Remove from completed if moving back
                const index = vehicle.completedSteps.indexOf(newStep);
                if (index > -1) {
                    vehicle.completedSteps.splice(index);
                }
                
                vehicle.currentStep = newStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(newStep);
                
                // If moving to Finished, save to history
                if (newStep === 'Finished') {
                    saveVehicleToHistory(vehicle);
                }

                await persistVehicleState(vehicle);
                closeDialog();
                render();
                alert(`Vehicle ${vehicle.stockNumber || vin} moved to ${newStep}`);
            }
        }

        async function adminCompleteStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                await completeStep(vehicle);
                closeDialog();
                render();
                alert(`✓ ${vehicle.completedSteps[vehicle.completedSteps.length - 1]} completed for ${vehicle.stockNumber || vin}`);
            }
        }

        async function passQC(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                await completeStep(vehicle);
                closeDialog();
                render();
                alert(`✓ Quality Control passed - Vehicle moved to Finished`);
            }
        }

        function showRejectQC(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            closeDialog();
            
            const dialogHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 400px; width: 100%;">
                        <h2 style="margin-bottom: 15px; color: #e53e3e; font-size: 18px;">Reject from QC</h2>
                        <p style="margin-bottom: 12px; font-size: 14px;">Send ${vin} back to:</p>
                        <select id="rejectToStep" style="width: 100%; padding: 8px; margin-bottom: 12px; font-size: 14px;">
                            ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => `
                                <option value="${step}">${step}</option>
                            `).join('')}
                        </select>
                        <button class="btn" onclick="rejectVehicle('${vin}')" style="width: 100%; background: #e53e3e; margin-bottom: 8px; padding: 10px; font-size: 14px;">
                            Send Back
                        </button>
                        <button class="btn" onclick="closeDialog()" style="width: 100%; background: #718096; padding: 10px; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }

        async function rejectVehicle(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            const sendBackTo = document.getElementById('rejectToStep').value;
            
            if (vehicle && sendBackTo) {
                await rejectFromQC(vehicle, sendBackTo);
                closeDialog();
                render();
                alert(`Vehicle ${vehicle.stockNumber || vin} sent back to ${sendBackTo}`);
            }
        }

        async function addNewVehicle(forceAdd = false) {
            const vin = document.getElementById('newVIN').value.trim().toUpperCase();
            const stockNumber = document.getElementById('newStockNumber').value.trim().toUpperCase();
            const year = document.getElementById('newYear').value;
            const make = document.getElementById('newMake').value.trim();
            const model = document.getElementById('newModel').value.trim();
            const miles = parseInt(document.getElementById('newMiles').value) || 0;
            const skipStepsSelect = document.getElementById('skipSteps');
            const skippedSteps = Array.from(skipStepsSelect.selectedOptions).map(opt => opt.value);
            
            if (!vin) {
                alert('Please enter a VIN');
                return;
            }
            
            if (!stockNumber) {
                alert('Please enter a Stock Number');
                return;
            }
            
            // Check for duplicate stock number (only if not forcing)
            if (!forceAdd && supabaseClient && currentLocationId) {
                try {
                    const { data: existingStock, error: stockError } = await supabaseClient
                        .from('vehicles')
                        .select('id, vin, year, make, model, current_step, workflow')
                        .eq('location_id', currentLocationId)
                        .eq('stock_number', stockNumber)
                        .maybeSingle();
                    
                    if (existingStock) {
                        // Check if user is admin or super admin
                        const canOverride = currentUser && (currentUser.role === 'administrator' || currentUser.role === 'superadmin');
                        
                        if (canOverride) {
                            // Admin can choose to delete old and add new
                            const choice = confirm(`⚠️ DUPLICATE STOCK NUMBER DETECTED!

Stock # "${stockNumber}" already exists:

VIN: ${existingStock.vin}
Vehicle: ${existingStock.year} ${existingStock.make} ${existingStock.model}
Workflow: ${existingStock.workflow || 'None'}
Current Step: ${existingStock.current_step}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

As an administrator, you can:

✅ REPLACE the old vehicle with this new one
   (Old vehicle will be deleted)

❌ CANCEL and use a different stock number

Click OK to REPLACE the old vehicle.
Click Cancel to stop.`);
                            
                            if (!choice) {
                                return; // User cancelled
                            }
                            
                            // Delete the old vehicle first
                            const { error: deleteError } = await supabaseClient
                                .from('vehicles')
                                .delete()
                                .eq('id', existingStock.id);
                            
                            if (deleteError) {
                                alert('Error removing old vehicle: ' + deleteError.message);
                                return;
                            }
                            
                            console.log('✅ Old vehicle deleted, proceeding with new addition');
                            // Continue to add new vehicle below
                            
                        } else {
                            // Not an admin - cannot override
                            alert(`❌ DUPLICATE STOCK NUMBER!

Stock # "${stockNumber}" already exists at this location:

VIN: ${existingStock.vin}
Vehicle: ${existingStock.year} ${existingStock.make} ${existingStock.model}
Current Step: ${existingStock.current_step}

You do not have permission to override duplicates.
Please use a different stock number or contact an administrator.`);
                            return;
                        }
                    }
                    
                } catch (err) {
                    console.log('Duplicate check complete, proceeding...');
                }
            }
            
            // Create vehicle object
            const newVehicle = {
                location_id: currentLocationId,
                vin: vin,
                stock_number: stockNumber,
                year: year,
                make: make,
                model: model,
                miles: miles,
                entry_time: new Date().toISOString(),
                current_step: 'Awaiting Arrival',
                step_start_time: new Date().toISOString(),
                completed_steps: [],
                assigned_tech: null,
                tags: [],
                vehicle_tags: skippedSteps.map(s => `Skip ${s}`),
                appraisal_notes: 'Vehicle added to system - awaiting arrival',
                workflow: 'AWAITING'
            };
            
            // Insert into Supabase
            if (supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('vehicles')
                        .insert(newVehicle)
                        .select()
                        .single();
                    
                    if (error) {
                        if (error.code === '23505') {
                            alert(`❌ Database Rejected: Duplicate Stock Number!

Stock # "${stockNumber}" already exists at this location.

Each stock number must be unique per location.

Please use a different stock number.`);
                        } else {
                            alert('Error adding vehicle: ' + error.message);
                        }
                        return;
                    }
                    
                    // Success!
                    alert(`✅ Vehicle ${stockNumber} added successfully!

Vehicle is now in "Awaiting Arrival". 
Assign a workflow when the vehicle arrives.`);
                    
                    // Clear form
                    document.getElementById('newVIN').value = '';
                    document.getElementById('newStockNumber').value = '';
                    document.getElementById('newYear').value = '';
                    document.getElementById('newMake').value = '';
                    document.getElementById('newModel').value = '';
                    document.getElementById('newMiles').value = '';
                    if (skipStepsSelect) skipStepsSelect.selectedIndex = -1;
                    
                    // Reload data
                    await loadDataFromSupabase();
                    render();
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error adding vehicle: ' + error.message);
                }
            } else {
                // Fallback for mock mode
                const mockVehicle = {
                    vin: vin,
                    stockNumber: stockNumber,
                    year: year,
                    make: make,
                    model: model,
                    miles: miles,
                    entryTime: new Date(),
                    currentStep: 'Awaiting Arrival',
                    stepStartTime: new Date(),
                    completedSteps: [],
                    skippedSteps: skippedSteps,
                    assignedTech: 'unassigned',
                    tags: skippedSteps.map(s => `Skip ${s}`),
                    vehicleTags: [],
                    notes: '',
                    noteHistory: [
                        { text: 'Vehicle added to system - awaiting arrival and workflow assignment', timestamp: new Date(), user: currentUser ? currentUser.username : 'admin', id: Date.now() }
                    ],
                    photos: [],
                    stepHistory: [],
                    workflow: 'AWAITING'
                };

                vehicles.push(mockVehicle);
                if (stockNumber) stockNumberRegistry.add(stockNumber);
                
                // Clear form
                document.getElementById('newVIN').value = '';
                document.getElementById('newStockNumber').value = '';
                document.getElementById('newYear').value = '';
                document.getElementById('newMake').value = '';
                document.getElementById('newModel').value = '';
                document.getElementById('newMiles').value = '';
                if (skipStepsSelect) skipStepsSelect.selectedIndex = -1;
                
                render();
                alert(`✓ Vehicle ${stockNumber || vin} added to "Awaiting Arrival". Assign a workflow when the vehicle arrives.`);
            }
        }

        function updateThreshold(step, value) {
            stepThresholds[step] = parseFloat(value);
            render();
        }

        // Excel Import Functions
        // ── Import progress dialog helpers ──────────────────────────────
        function showImportDialog(total) {
            const existing = document.getElementById('importProgressDialog');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', `
                <div id="importProgressDialog" style="
                    position:fixed;top:0;left:0;right:0;bottom:0;
                    background:rgba(0,0,0,0.55);z-index:3000;
                    display:flex;align-items:center;justify-content:center;padding:20px;">
                    <div style="
                        background:white;border-radius:12px;padding:28px;
                        width:100%;max-width:480px;
                        box-shadow:0 20px 60px rgba(0,0,0,0.3);">

                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                            <div id="importSpinner" style="
                                width:28px;height:28px;border-radius:50%;
                                border:3px solid #e2e8f0;border-top-color:#4299e1;
                                animation:spin 0.7s linear infinite;flex-shrink:0;"></div>
                            <div>
                                <div style="font-weight:700;font-size:16px;">Importing Vehicles</div>
                                <div id="importStatusText" style="font-size:13px;color:#718096;margin-top:2px;">
                                    Reading file…
                                </div>
                            </div>
                        </div>

                        <!-- Progress bar -->
                        <div style="background:#edf2f7;border-radius:999px;height:10px;overflow:hidden;margin-bottom:14px;">
                            <div id="importProgressBar" style="
                                height:100%;width:0%;
                                background:linear-gradient(90deg,#4299e1,#48bb78);
                                border-radius:999px;
                                transition:width 0.25s ease;"></div>
                        </div>

                        <!-- Counters row -->
                        <div style="display:flex;gap:10px;margin-bottom:16px;">
                            <div style="flex:1;text-align:center;background:#f0fdf4;border-radius:8px;padding:10px;">
                                <div id="importCountDone" style="font-size:22px;font-weight:800;color:#22543d;">0</div>
                                <div style="font-size:11px;color:#38a169;font-weight:600;">IMPORTED</div>
                            </div>
                            <div style="flex:1;text-align:center;background:#fffbeb;border-radius:8px;padding:10px;">
                                <div id="importCountSkip" style="font-size:22px;font-weight:800;color:#92400e;">0</div>
                                <div style="font-size:11px;color:#d97706;font-weight:600;">UPDATED</div>
                            </div>
                            <div style="flex:1;text-align:center;background:#fff5f5;border-radius:8px;padding:10px;">
                                <div id="importCountErr" style="font-size:22px;font-weight:800;color:#c53030;">0</div>
                                <div style="font-size:11px;color:#e53e3e;font-weight:600;">ERRORS</div>
                            </div>
                        </div>

                        <!-- Row log -->
                        <div id="importLog" style="
                            max-height:160px;overflow-y:auto;
                            font-size:12px;font-family:monospace;
                            background:#1a202c;color:#e2e8f0;
                            border-radius:6px;padding:10px;
                            line-height:1.6;"></div>

                        <!-- Done button (hidden until finished) -->
                        <button id="importDoneBtn" onclick="closeImportDialog()" style="
                            display:none;margin-top:16px;width:100%;
                            padding:11px;background:#48bb78;color:white;
                            border:none;border-radius:8px;font-size:15px;
                            font-weight:bold;cursor:pointer;">
                            ✅ Done — Close
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                </style>
            `);
        }

        function updateImportDialog(done, skipped, errors, total, logLine) {
            const pct = total > 0 ? Math.round(((done + skipped + errors) / total) * 100) : 0;
            document.getElementById('importProgressBar').style.width = pct + '%';
            document.getElementById('importStatusText').textContent =
                `${done + skipped + errors} of ${total} processed (${pct}%)`;
            document.getElementById('importCountDone').textContent = done;
            document.getElementById('importCountSkip').textContent = skipped;
            document.getElementById('importCountErr').textContent = errors;

            if (logLine) {
                const log = document.getElementById('importLog');
                log.insertAdjacentHTML('beforeend', `<div>${logLine}</div>`);
                log.scrollTop = log.scrollHeight;
            }
        }

        function finishImportDialog(done, skipped, errors, duplicates) {
            // Swap spinner for checkmark
            document.getElementById('importSpinner').style.cssText =
                'width:28px;height:28px;border-radius:50%;background:#48bb78;' +
                'display:flex;align-items:center;justify-content:center;' +
                'color:white;font-size:16px;flex-shrink:0;';
            document.getElementById('importSpinner').textContent = '✓';
            document.getElementById('importStatusText').textContent = 'Import complete!';
            document.getElementById('importProgressBar').style.width = '100%';

            const log = document.getElementById('importLog');
            log.insertAdjacentHTML('beforeend',
                `<div style="color:#68d391;margin-top:6px;border-top:1px solid #2d3748;padding-top:6px;">` +
                `── Finished: ${done} added, ${skipped} updated, ${errors} errors ──</div>`
            );
            if (duplicates.length > 0) {
                log.insertAdjacentHTML('beforeend',
                    `<div style="color:#f6e05e;">Duplicates: ${duplicates.join(', ')}</div>`
                );
            }
            log.scrollTop = log.scrollHeight;
            document.getElementById('importDoneBtn').style.display = 'block';
        }

        function closeImportDialog() {
            const d = document.getElementById('importProgressDialog');
            if (d) d.remove();
        }

        // ── Main import handler ──────────────────────────────────────────
        async function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                // lines[0] = header row
                const dataLines = lines.slice(1);

                let importedCount = 0;
                let skippedCount  = 0;
                let errorCount    = 0;
                let duplicates    = [];
                const vehiclesToImport = [];

                // ── Parse CSV ──
                // Template column order: VIN, Stock Number, Year, Make, Model, Miles, Appraisal Notes, Skip Steps
                for (const line of dataLines) {
                    const values       = line.split(',');
                    const vin          = values[0]?.trim().replace(/"/g, '').toUpperCase();
                    const stockNumber  = values[1]?.trim().replace(/"/g, '').toUpperCase();
                    const year         = values[2]?.trim().replace(/"/g, '') || '';
                    const make         = values[3]?.trim().replace(/"/g, '') || '';
                    const model        = values[4]?.trim().replace(/"/g, '') || '';
                    const miles        = parseInt(values[5]?.trim()) || 0;
                    const appraisalNotes = values[6]?.trim().replace(/"/g, '') || '';
                    const skipSteps    = values[7]?.trim().split(';').filter(s => s) || [];

                    vehiclesToImport.push({
                        location_id:     currentLocationId,
                        vin,
                        stock_number:    stockNumber,
                        year,
                        make,
                        model,
                        miles,
                        appraisal_notes: appraisalNotes,
                        entry_time:      new Date().toISOString(),
                        current_step:    'Awaiting Arrival',
                        step_start_time: new Date().toISOString(),
                        completed_steps: [],
                        assigned_tech:   null,
                        tags:            [],
                        vehicle_tags:    skipSteps.map(s => `Skip ${s}`),
                        workflow:        'AWAITING',
                        // keep for logging only — stripped before insert
                        _stockNumber: stockNumber
                    });
                }

                const total = vehiclesToImport.length;
                showImportDialog(total);
                updateImportDialog(0, 0, 0, total, `<span style="color:#63b3ed;">📄 Parsed ${total} rows from "${file.name}"</span>`);

                // Small delay so the dialog paints before heavy work
                await new Promise(r => setTimeout(r, 80));

                // ── Supabase path ──
                if (supabaseClient && vehiclesToImport.length > 0) {

                    // Step 1: find which stock numbers already exist in this location
                    const allStockNumbers = vehiclesToImport.map(v => v.stock_number);
                    const { data: existing } = await supabaseClient
                        .from('vehicles')
                        .select('id, stock_number')
                        .eq('location_id', currentLocationId)
                        .in('stock_number', allStockNumbers);

                    const existingMap = {};
                    if (existing) existing.forEach(r => { existingMap[r.stock_number] = r.id; });

                    const toInsert = vehiclesToImport.filter(v => !existingMap[v.stock_number]);
                    const toUpdate = vehiclesToImport.filter(v =>  existingMap[v.stock_number]);

                    updateImportDialog(0, 0, 0, total,
                        `<span style="color:#63b3ed;">📋 ${toInsert.length} new · ${toUpdate.length} to update</span>`);

                    // Step 2: update existing vehicles (year, make, model, miles only — VIN/stock locked)
                    for (const vehicle of toUpdate) {
                        const id = existingMap[vehicle.stock_number];
                        try {
                            const { error } = await supabaseClient
                                .from('vehicles')
                                .update({
                                    year:           vehicle.year  || undefined,
                                    make:           vehicle.make  || undefined,
                                    model:          vehicle.model || undefined,
                                    miles:          vehicle.miles || undefined
                                })
                                .eq('id', id);
                            if (error) throw new Error(error.message);
                            skippedCount++;  // reusing "skipped" counter as "updated" for display
                            updateImportDialog(importedCount, skippedCount, errorCount, total,
                                `<span style="color:#f6ad55;">↻ ${vehicle._stockNumber} — updated (year/make/model/miles)</span>`);
                        } catch (err) {
                            errorCount++;
                            updateImportDialog(importedCount, skippedCount, errorCount, total,
                                `<span style="color:#fc8181;">✗ ${vehicle._stockNumber} — ${err.message}</span>`);
                        }
                        await new Promise(r => setTimeout(r, 5));
                    }

                    // Step 3: batch insert new vehicles
                    const BATCH = 25;
                    for (let i = 0; i < toInsert.length; i += BATCH) {
                        const batch = toInsert.slice(i, i + BATCH);
                        const batchData = batch.map(({ _stockNumber, ...v }) => v);
                        try {
                            const { error } = await supabaseClient
                                .from('vehicles')
                                .insert(batchData);
                            if (error) {
                                if (error.code === '23505') {
                                    // Race condition — row appeared between check and insert, treat as update
                                    for (const v of batch) {
                                        errorCount++;
                                        updateImportDialog(importedCount, skippedCount, errorCount, total,
                                            `<span style="color:#fc8181;">✗ ${v._stockNumber} — conflict, skipped</span>`);
                                    }
                                } else {
                                    errorCount += batch.length;
                                    updateImportDialog(importedCount, skippedCount, errorCount, total,
                                        `<span style="color:#fc8181;">✗ Batch error — ${error.message}</span>`);
                                }
                            } else {
                                importedCount += batch.length;
                                const nums = batch.map(v => v._stockNumber).join(', ');
                                updateImportDialog(importedCount, skippedCount, errorCount, total,
                                    `<span style="color:#68d391;">✓ Added: ${nums}</span>`);
                            }
                        } catch (err) {
                            errorCount += batch.length;
                            updateImportDialog(importedCount, skippedCount, errorCount, total,
                                `<span style="color:#fc8181;">✗ Batch exception — ${err.message}</span>`);
                        }
                        await new Promise(r => setTimeout(r, 10));
                    }

                    updateImportDialog(importedCount, skippedCount, errorCount, total,
                        `<span style="color:#63b3ed;">🔄 Reloading data…</span>`);
                    await loadDataFromSupabase();
                    render();

                } else {
                    // ── Mock / offline path ──
                    for (const vehicle of vehiclesToImport) {
                        const existing = vehicles.find(v => v.stockNumber === vehicle.stock_number);
                        if (existing) {
                            // Update year/make/model/miles only — VIN and stock stay locked
                            if (vehicle.year)  existing.year  = vehicle.year;
                            if (vehicle.make)  existing.make  = vehicle.make;
                            if (vehicle.model) existing.model = vehicle.model;
                            if (vehicle.miles) existing.miles = vehicle.miles;
                            skippedCount++;
                            updateImportDialog(importedCount, skippedCount, errorCount, total,
                                `<span style="color:#f6ad55;">↻ ${vehicle._stockNumber} — updated (year/make/model/miles)</span>`);
                        } else {
                            vehicles.push({
                                vin:             vehicle.vin,
                                stockNumber:     vehicle.stock_number,
                                year:            vehicle.year,
                                make:            vehicle.make,
                                model:           vehicle.model,
                                miles:           vehicle.miles,
                                appraisalNotes:  vehicle.appraisal_notes,
                                entryTime:       new Date(),
                                currentStep:     'Awaiting Arrival',
                                stepStartTime:   new Date(),
                                completedSteps:  [],
                                skippedSteps:    vehicle.vehicle_tags.map(t => t.replace('Skip ', '')),
                                assignedTech:    'unassigned',
                                tags:            vehicle.vehicle_tags,
                                notes: '', photos: [], stepHistory: [],
                                workflow: 'AWAITING'
                            });
                            stockNumberRegistry.add(vehicle.stock_number);
                            importedCount++;
                            updateImportDialog(importedCount, skippedCount, errorCount, total,
                                `<span style="color:#68d391;">✓ ${vehicle._stockNumber}</span>`);
                        }
                        await new Promise(r => setTimeout(r, 5));
                    }
                    render();
                }

                event.target.value = ''; // Reset file input
                finishImportDialog(importedCount, skippedCount, errorCount, duplicates);
            };
            reader.readAsText(file);
        }

        // Notes and Photo Functions
        function addNoteToVehicle(vin, noteText) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            if (!noteText || !noteText.trim()) {
                alert('Please enter a note');
                return;
            }
            
            if (!vehicle.noteHistory) {
                vehicle.noteHistory = [];
            }
            
            const newNote = {
                text: noteText.trim(),
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            };
            
            vehicle.noteHistory.push(newNote);
            vehicle.notes = noteText.trim(); // Keep last note for backwards compatibility
            
            closeDialog();
            showVehicleDetails(vin);
            alert('✓ Note added to permanent history');
        }

        function saveVehicleNotes(vin, notes) {
            // Deprecated - redirecting to addNoteToVehicle
            addNoteToVehicle(vin, notes);
        }

        function handlePhotoUpload(vin, event) {
            const files = event.target.files;
            if (!files.length) return;

            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoFilename = `photo${vehicle.photos.length + 1}_${file.name.split('.')[0]}_${timestamp}.jpg`;
                    const filepath = savePhotoToFileSystem(vehicle, e.target.result, photoFilename);
                    
                    vehicle.photos.push({
                        name: file.name,
                        filename: photoFilename,
                        filepath: filepath,
                        data: e.target.result,
                        uploadedAt: new Date(),
                        uploadedBy: currentUser.name
                    });
                    render();
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = ''; // Reset file input
            alert(`✓ ${files.length} photo(s) uploaded to ${photosDirectory}/${vehicle.stockNumber}/`);
        }

        function viewVehicleHistory(stockNumber) {
            const current = vehicles.find(v => v.stockNumber === stockNumber);
            const history = vehicleHistory.filter(v => v.stockNumber === stockNumber);
            
            if (!current && history.length === 0) {
                alert('No history found for this stock number');
                return;
            }

            // Build complete timeline including notes
            let timeline = [];
            
            // Add current vehicle notes to timeline
            if (current && current.noteHistory && current.noteHistory.length > 0) {
                current.noteHistory.forEach(note => {
                    timeline.push({
                        type: 'note',
                        date: new Date(note.timestamp),
                        text: note.text,
                        user: note.user,
                        status: 'Current Vehicle'
                    });
                });
            }
            
            // Add entry event for current vehicle
            if (current) {
                timeline.push({
                    type: 'entry',
                    date: current.entryTime,
                    text: `Vehicle entered recon (${current.currentStep})`,
                    status: 'Current Vehicle'
                });
            }
            
            // Add historical visits
            history.forEach(h => {
                timeline.push({
                    type: 'completion',
                    date: h.completedDate,
                    text: `Recon completed (${h.totalReconTime})`,
                    vin: h.vin,
                    notes: h.notes,
                    status: 'Historical Visit'
                });
                
                // Add historical notes if they exist
                if (h.noteHistory && h.noteHistory.length > 0) {
                    h.noteHistory.forEach(note => {
                        timeline.push({
                            type: 'note',
                            date: new Date(note.timestamp),
                            text: note.text,
                            user: note.user,
                            status: 'Historical Visit'
                        });
                    });
                }
            });
            
            // Sort timeline by date (newest first)
            timeline.sort((a, b) => b.date - a.date);

            let historyHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 10px; overflow-y: auto;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 900px; width: 100%; margin: auto;">
                        <h2 style="margin-bottom: 15px;">5-Year Vehicle History - Stock #${stockNumber}</h2>
                        
                        ${current ? `
                            <div style="margin-bottom: 20px; padding: 15px; background: #e6ffed; border-radius: 4px;">
                                <strong>Current Status:</strong> In ${current.currentStep}<br>
                                <strong>Entry Date:</strong> ${current.entryTime.toLocaleDateString()}<br>
                                <strong>Total Time:</strong> ${formatTimeDiff(current.entryTime)}<br>
                                <strong>Notes in History:</strong> ${(current.noteHistory || []).length}
                            </div>
                        ` : ''}
                        
                        ${timeline.length > 0 ? `
                            <h3 style="margin: 15px 0 10px 0; font-size: 16px;">Timeline:</h3>
                            <div style="position: relative; padding-left: 30px; border-left: 3px solid #e2e8f0; margin-left: 10px;">
                                ${timeline.map((event, idx) => {
                                    const bgColor = event.status === 'Current Vehicle' ? '#ebf8ff' : '#f7fafc';
                                    const borderColor = event.type === 'note' ? '#4299e1' : event.type === 'entry' ? '#48bb78' : '#805ad5';
                                    const icon = event.type === 'note' ? '📝' : event.type === 'entry' ? '🚗' : '✅';
                                    
                                    return `
                                        <div style="position: relative; margin-bottom: 12px; padding: 12px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 4px;">
                                            <div style="position: absolute; left: -42px; top: 12px; width: 24px; height: 24px; background: white; border: 3px solid ${borderColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                ${icon}
                                            </div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">
                                                <strong>${event.date.toLocaleDateString()}</strong> ${event.date.toLocaleTimeString()} 
                                                <span style="margin-left: 10px; padding: 2px 6px; background: ${event.status === 'Current Vehicle' ? '#bee3f8' : '#e2e8f0'}; border-radius: 3px; font-size: 11px;">
                                                    ${event.status}
                                                </span>
                                            </div>
                                            ${event.type === 'note' ? `
                                                <div style="color: #2d3748; font-size: 13px; margin-bottom: 2px;">${event.text}</div>
                                                <div style="font-size: 11px; color: #a0aec0;">by ${event.user}</div>
                                            ` : `
                                                <div style="color: #2d3748; font-size: 13px;">${event.text}</div>
                                                ${event.vin ? `<div style="font-size: 11px; color: #718096; margin-top: 4px;">VIN: ${event.vin}</div>` : ''}
                                                ${event.notes ? `<div style="font-size: 12px; color: #4a5568; margin-top: 6px; padding: 6px; background: white; border-radius: 3px;"><strong>Note:</strong> ${event.notes}</div>` : ''}
                                            `}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p style="color: #718096; margin: 20px 0;">No timeline events</p>'}
                        
                        <button class="btn" onclick="closeDialog()" style="width: 100%; margin-top: 15px;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', historyHTML);
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            
            // Initialize technician status tracking
            initTechnicianStatus();
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
                return;
            }

            let tabs = '';
            if (isAdmin() || currentUser.role === 'superadmin') {
                tabs = `
                    <div class="tabs" style="justify-content:space-between;align-items:center;">
                        <div style="display:flex;gap:5px;flex-wrap:wrap;">
                            <button class="tab ${currentView === 'dashboard' ? 'active' : ''}" onclick="switchView('dashboard')">Dashboard</button>
                            <button class="tab ${currentView === 'admin' ? 'active' : ''}" onclick="switchView('admin')">Admin Panel</button>
                            <button class="tab ${currentView === 'reporting' ? 'active' : ''}" onclick="switchView('reporting')">Reports</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-left:10px;">
                            <div style="position:relative;display:flex;align-items:center;">
                                <span style="position:absolute;left:10px;color:#a0aec0;font-size:14px;pointer-events:none;">🔍</span>
                                <input id="globalSearch" type="text" placeholder="Search vehicles… (Enter)"
                                    onkeydown="if(event.key==='Enter' && this.value.trim()) runGlobalSearch(this.value)"
                                    style="padding:7px 12px 7px 32px;border:2px solid #cbd5e0;border-radius:6px;font-size:13px;outline:none;width:220px;transition:border-color 0.2s;"
                                    onfocus="this.style.borderColor='#4299e1'"
                                    onblur="this.style.borderColor='#cbd5e0'"
                                >
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentUser.role === 'technician') {
                tabs = `
                    <div class="tabs">
                        <button class="tab active">My Assignment</button>
                    </div>
                `;
            }

            let content = '';
            switch(currentView) {
                case 'dashboard':
                    content = renderDashboard();
                    break;
                case 'technician':
                    content = renderTechnicianView();
                    break;
                case 'admin':
                    content = renderAdminPanel();
                    break;
                case 'reporting':
                    content = renderReporting();
                    break;
            }

            app.innerHTML = `
                <div class="container">
                    ${renderHeader()}
                    ${tabs}
                    ${content}
                </div>
            `;
            // Inject floating scan FAB after each render
            injectScanButton();
        }

        // ==================== FILE-BASED STORAGE SYSTEM ====================
        
        // Configuration
        const SAVE_FILE_NAME = 'recon-system-data.json';
        
        function saveToFile() {
            try {
                const data = {
                    vehicles: vehicles.map(v => ({
                        ...v,
                        entryTime: v.entryTime.toISOString(),
                        stepStartTime: v.stepStartTime.toISOString()
                    })),
                    workflows: workflows,
                    STEPS: STEPS,
                    technicians: technicians,
                    substeps: substeps,
                    stepThresholds: stepThresholds,
                    tagDefinitions: tagDefinitions,
                    stockNumberRegistry: Array.from(stockNumberRegistry),
                    vehicleHistory: vehicleHistory.map(v => ({
                        ...v,
                        completedDate: v.completedDate.toISOString()
                    })),
                    stepDependencies: stepDependencies,
                    reassignableLocks: Array.from(reassignableLocks),
                    lastSaved: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = SAVE_FILE_NAME;
                link.click();
                URL.revokeObjectURL(url);
                
                console.log('✓ Data saved to file');
                return true;
            } catch (error) {
                console.error('Error saving to file:', error);
                return false;
            }
        }

        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Restore vehicles with date conversion
                    vehicles = data.vehicles.map(v => ({
                        ...v,
                        entryTime: new Date(v.entryTime),
                        stepStartTime: new Date(v.stepStartTime),
                        noteHistory: (v.noteHistory || []).map(note => ({
                            ...note,
                            timestamp: new Date(note.timestamp)
                        }))
                    }));
                    
                    // Restore other data
                    if (data.workflows) workflows = data.workflows;
                    if (data.STEPS) STEPS = data.STEPS;
                    if (data.technicians) technicians = data.technicians;
                    if (data.substeps) substeps = data.substeps;
                    if (data.stepThresholds) stepThresholds = data.stepThresholds;
                    if (data.tagDefinitions) tagDefinitions = data.tagDefinitions;
                    if (data.stockNumberRegistry) stockNumberRegistry = new Set(data.stockNumberRegistry);
                    if (data.stepDependencies) stepDependencies = data.stepDependencies;
                    if (data.reassignableLocks) reassignableLocks = new Set(data.reassignableLocks);
                    if (data.vehicleHistory) {
                        vehicleHistory = data.vehicleHistory.map(v => ({
                            ...v,
                            completedDate: new Date(v.completedDate),
                            noteHistory: (v.noteHistory || []).map(note => ({
                                ...note,
                                timestamp: new Date(note.timestamp)
                            }))
                        }));
                    }
                    
                    render();
                    alert(`✓ Data loaded successfully!\n\nLast saved: ${new Date(data.lastSaved).toLocaleString()}`);
                    console.log(`✓ Data loaded from file (last saved: ${data.lastSaved})`);
                } catch (error) {
                    alert('❌ Error loading data: ' + error.message);
                    console.error('Error loading from file:', error);
                }
            };
            reader.readAsText(file);
        }

        // Manual save function
        function saveChanges() {
            const success = saveToFile();
            if (success) {
                alert('✓ Data saved to file!\n\nThe file "' + SAVE_FILE_NAME + '" has been downloaded to your Downloads folder.');
            } else {
                alert('❌ Error saving data. Check console for details.');
            }
        }

        // Clear all data function for debugging
        function clearAllData() {
            if (confirm('⚠️ This will reset to sample data. Make sure you have saved your data file first!\n\nAre you sure?')) {
                alert('Data reset! Please save a new file or load an existing one.');
                location.reload();
            }
        }

        // Export data as JSON file (same as save, but with custom name)
        function exportData() {
            try {
                const data = {
                    vehicles: vehicles.map(v => ({
                        ...v,
                        entryTime: v.entryTime.toISOString(),
                        stepStartTime: v.stepStartTime.toISOString()
                    })),
                    workflows: workflows,
                    STEPS: STEPS,
                    technicians: technicians,
                    substeps: substeps,
                    stepPrerequisites: stepPrerequisites,
                    stepThresholds: stepThresholds,
                    tagDefinitions: tagDefinitions,
                    stockNumberRegistry: Array.from(stockNumberRegistry),
                    vehicleHistory: vehicleHistory.map(v => ({
                        ...v,
                        completedDate: v.completedDate.toISOString()
                    })),
                    stepDependencies: stepDependencies,
                    reassignableLocks: Array.from(reassignableLocks),
                    lastSaved: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `recon-backup-${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('✓ Backup file created!');
            } catch (error) {
                alert('❌ Error creating backup: ' + error.message);
            }
        }

        // Import data from JSON file
        function importData(event) {
            loadFromFile(event);
        }

        // Expose utility functions to window for console access
        window.saveChanges = saveChanges;
        window.clearAllData = clearAllData;
        window.exportData = exportData;

        // ==================== GLOBAL SEARCH ====================

        function runGlobalSearch(query) {
            const q = (query || '').trim().toLowerCase();
            if (!q) return;

            const matches = vehicles.filter(v =>
                (v.vin         || '').toLowerCase().includes(q) ||
                (v.stockNumber || v.stock_number || '').toLowerCase().includes(q) ||
                (v.make        || '').toLowerCase().includes(q) ||
                (v.model       || '').toLowerCase().includes(q) ||
                (v.year        || '').toString().includes(q) ||
                ((v.year||'') + ' ' + (v.make||'') + ' ' + (v.model||'')).toLowerCase().includes(q)
            );

            const stepColor = s => (!s || s === 'Awaiting Arrival') ? '#a0aec0' : s === 'Finished' ? '#48bb78' : '#4299e1';

            function hl(text) {
                if (!text) return '—';
                const str = String(text);
                const idx = str.toLowerCase().indexOf(q);
                if (idx === -1) return str;
                return str.slice(0, idx)
                    + '<mark style="background:#fef08a;padding:0 2px;border-radius:2px;">'
                    + str.slice(idx, idx + q.length) + '</mark>'
                    + str.slice(idx + q.length);
            }

            // Remove existing modal if any
            const existing = document.getElementById('searchModal');
            if (existing) existing.remove();

            const rows = matches.length === 0
                ? '<div style="padding:40px;text-align:center;color:#718096;">No vehicles found for <strong>&quot;' + query + '&quot;</strong></div>'
                : matches.map(v => {
                    const stock = v.stockNumber || v.stock_number || '—';
                    const vin   = v.vin || '—';
                    const ymm   = [v.year, v.make, v.model].filter(Boolean).join(' ') || '—';
                    const step  = v.currentStep || v.current_step || 'Unknown';
                    const tech  = v.assignedTech || v.assigned_tech;
                    const miles = v.miles ? v.miles.toLocaleString() + ' mi' : '';
                    const color = stepColor(step);
                    const safeVin = vin.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
                    return '<tr onclick="closeSearchModal();openSearchResult(\'' + safeVin + '\')"'
                        + ' style="cursor:pointer;border-bottom:1px solid #f0f4f8;transition:background 0.12s;"'
                        + ' onmouseenter="this.style.background=\'#ebf8ff\'" onmouseleave="this.style.background=\'\'">'
                        + '<td style="padding:10px 14px;font-weight:600;font-size:13px;">' + hl(ymm) + '</td>'
                        + '<td style="padding:10px 8px;font-family:monospace;font-size:12px;color:#4a5568;">' + hl(stock) + '</td>'
                        + '<td style="padding:10px 8px;font-family:monospace;font-size:11px;color:#718096;">' + hl(vin) + '</td>'
                        + '<td style="padding:10px 8px;font-size:12px;color:#718096;">' + (miles || '—') + '</td>'
                        + '<td style="padding:10px 8px;font-size:12px;color:#4299e1;">' + (tech || '—') + '</td>'
                        + '<td style="padding:10px 14px;">'
                        + '<span style="padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;white-space:nowrap;'
                        + 'background:' + color + '22;color:' + color + ';">' + step + '</span>'
                        + '</td></tr>';
                }).join('');

            const count = matches.length;
            const modal = document.createElement('div');
            modal.id = 'searchModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);z-index:2000;display:flex;align-items:flex-start;justify-content:center;padding:60px 20px 20px;';
            modal.innerHTML =
                '<div style="background:white;border-radius:12px;width:100%;max-width:900px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);">'
                + '<div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:2px solid #e2e8f0;flex-shrink:0;">'
                + '<div style="display:flex;align-items:center;gap:12px;flex:1;">'
                + '<span style="font-size:18px;">🔍</span>'
                + '<input id="searchModalInput" type="text" value="' + query.replace(/"/g,'&quot;') + '"'
                + ' placeholder="Search VIN, stock, make, model, year…"'
                + ' onkeydown="if(event.key===\'Enter\') runGlobalSearch(this.value); if(event.key===\'Escape\') closeSearchModal();"'
                + ' style="flex:1;border:none;outline:none;font-size:16px;font-weight:500;">'
                + '<span style="font-size:13px;color:#718096;white-space:nowrap;">' + count + ' result' + (count !== 1 ? 's' : '') + '</span>'
                + '</div>'
                + '<button onclick="closeSearchModal()" style="margin-left:16px;background:#f0f4f8;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:13px;color:#4a5568;">✕ Close</button>'
                + '</div>'
                + '<div style="overflow-y:auto;flex:1;">'
                + (matches.length > 0
                    ? '<table style="width:100%;border-collapse:collapse;">'
                      + '<thead><tr style="background:#f7fafc;font-size:11px;color:#718096;text-transform:uppercase;letter-spacing:0.05em;">'
                      + '<th style="padding:8px 14px;text-align:left;font-weight:600;">Vehicle</th>'
                      + '<th style="padding:8px 8px;text-align:left;font-weight:600;">Stock #</th>'
                      + '<th style="padding:8px 8px;text-align:left;font-weight:600;">VIN</th>'
                      + '<th style="padding:8px 8px;text-align:left;font-weight:600;">Miles</th>'
                      + '<th style="padding:8px 8px;text-align:left;font-weight:600;">Tech</th>'
                      + '<th style="padding:8px 14px;text-align:left;font-weight:600;">Step</th>'
                      + '</tr></thead><tbody>' + rows + '</tbody></table>'
                    : rows)
                + '</div>'
                + '<div style="padding:10px 20px;border-top:1px solid #e2e8f0;font-size:11px;color:#a0aec0;flex-shrink:0;">Press Enter to search · Esc to close · Click a row to open vehicle</div>'
                + '</div>';

            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) closeSearchModal(); });

            // Focus the modal input and select all
            setTimeout(() => {
                const mi = document.getElementById('searchModalInput');
                if (mi) { mi.focus(); mi.select(); }
            }, 30);
        }

        function closeSearchModal() {
            const m = document.getElementById('searchModal');
            if (m) m.remove();
        }

        function openSearchResult(vin) {
            closeSearchModal();
            if (currentView !== 'dashboard') {
                currentView = 'dashboard';
                render();
                setTimeout(() => showVehicleDetails(vin), 50);
            } else {
                showVehicleDetails(vin);
            }
        }

        // ==================== END GLOBAL SEARCH ====================

        // Initialize - check for existing session
        async function init() {
            if (USE_SUPABASE && supabaseClient) {
                // --- Browser-close detection ---
                // sessionStorage is cleared when the browser is fully closed (not on refresh).
                // If 'recon_session_alive' is missing, the browser was closed, so we sign out.
                const sessionAlive = sessionStorage.getItem('recon_session_alive');
                if (!sessionAlive) {
                    // New browser session — sign out any lingering Supabase token
                    console.log('🔒 New browser session detected — requiring login');
                    await supabaseClient.auth.signOut();
                }
                // Mark this tab as alive for the duration of the browser session
                sessionStorage.setItem('recon_session_alive', '1');

                // Show a brief loading state so the user sees something on refresh
                document.getElementById('app').innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f7fafc;">
                        <div style="font-size:40px;margin-bottom:16px;animation:arSpin 1s linear infinite;display:inline-block;">🔄</div>
                        <div style="font-size:16px;font-weight:600;color:#4a5568;">Restoring session…</div>
                    </div>
                    <style>@keyframes arSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>
                `;
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    console.log('📌 Existing session found — restoring');
                    await loadUserProfileFromSupabase(session.user.id);
                    resetInactivityTimer();
                    return; // loadUserProfileFromSupabase calls render() at the end
                }
            }
            render(); // no session — show login
        }

        // ==================== VIN / QR SCANNER ====================

        // ---- In-memory vehicle cache (built once on load, no Supabase per scan) ----
        let scanCache      = [];
        let scanCacheReady = false;

        function buildScanCache() {
            scanCache = vehicles.map(v => ({
                vin:          (v.vin || '').toUpperCase(),
                stockNumber:  (v.stockNumber || v.stock_number || '').toUpperCase(),
                year:         v.year  || '',
                make:         v.make  || '',
                model:        v.model || '',
                currentStep:  v.currentStep  || v.current_step  || '',
                completedSteps: v.completedSteps || [],
                skippedSteps:   v.skippedSteps   || [],
                assignedTech:   v.assignedTech   || v.assigned_tech || '',
                workflow:     v.workflow  || '',
                stepStartTime: v.stepStartTime,
                entryTime:    v.entryTime,
                tags:         v.tags || []
            }));
            scanCacheReady = true;
            console.log('📦 Scan cache:', scanCache.length, 'vehicles');
        }

        function lookupInCache(query) {
            const q = query.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (!q) return null;
            return scanCache.find(v =>
                v.vin === q ||
                v.stockNumber === q ||
                v.vin.includes(q) ||
                v.stockNumber.includes(q)
            ) || null;
        }

        // ---- Web Audio beep (no CDN) ----
        let _audioCtx = null;
        function playScanBeep(success) {
            try {
                if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = _audioCtx;
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const g   = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                if (success) {
                    osc.frequency.setValueAtTime(880,  ctx.currentTime);
                    osc.frequency.setValueAtTime(1320, ctx.currentTime + 0.09);
                    g.gain.setValueAtTime(0.3, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
                    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.25);
                } else {
                    osc.frequency.setValueAtTime(200, ctx.currentTime);
                    g.gain.setValueAtTime(0.25, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
                    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.35);
                }
            } catch(e) {}
        }

        // ---- Scanner state ----
        let scannerStream   = null;
        let scannerInterval = null;   // setInterval handle (not rAF — async-safe)
        let scannerActive   = false;
        let torchOn         = false;
        let torchTrack      = null;
        let _detector       = null;
        let _detectorReady  = false;

        async function initDetector() {
            if (_detectorReady) return;
            _detectorReady = true;
            if (typeof BarcodeDetector === 'undefined') {
                console.log('BarcodeDetector: not supported on this browser');
                return;
            }
            try {
                const supported = await BarcodeDetector.getSupportedFormats();
                const wanted = ['qr_code','code_128','code_39','ean_13','ean_8','itf','aztec','data_matrix','pdf417','upc_a','upc_e'];
                const formats = supported.filter(f => wanted.includes(f));
                _detector = new BarcodeDetector({ formats: formats.length ? formats : supported });
                console.log('BarcodeDetector ready, formats:', formats);
            } catch(e) {
                console.warn('BarcodeDetector init error:', e);
                _detector = null;
            }
        }

        // ---- Scanner UI ----
        function openVinScanner() {
            if (!currentUser) return;
            const existing = document.getElementById('vinScannerModal');
            if (existing) existing.remove();
            torchOn = false;

            // Inject CSS once
            if (!document.getElementById('scannerCSS')) {
                const s = document.createElement('style');
                s.id = 'scannerCSS';
                s.textContent = `
                    @keyframes scanBeam {
                        0%   { top:4px;  opacity:0.4; }
                        50%  { top:76px; opacity:1;   }
                        100% { top:4px;  opacity:0.4; }
                    }
                    @keyframes scanPulse {
                        0%,100% { box-shadow: 0 0 0 0 rgba(99,179,237,0); }
                        50%     { box-shadow: 0 0 0 6px rgba(99,179,237,0.35); }
                    }
                    @keyframes vinSlideUp {
                        from { transform:translateY(100%); opacity:0; }
                        to   { transform:translateY(0);    opacity:1; }
                    }
                    .scan-corner { position:absolute; width:26px; height:26px; }
                    .scan-corner.tl { top:0; left:0;  border-top:3px solid #63b3ed; border-left:3px solid #63b3ed;  border-radius:5px 0 0 0; }
                    .scan-corner.tr { top:0; right:0; border-top:3px solid #63b3ed; border-right:3px solid #63b3ed; border-radius:0 5px 0 0; }
                    .scan-corner.bl { bottom:0; left:0;  border-bottom:3px solid #63b3ed; border-left:3px solid #63b3ed;  border-radius:0 0 0 5px; }
                    .scan-corner.br { bottom:0; right:0; border-bottom:3px solid #63b3ed; border-right:3px solid #63b3ed; border-radius:0 0 5px 0; }
                    #scanBeamLine {
                        position:absolute; left:10px; right:10px; height:2px;
                        background:linear-gradient(90deg, transparent 0%, #63b3ed 30%, #90cdf4 50%, #63b3ed 70%, transparent 100%);
                        animation: scanBeam 2s ease-in-out infinite;
                        border-radius:1px;
                    }
                    #scanZone {
                        position:relative; width:85%; max-width:340px; height:86px;
                        animation: scanPulse 2s ease-in-out infinite;
                        border-radius:8px;
                    }
                    #torchBtn.lit {
                        background:rgba(255,220,50,0.25) !important;
                        border-color:rgba(255,220,50,0.8) !important;
                        box-shadow:0 0 14px rgba(255,220,50,0.5) !important;
                    }
                    #vinScannerVideo { width:100%; height:100%; object-fit:cover; display:block; }
                `;
                document.head.appendChild(s);
            }

            const modal = document.createElement('div');
            modal.id = 'vinScannerModal';
            modal.style.cssText = 'position:fixed;inset:0;background:#000;z-index:5000;display:flex;flex-direction:column;align-items:center;';

            const cacheLabel = scanCacheReady
                ? `📦 ${scanCache.length} vehicles ready`
                : '⏳ Loading inventory…';

            modal.innerHTML = `
                <div style="width:100%;max-width:480px;height:100%;display:flex;flex-direction:column;">

                    <!-- Header bar -->
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(0,0,0,0.85);flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.08);">
                        <div>
                            <div style="color:#fff;font-size:16px;font-weight:700;letter-spacing:-0.2px;">📷 VIN Scanner</div>
                            <div style="color:#718096;font-size:11px;margin-top:1px;">Point camera at barcode or QR code</div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button id="torchBtn" onclick="toggleTorch()" title="Flashlight"
                                style="background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.12);color:white;
                                       width:40px;height:40px;border-radius:50%;font-size:18px;cursor:pointer;
                                       display:flex;align-items:center;justify-content:center;transition:all 0.2s;">
                                🔦
                            </button>
                            <button onclick="closeVinScanner()"
                                style="background:rgba(255,255,255,0.08);border:none;color:white;
                                       width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer;
                                       display:flex;align-items:center;justify-content:center;">✕</button>
                        </div>
                    </div>

                    <!-- Camera -->
                    <div style="position:relative;flex:1;min-height:0;background:#111;overflow:hidden;">
                        <video id="vinScannerVideo" autoplay playsinline muted></video>

                        <!-- Darkened overlay with cutout effect -->
                        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
                            <!-- dim top -->
                            <div style="flex:1;width:100%;background:rgba(0,0,0,0.45);"></div>
                            <!-- middle row: dim | scan zone | dim -->
                            <div style="display:flex;align-items:stretch;width:100%;">
                                <div style="flex:1;background:rgba(0,0,0,0.45);"></div>
                                <!-- THE SCAN ZONE -->
                                <div id="scanZone">
                                    <div class="scan-corner tl"></div>
                                    <div class="scan-corner tr"></div>
                                    <div class="scan-corner bl"></div>
                                    <div class="scan-corner br"></div>
                                    <div id="scanBeamLine"></div>
                                </div>
                                <div style="flex:1;background:rgba(0,0,0,0.45);"></div>
                            </div>
                            <!-- hint text -->
                            <div style="padding:10px 20px;background:rgba(0,0,0,0.45);width:100%;text-align:center;">
                                <div style="color:rgba(255,255,255,0.6);font-size:12px;">Center the VIN barcode or QR code in the frame</div>
                            </div>
                            <!-- dim bottom -->
                            <div style="flex:1;width:100%;background:rgba(0,0,0,0.45);"></div>
                        </div>

                        <!-- Status chip -->
                        <div id="scanChip" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
                            background:rgba(66,153,225,0.92);color:white;padding:5px 16px;
                            border-radius:20px;font-size:12px;font-weight:700;white-space:nowrap;
                            backdrop-filter:blur(6px);box-shadow:0 2px 8px rgba(0,0,0,0.3);">
                            🔍 Ready to scan…
                        </div>

                        <!-- Cache pill -->
                        <div style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
                            background:rgba(0,0,0,0.6);color:#a0aec0;padding:3px 12px;
                            border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap;">
                            ${cacheLabel}
                        </div>
                    </div>

                    <!-- Manual fallback -->
                    <div style="padding:14px 16px 20px;background:rgba(0,0,0,0.9);flex-shrink:0;">
                        <div style="color:#4a5568;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">
                            Manual entry
                        </div>
                        <div style="display:flex;gap:8px;">
                            <input id="vinManualInput" type="text" placeholder="VIN or Stock #"
                                style="flex:1;padding:10px 13px;background:rgba(255,255,255,0.07);
                                       border:1px solid rgba(255,255,255,0.12);border-radius:8px;
                                       color:white;font-size:14px;outline:none;"
                                onkeydown="if(event.key==='Enter') lookupVinManual()">
                            <button onclick="lookupVinManual()"
                                style="background:#4299e1;color:white;border:none;border-radius:8px;
                                       padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;">
                                Go
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            startScannerCamera();
        }

        async function startScannerCamera() {
            scannerActive = true;
            torchTrack    = null;
            const video = document.getElementById('vinScannerVideo');
            const chip  = document.getElementById('scanChip');

            // Pre-init detector while camera starts
            initDetector();

            try {
                scannerStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' },
                        width:  { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                video.srcObject = scannerStream;
                await video.play();

                // Torch capability
                const tracks = scannerStream.getVideoTracks();
                if (tracks.length) {
                    torchTrack = tracks[0];
                    const caps = torchTrack.getCapabilities ? torchTrack.getCapabilities() : {};
                    const btn  = document.getElementById('torchBtn');
                    if (btn) btn.style.display = caps.torch ? 'flex' : 'none';
                }

                if (chip) chip.textContent = '🔍 Scanning…';

                // Use setInterval instead of rAF — safer for async BarcodeDetector
                scannerInterval = setInterval(runScanTick, 200); // 5fps is plenty

            } catch(err) {
                console.warn('Camera error:', err);
                if (chip) {
                    chip.style.background = 'rgba(229,62,62,0.9)';
                    chip.textContent = '📵 No camera — use manual entry';
                }
            }
        }

        async function runScanTick() {
            if (!scannerActive) return;
            const video = document.getElementById('vinScannerVideo');
            if (!video || video.readyState < 2 || video.videoWidth === 0) return;

            // Wait for detector to be ready
            if (!_detectorReady) return;

            if (!_detector) {
                // BarcodeDetector not supported on this browser
                const chip = document.getElementById('scanChip');
                if (chip && chip.textContent.includes('Scanning')) {
                    chip.style.background = 'rgba(113,128,150,0.9)';
                    chip.textContent = '⌨️ Camera active — use manual entry';
                }
                return;
            }

            try {
                const results = await _detector.detect(video);
                if (results && results.length > 0) {
                    const raw = results[0].rawValue;
                    if (raw && raw.trim().length >= 4) {
                        handleScanResult(raw.trim());
                    }
                }
            } catch(e) {
                // Frame decode error — just skip this tick
            }
        }

        async function toggleTorch() {
            if (!torchTrack) return;
            try {
                torchOn = !torchOn;
                await torchTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
                const btn = document.getElementById('torchBtn');
                if (btn) {
                    btn.classList.toggle('lit', torchOn);
                    btn.title = torchOn ? 'Turn flashlight off' : 'Turn flashlight on';
                }
            } catch(e) {
                console.warn('Torch error:', e);
                torchOn = !torchOn; // revert
            }
        }

        function handleScanResult(raw) {
            if (!scannerActive) return;
            scannerActive = false;

            clearInterval(scannerInterval);
            scannerInterval = null;

            // Turn off torch
            if (torchOn && torchTrack) {
                try { torchTrack.applyConstraints({ advanced: [{ torch: false }] }); } catch(e) {}
                torchOn = false;
            }
            if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }

            const cleaned = raw.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            const hit = lookupInCache(cleaned);

            // Visual flash
            const chip = document.getElementById('scanChip');
            if (chip) {
                chip.style.background = hit ? 'rgba(72,187,120,0.95)' : 'rgba(229,62,62,0.92)';
                chip.textContent = hit ? '✅ Found!' : '🚫 Not in recon';
            }

            // Sound + haptic
            playScanBeep(!!hit);
            if (navigator.vibrate) navigator.vibrate(hit ? [60,30,60] : [180]);

            setTimeout(() => {
                closeVinScanner();
                showVinResult(cleaned, raw, hit);
            }, 550);
        }

        function lookupVinManual() {
            const input = document.getElementById('vinManualInput');
            const val   = (input?.value || '').trim();
            if (!val) return;
            const cleaned = val.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            const hit = lookupInCache(cleaned);
            try { if (_audioCtx && _audioCtx.state === 'suspended') _audioCtx.resume(); } catch(e) {}
            playScanBeep(!!hit);
            closeVinScanner();
            showVinResult(cleaned, val, hit);
        }

        function showVinResult(query, rawInput, cachedVehicle) {
            // Resolve full vehicle: use cache hit first, then scan live array
            const vehicle = cachedVehicle ? (
                vehicles.find(v =>
                    (v.vin||'').toUpperCase()         === cachedVehicle.vin ||
                    (v.stockNumber||'').toUpperCase() === cachedVehicle.stockNumber
                ) || cachedVehicle
            ) : (() => {
                const q = query.toLowerCase();
                return vehicles.find(v =>
                    (v.vin||'').toLowerCase() === q ||
                    (v.stockNumber||v.stock_number||'').toLowerCase() === q ||
                    (v.vin||'').toLowerCase().includes(q) ||
                    (v.stockNumber||v.stock_number||'').toLowerCase().includes(q)
                );
            })();

            const existing = document.getElementById('vinResultModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'vinResultModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:5000;display:flex;align-items:flex-end;justify-content:center;';
            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });

            if (!vehicle) {
                modal.innerHTML = `
                    <div style="background:white;width:100%;max-width:480px;border-radius:22px 22px 0 0;
                                padding:28px 22px 44px;animation:vinSlideUp 0.3s ease;">
                        <div style="text-align:center;margin-bottom:22px;">
                            <div style="font-size:52px;margin-bottom:10px;">🚫</div>
                            <div style="font-size:21px;font-weight:800;color:#1a202c;margin-bottom:5px;">Not in Recon</div>
                            <div style="font-size:14px;color:#718096;">Vehicle not found in the recon system.</div>
                        </div>
                        <div style="background:#f7fafc;border-radius:10px;padding:13px 15px;margin-bottom:18px;border:1px solid #e2e8f0;">
                            <div style="font-size:10px;color:#a0aec0;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:3px;">Scanned</div>
                            <div style="font-family:monospace;font-size:14px;color:#4a5568;word-break:break-all;">${rawInput}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            <button onclick="document.getElementById('vinResultModal').remove();openVinScanner();"
                                style="padding:13px;background:#4299e1;color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;">
                                🔄 Scan Again
                            </button>
                            <button onclick="document.getElementById('vinResultModal').remove();"
                                style="padding:13px;background:#edf2f7;color:#4a5568;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">
                                Close
                            </button>
                        </div>
                    </div>`;
            } else {
                const wf        = workflows[vehicle.workflow] || workflows[Object.keys(workflows)[0]];
                const wfSteps   = (wf ? wf.steps : STEPS).filter(s => s !== 'Awaiting Arrival');
                const total     = wfSteps.length;
                const done      = (vehicle.completedSteps || []).filter(s => wfSteps.includes(s)).length;
                const pct       = total > 0 ? Math.round((done / total) * 100) : 0;
                const finished  = vehicle.currentStep === 'Finished';
                const barColor  = finished ? '#48bb78' : '#4299e1';
                const stepLabel = finished ? 'Finished ✅' : vehicle.currentStep;

                const pipeline = wfSteps.map((step, i) => {
                    const isDone    = (vehicle.completedSteps || []).includes(step);
                    const isCurrent = vehicle.currentStep === step;
                    const bg  = isDone ? '#48bb78' : isCurrent ? '#4299e1' : '#e2e8f0';
                    const fg  = isDone || isCurrent ? 'white' : '#a0aec0';
                    const ico = isDone ? '✓' : isCurrent ? '▶' : (i + 1);
                    const lbl = step.length > 9 ? step.slice(0,8)+'…' : step;
                    return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;min-width:44px;">
                        <div style="width:30px;height:30px;border-radius:50%;background:${bg};color:${fg};
                                    display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${ico}</div>
                        <div style="font-size:9px;color:${isCurrent?'#2b6cb0':isDone?'#276749':'#a0aec0'};
                                    font-weight:${isCurrent?700:500};text-align:center;line-height:1.2;">${lbl}</div>
                    </div>`;
                }).join('');

                modal.innerHTML = `
                    <div style="background:white;width:100%;max-width:480px;border-radius:22px 22px 0 0;
                                overflow:hidden;animation:vinSlideUp 0.3s ease;">
                        <!-- color header -->
                        <div style="background:${barColor};padding:18px 20px 14px;color:white;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div>
                                    <div style="font-size:19px;font-weight:800;letter-spacing:-0.3px;">
                                        ${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}
                                    </div>
                                    <div style="font-size:12px;opacity:0.85;margin-top:2px;">
                                        Stock: ${vehicle.stockNumber||vehicle.stock_number||'—'}
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:10px;opacity:0.7;text-transform:uppercase;letter-spacing:0.05em;">Current Step</div>
                                    <div style="font-size:15px;font-weight:800;">${stepLabel}</div>
                                </div>
                            </div>
                        </div>

                        <div style="padding:18px 20px;max-height:55vh;overflow-y:auto;-webkit-overflow-scrolling:touch;">
                            <!-- progress bar -->
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                <div style="font-size:13px;font-weight:700;color:#2d3748;">Recon Progress</div>
                                <div style="font-size:13px;font-weight:700;color:${barColor};">${done}/${total} · ${pct}%</div>
                            </div>
                            <div style="background:#e2e8f0;border-radius:20px;height:7px;overflow:hidden;margin-bottom:16px;">
                                <div style="background:${barColor};height:100%;width:${pct}%;border-radius:20px;transition:width 0.4s;"></div>
                            </div>

                            <!-- step pipeline -->
                            <div style="font-size:10px;color:#a0aec0;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">
                                Pipeline
                            </div>
                            <div style="display:flex;gap:3px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none;-webkit-overflow-scrolling:touch;">
                                ${pipeline}
                            </div>

                            <!-- details -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;
                                        background:#f7fafc;border-radius:10px;padding:12px 14px;">
                                <div>
                                    <div style="font-size:10px;color:#a0aec0;font-weight:600;text-transform:uppercase;margin-bottom:2px;">Tech</div>
                                    <div style="font-size:13px;font-weight:600;color:#2d3748;">${vehicle.assignedTech||'Unassigned'}</div>
                                </div>
                                <div>
                                    <div style="font-size:10px;color:#a0aec0;font-weight:600;text-transform:uppercase;margin-bottom:2px;">Workflow</div>
                                    <div style="font-size:13px;font-weight:600;color:#2d3748;">${vehicle.workflow||'—'}</div>
                                </div>
                                <div>
                                    <div style="font-size:10px;color:#a0aec0;font-weight:600;text-transform:uppercase;margin-bottom:2px;">Time in Step</div>
                                    <div style="font-size:13px;font-weight:600;color:#2d3748;">${formatTimeDiff(vehicle.stepStartTime)}</div>
                                </div>
                                <div>
                                    <div style="font-size:10px;color:#a0aec0;font-weight:600;text-transform:uppercase;margin-bottom:2px;">In System</div>
                                    <div style="font-size:13px;font-weight:600;color:#2d3748;">${formatTimeDiff(vehicle.entryTime)}</div>
                                </div>
                            </div>
                            <div style="margin-top:8px;font-size:10px;color:#cbd5e0;font-family:monospace;word-break:break-all;">${vehicle.vin||''}</div>
                        </div>

                        <div style="padding:12px 20px 38px;display:flex;gap:10px;">
                            <button onclick="document.getElementById('vinResultModal').remove();openVinScanner();"
                                style="flex:1;padding:13px;background:#edf2f7;color:#4a5568;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                                🔄 Scan Again
                            </button>
                            <button onclick="document.getElementById('vinResultModal').remove();"
                                style="flex:1;padding:13px;background:${barColor};color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">
                                Done
                            </button>
                        </div>
                    </div>`;
            }

            document.body.appendChild(modal);
        }

        function closeVinScanner() {
            scannerActive = false;
            clearInterval(scannerInterval);
            scannerInterval = null;
            if (torchOn && torchTrack) {
                try { torchTrack.applyConstraints({ advanced: [{ torch: false }] }); } catch(e) {}
                torchOn = false;
            }
            if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
            const m = document.getElementById('vinScannerModal');
            if (m) m.remove();
        }

        function injectScanButton() {
            const existing = document.getElementById('vinScanFab');
            if (existing) existing.remove();
            if (!currentUser) return;

            if (!scanCacheReady && vehicles.length > 0) buildScanCache();

            const fab = document.createElement('button');
            fab.id = 'vinScanFab';
            fab.innerHTML = `<span style="font-size:24px;line-height:1;">📷</span><span style="font-size:10px;font-weight:800;letter-spacing:0.04em;">SCAN</span>`;
            fab.style.cssText = `
                position:fixed;bottom:22px;right:22px;z-index:4000;
                width:62px;height:62px;border-radius:50%;
                background:linear-gradient(145deg,#2b6cb0,#4299e1);
                color:white;border:none;cursor:pointer;
                display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
                box-shadow:0 5px 20px rgba(66,153,225,0.55);
                transition:transform 0.15s,box-shadow 0.15s;
            `;
            fab.onmouseenter = () => { fab.style.transform='scale(1.1)'; fab.style.boxShadow='0 8px 28px rgba(66,153,225,0.7)'; };
            fab.onmouseleave = () => { fab.style.transform='scale(1)';   fab.style.boxShadow='0 5px 20px rgba(66,153,225,0.55)'; };
            fab.onclick = openVinScanner;
            document.body.appendChild(fab);
        }

        // ==================== END VIN / QR SCANNER ====================

    </script>
    <!-- Add Location Modal -->
    <div id="addLocationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 20px;">Add New Location</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location Name *</label>
                <input type="text" id="newLocationName" placeholder="Miami Store" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Address</label>
                <input type="text" id="newLocationAddress" placeholder="123 Main St" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">City *</label>
                <input type="text" id="newLocationCity" placeholder="Miami" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">State *</label>
                <input type="text" id="newLocationState" placeholder="FL" maxlength="2" style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveNewLocation()" style="flex: 1; background: #48bb78;">
                    ✅ Save Location
                </button>
                <button class="btn" onclick="closeAddLocationModal()" style="flex: 1; background: #718096;">
                    ❌ Cancel
                </button>
            </div>
        </div>
    </div>
</body>
</html>
