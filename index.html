<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Recon Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            color: #1a202c;
            font-size: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 4px 10px;
            background: #4299e1;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: #edf2f7;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #4299e1;
            color: white;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Dashboard View */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border: 2px solid #4299e1;
        }

        .stat-card.active {
            background: #4299e1;
            color: white;
        }

        .stat-card.active .stat-value {
            color: white;
        }

        .stat-card.active .stat-label {
            color: rgba(255,255,255,0.9);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4299e1;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
            font-size: 12px;
        }

        .queue-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            max-width: 100%;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Force 3 columns max when filtering to a single step */
        .queue-board.single-step {
            grid-template-columns: repeat(3, 1fr);
        }
        
        @media (max-width: 900px) {
            .queue-board.single-step {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .queue-board.single-step {
                grid-template-columns: 1fr;
            }
        }

        .queue-column {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .queue-column.has-overdue {
            animation: flashOverdue 2s ease-in-out infinite;
            border: 3px solid #fc8181;
        }

        @keyframes flashOverdue {
            0%, 100% {
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            50% {
                background: #fff5f5;
                box-shadow: 0 0 20px rgba(252, 129, 129, 0.5);
            }
        }

        .overdue-alert {
            background: #fc8181;
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .reassign-suggestion {
            background: #fef5e7;
            border: 2px solid #f39c12;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            font-size: 11px;
        }

        .step-suggestion {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            font-size: 11px;
        }

        .reassign-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 6px;
            width: 100%;
        }

        .reassign-btn:hover {
            background: #e67e22;
        }

        .step-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 6px;
            width: 100%;
        }

        .step-btn:hover {
            background: #45a049;
        }

        .admin-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #718096;
            transition: all 0.2s;
        }

        .admin-tab:hover {
            color: #4299e1;
            background: #f7fafc;
        }

        .admin-tab.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #bee3f8;
            color: #2c5282;
            border-radius: 12px;
            font-size: 12px;
            margin: 3px;
        }

        .tag-remove-btn {
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-name-editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .step-name-editable:hover {
            background: #e2e8f0;
        }

        .substep-container {
            margin-top: 10px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }

        .substep-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .substep-item:last-child {
            margin-bottom: 0;
        }

        .substep-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #4299e1;
            color: white;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        .expand-btn {
            background: transparent;
            border: none;
            color: #4299e1;
            cursor: pointer;
            font-size: 18px;
            padding: 0 8px;
            transition: transform 0.2s;
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .workflow-bar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .workflow-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .workflow-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workflow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .workflow-btn.active {
            border-color: currentColor;
            background: currentColor;
            color: white;
        }

        .workflow-badge {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .workflow-btn.active .workflow-badge {
            background: rgba(255,255,255,0.3);
        }

        .progress-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #e6ffed;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            color: #22543d;
        }

        .auto-reassign-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }

        .auto-reassign-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.6);
        }

        .lock-icon {
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .dependency-warning {
            background: #fff5f5;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .step-filter-bar {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .step-filter-btn {
            padding: 10px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 100px;
        }

        .step-filter-btn:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .step-filter-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .step-filter-btn.all-steps {
            background: #2d3748;
            color: white;
            border-color: #2d3748;
        }

        .step-counts {
            display: flex;
            gap: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .count-badge {
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
        }

        .count-in-step {
            background: #4299e1;
        }

        .count-movable {
            background: #48bb78;
        }

        .count-overdue {
            background: #fc8181;
        }

        .quick-complete-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 5px;
            width: 100%;
        }

        .quick-complete-btn:hover {
            background: #38a169;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .queue-title {
            font-weight: bold;
            font-size: 14px;
        }

        .queue-count {
            background: #4299e1;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .vehicle-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vehicle-card:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
        }

        .vehicle-card.overdue {
            border-color: #fc8181;
            background: #fff5f5;
        }
        
        .vehicle-card.needs-attention {
            animation: pulseAttention 2s ease-in-out infinite;
        }
        
        @keyframes pulseAttention {
            0%, 100% {
                border-color: #f39c12;
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4);
            }
            50% {
                border-color: #e67e22;
                box-shadow: 0 0 0 6px rgba(243, 156, 18, 0);
            }
        }

        .vehicle-vin {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .vehicle-time {
            font-size: 11px;
            color: #718096;
            line-height: 1.4;
        }

        .vehicle-tags {
            display: flex;
            gap: 4px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 2px 6px;
            background: #bee3f8;
            color: #2c5282;
            border-radius: 3px;
            font-size: 10px;
        }

        .alert-tag {
            background: #fc8181;
            color: white;
        }

        .reassign-suggestion {
            background: #fef5e7;
            border: 2px solid #f39c12;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                border-color: #f39c12;
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4);
            }
            50% {
                border-color: #e67e22;
                box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.2);
            }
        }

        .suggestion-badge {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
            animation: flash 1.5s infinite;
        }

        @keyframes flash {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* Technician View */
        .tech-assignment {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .assignment-vin {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin: 15px 0;
            word-break: break-all;
        }

        .assignment-step {
            font-size: 18px;
            color: #4299e1;
            margin-bottom: 15px;
        }

        .complete-btn {
            padding: 12px 30px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
        }

        .complete-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        .no-assignment {
            color: #718096;
            font-size: 16px;
            padding: 30px 20px;
        }

        /* Admin Panel */
        .admin-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .btn {
            padding: 10px 16px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:hover {
            background: #3182ce;
        }

        .threshold-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .threshold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 4px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }

        thead, tbody, tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            word-wrap: break-word;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            font-size: 12px;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .login-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 18px;
            }

            .queue-board {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .threshold-list {
                grid-template-columns: 1fr;
            }

            .assignment-vin {
                font-size: 20px;
            }

            .assignment-step {
                font-size: 16px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 4px;
            }

            .step-filter-btn {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 11px;
            }

            .step-counts {
                gap: 4px;
            }

            .count-badge {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 5px;
            }

            header {
                padding: 10px;
            }

            h1 {
                font-size: 16px;
            }

            .step-filter-buttons {
                gap: 5px;
            }

            .step-filter-btn {
                min-width: 70px;
                padding: 6px 8px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // Your actual Supabase credentials are here
        const SUPABASE_URL = 'https://fpmpujyjhkxtyvwuqwbt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwbXB1anlqaGt4dHl2d3Vxd2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNjUzMDYsImV4cCI6MjA4NjY0MTMwNn0._BQEQV1L938A2onw5iUn0rhnMgVdblYUsUHqj87cXFY';
        
        // Initialize Supabase client
        let supabaseClient = null;
        const USE_SUPABASE = SUPABASE_URL && SUPABASE_ANON_KEY;
        
        // Wait for page to load before initializing
        document.addEventListener('DOMContentLoaded', function() {
            if (USE_SUPABASE && typeof window.supabase !== 'undefined') {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ Supabase initialized');
                } catch (error) {
                    console.error('❌ Failed to initialize Supabase:', error);
                }
            } else {
                console.log('⚠️ Using mock authentication (Supabase not configured)');
            }
        });

        
        // User session and location
        let userSession = null;
        let userLocation = null;
        let userLocations = []; // Array of locations super admin can access
        let currentLocationId = null; // Currently selected location
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function initializeAuth() {
            if (!USE_SUPABASE || !supabaseClient) {
                // Fallback to mock login if supabaseClient not configured
                return;
            }
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                await loadUserProfile(session.user.id);
            }
        }
        
        async function loadUserProfile(userId) {
            if (!supabaseClient) return;
            
            const { data, error } = await supabaseClient
                .from('user_profiles')
                .select(`
                    *,
                    locations (*)
                `)
                .eq('id', userId)
                .single();
            
            if (data) {
                currentUser = {
                    username: data.username,
                    role: data.role,
                    name: data.full_name,
                    department: data.department
                };
                userLocation = data.locations;
                await loadAllData();
                render();
            }
        }
        
        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        
        async function loadAllData() {
            if (!userLocation || !supabaseClient) return;
            
            await Promise.all([
                loadVehicles(),
                loadWorkflows(),
                loadTechnicians(),
                loadStepThresholds(),
                loadTagDefinitions()
            ]);
        }
        
        async function loadVehicles() {
            if (!supabaseClient) return;
            
            const { data, error } = await supabaseClient
                .from('vehicles')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                vehicles = data.map(v => ({
                    ...v,
                    entryTime: new Date(v.entry_time),
                    stepStartTime: new Date(v.step_start_time),
                    completedSteps: v.completed_steps || [],
                    skippedSteps: v.skipped_steps || [],
                    tags: v.tags || [],
                    vehicleTags: v.vehicle_tags || [],
                    photos: v.photos || [],
                    stepHistory: v.step_history || [],
                    noteHistory: []
                }));
                
                // Load notes for each vehicle
                for (let vehicle of vehicles) {
                    await loadVehicleNotes(vehicle);
                }
            }
        }
        
        async function loadVehicleNotes(vehicle) {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('vehicle_notes')
                .select('*')
                .eq('vehicle_id', vehicle.id)
                .order('created_at', { ascending: false });
            
            if (data) {
                vehicle.noteHistory = data.map(n => ({
                    text: n.note_text,
                    timestamp: new Date(n.created_at),
                    user: n.username,
                    id: n.id
                }));
            }
        }
        
        async function loadWorkflows() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                workflows = {};
                data.forEach(w => {
                    workflows[w.workflow_key] = {
                        name: w.name,
                        steps: w.steps || [],
                        color: w.color
                    };
                });
            }
        }
        
        async function loadTechnicians() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('technicians')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                technicians = data.map(t => ({
                    name: t.name,
                    department: t.department,
                    status: t.status || 'available'
                }));
            }
        }
        
        async function loadStepThresholds() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('step_thresholds')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                stepThresholds = {};
                data.forEach(t => {
                    stepThresholds[t.step_name] = t.threshold_hours;
                });
            }
        }
        
        async function loadTagDefinitions() {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('tag_definitions')
                .select('*')
                .eq('location_id', userLocation.id);
            
            if (data) {
                tagDefinitions = {};
                data.forEach(t => {
                    tagDefinitions[t.tag_name] = {
                        color: t.color,
                        skipsStep: t.skips_step
                    };
                });
            }
        }
        
        // ============================================
        // MOCK DATA (REPLACED BY DATABASE)
        // ============================================
        // Mock Data and State Management
        const STEPS = [
            'Xpel', 'Detail', 'Final Touch', 'Glass Work', 
            'Photos', 'Mechanical', 'Body Shop', 'Quality Control', 'Finished'
        ];

        let currentUser = null;
        let currentView = 'dashboard';
        let selectedStepFilter = 'all'; // New filter state
        let selectedStatFilter = 'all'; // Filter by stat card (all, inProgress, completed, overdue, suggested)
        let currentAdminTab = 'import'; // Admin panel tabs
        let expandedSteps = new Set(); // Track which steps are expanded to show substeps

        // Workflow system - define different recon paths
        let workflows = {
            'CPO': {
                name: 'CPO (Certified Pre-Owned)',
                steps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop', 'Quality Control', 'Finished'],
                color: '#48bb78'
            },
            'As-Is': {
                name: 'As-Is (Quick Sale)',
                steps: ['Detail', 'Photos', 'Mechanical', 'Quality Control', 'Finished'],
                color: '#ed8936'
            },
            'Wholesale': {
                name: 'Wholesale',
                steps: ['Mechanical', 'Photos', 'Finished'],
                color: '#9f7aea'
            }
        };

        let currentWorkflowFilter = 'all'; // Filter by workflow

        // Tag definitions - what each tag does
        let tagDefinitions = {
            'Skip Body Shop': { skipsStep: 'Body Shop', color: '#bee3f8' },
            'Skip Glass Work': { skipsStep: 'Glass Work', color: '#bee3f8' },
            'Skip Xpel': { skipsStep: 'Xpel', color: '#bee3f8' },
            'Priority': { priority: true, color: '#fbd38d' },
            'CPO': { special: true, color: '#c6f6d5' },
            'Wholesale': { special: true, color: '#fed7d7' }
        };

        // Substeps configuration - define substeps for each main step
        let substeps = {
            'Mechanical': ['Inspection', 'Parts Order', 'Repair', 'Completed'],
            'Body Shop': ['Estimate', 'Parts Order', 'Paint Prep', 'Paint', 'Reassembly', 'Completed'],
            'Detail': ['Exterior Wash', 'Interior Clean', 'Polish', 'Final Inspection'],
            'Quality Control': ['Initial Check', 'Test Drive', 'Final Approval']
        };

        // Step dependencies - which steps must be completed before this one
        let stepDependencies = {
            'Photos': ['Detail'],
            'Quality Control': ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop']
        };

        // Track which vehicles are locked from reassignment (in process)
        let reassignableLocks = new Set(); // VINs that cannot be auto-reassigned

        // Historical data directory (will be created relative to where file is loaded)
        let baseDirectory = '/home/claude'; // Will be updated on load
        let historyDirectory = `${baseDirectory}/recon_history`;
        let photosDirectory = `${baseDirectory}/vehicle_photos`;

        // Sample vehicles with different states
        let vehicles = [
            {
                vin: '1HGBH41JXMN109186',
                stockNumber: 'A12345',
                year: '2021',
                make: 'Honda',
                model: 'Accord',
                miles: 45230,
                appraisalNotes: 'Trade-in, good condition, minor scratches on bumper',
                entryTime: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                currentStep: 'Detail',
                currentSubstep: null,
                stepStartTime: new Date(Date.now() - 3 * 60 * 60 * 1000), // 3 hours ago
                completedSteps: ['Xpel'],
                completedSubsteps: {},
                skippedSteps: [],
                assignedTech: 'Mike Johnson',
                tags: [],
                vehicleTags: [],
                notes: 'Customer wants quick turnaround',
                noteHistory: [
                    { text: 'Customer wants quick turnaround', timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000), user: 'admin', id: 1 }
                ],
                photos: [],
                stepHistory: [
                    { step: 'Xpel', tech: 'Sarah Chen', startTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), endTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), duration: '24h' }
                ],
                workflow: 'CPO'
            },
            {
                vin: '2FMDK3GC8MBA12345',
                stockNumber: 'B98765',
                year: '2022',
                make: 'Ford',
                model: 'Edge',
                miles: 32100,
                appraisalNotes: 'Auction purchase, needs mechanical inspection',
                entryTime: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                currentStep: 'Mechanical',
                stepStartTime: new Date(Date.now() - 1 * 60 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos'],
                skippedSteps: [],
                assignedTech: 'Tom Wilson',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '5UXWX7C5XBA98765',
                stockNumber: 'C54321',
                year: '2023',
                make: 'BMW',
                model: 'X5',
                miles: 18500,
                appraisalNotes: 'Lease return, excellent condition',
                entryTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                currentStep: 'Xpel',
                stepStartTime: new Date(Date.now() - 30 * 60 * 1000),
                completedSteps: [],
                skippedSteps: ['Body Shop'],
                assignedTech: 'Sarah Chen',
                tags: ['Skip Body Shop'],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: 'WBADT43452G12345',
                stockNumber: 'D11111',
                year: '2020',
                make: 'BMW',
                model: '3 Series',
                miles: 67890,
                appraisalNotes: 'Needs paint work on rear quarter panel',
                entryTime: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),
                currentStep: 'Body Shop',
                stepStartTime: new Date(Date.now() - 5 * 60 * 60 * 1000), // 5 hours - OVERDUE
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical'],
                skippedSteps: [],
                assignedTech: 'Carlos Martinez',
                tags: [],
                notes: 'Priority - customer waiting',
                noteHistory: [
                    { text: 'Priority - customer waiting', timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), user: 'admin', id: 2 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: 'JM1BK32F781234567',
                stockNumber: 'E22222',
                year: '2022',
                make: 'Mazda',
                model: 'CX-5',
                miles: 25000,
                appraisalNotes: 'Clean vehicle, routine recon',
                entryTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                currentStep: 'Photos',
                stepStartTime: new Date(Date.now() - 1.8 * 60 * 60 * 1000), // 1.8 hours - approaching threshold with Jenny busy
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work'],
                skippedSteps: [],
                assignedTech: 'Jenny Park',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '3VW2B7AJ8DM123456',
                stockNumber: 'F33333',
                year: '2021',
                make: 'Volkswagen',
                model: 'Jetta',
                miles: 41200,
                appraisalNotes: 'Minor hail damage',
                entryTime: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
                currentStep: 'Final Touch',
                stepStartTime: new Date(Date.now() - 20 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail'],
                skippedSteps: ['Glass Work'],
                assignedTech: 'Mike Johnson',
                tags: ['Skip Glass Work'],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'As-Is'
            },
            {
                vin: '1G1YY22G965123456',
                stockNumber: 'G44444',
                year: '2019',
                make: 'Chevrolet',
                model: 'Corvette',
                miles: 55300,
                appraisalNotes: 'Windshield chip needs repair',
                entryTime: new Date(Date.now() - 12 * 60 * 60 * 1000),
                currentStep: 'Glass Work',
                stepStartTime: new Date(Date.now() - 90 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch'],
                skippedSteps: [],
                assignedTech: 'David Lee',
                tags: [],
                notes: '',
                noteHistory: [],
                photos: [],
                stepHistory: [],
                workflow: 'Wholesale',
                stockNumber: 'G44444',
                miles: 55300,
                appraisalNotes: 'Windshield chip needs repair'
            },
            {
                vin: '5FNRL5H40BB123456',
                stockNumber: 'H55555',
                year: '2023',
                make: 'Honda',
                model: 'Odyssey',
                miles: 29800,
                appraisalNotes: 'CPO candidate, thorough inspection required',
                entryTime: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days - OLDEST
                currentStep: 'Quality Control',
                stepStartTime: new Date(Date.now() - 15 * 60 * 1000),
                completedSteps: ['Xpel', 'Detail', 'Final Touch', 'Glass Work', 'Photos', 'Mechanical', 'Body Shop'],
                skippedSteps: [],
                assignedTech: 'Admin QC',
                tags: [],
                notes: 'Ready for final QC check',
                noteHistory: [
                    { text: 'Ready for final QC check', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), user: 'admin', id: 3 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'CPO'
            },
            {
                vin: '1FTFW1ET5DFC12345',
                stockNumber: 'Z99999',
                year: '2024',
                make: 'Ford',
                model: 'F-150',
                miles: 0,
                appraisalNotes: 'Incoming delivery - not yet on lot',
                entryTime: new Date(),
                currentStep: 'Awaiting Arrival',
                stepStartTime: new Date(),
                completedSteps: [],
                skippedSteps: [],
                assignedTech: 'unassigned',
                tags: [],
                vehicleTags: [],
                notes: '',
                noteHistory: [
                    { text: 'Vehicle added to system - awaiting arrival and workflow assignment', timestamp: new Date(), user: 'admin', id: 4 }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'AWAITING'
            }
        ];

        // Vehicle history - stores all past vehicles (5 year retention)
        let vehicleHistory = [
            {
                vin: '1HGCM82633A123456',
                stockNumber: 'PAST001',
                miles: 32000,
                appraisalNotes: 'Trade-in, sold 2 years ago',
                completedDate: new Date('2023-03-15'),
                totalReconTime: '4 days',
                notes: 'Smooth process, no issues',
                photos: [],
                stepHistory: []
            }
        ];

        // Stock number registry to prevent duplicates
        let stockNumberRegistry = new Set(['A12345', 'B98765', 'C54321', 'D11111', 'E22222', 'F33333', 'G44444', 'H55555', 'PAST001']);

        let technicians = {
            'Xpel': ['Sarah Chen', 'Alex Rodriguez'],
            'Detail': ['Mike Johnson', 'Chris Brown'],
            'Final Touch': ['Mike Johnson', 'Jenny Park'],
            'Glass Work': ['David Lee'],
            'Photos': ['Jenny Park', 'Lisa Wang'],
            'Mechanical': ['Tom Wilson', 'Robert Garcia'],
            'Body Shop': ['Carlos Martinez', 'James Anderson'],
            'Quality Control': ['Admin QC'],
            'Finished': []
        };

        let stepThresholds = {
            'Xpel': 2,
            'Detail': 2,
            'Final Touch': 2,
            'Glass Work': 2,
            'Photos': 2,
            'Mechanical': 2,
            'Body Shop': 2,
            'Quality Control': 2,
            'Finished': 0
        };

        let lastAssignment = {}; // Track last assignment per step
        let technicianStatus = {}; // Track if technician is currently working or available

        // Initialize technician status
        function initTechnicianStatus() {
            Object.entries(technicians).forEach(([step, techs]) => {
                techs.forEach(tech => {
                    if (!technicianStatus[tech]) {
                        technicianStatus[tech] = {
                            currentVehicle: null,
                            available: true,
                            lastCompleted: null
                        };
                    }
                });
            });
            
            // Set current assignments based on vehicles
            vehicles.forEach(v => {
                if (v.assignedTech && technicianStatus[v.assignedTech]) {
                    technicianStatus[v.assignedTech].currentVehicle = v.vin;
                    technicianStatus[v.assignedTech].available = false;
                }
            });
        }

        // Check if there's a better technician available
        function suggestTechnicianChange(vehicle) {
            const step = vehicle.currentStep;
            const currentTech = vehicle.assignedTech;
            const hoursInStep = (Date.now() - vehicle.stepStartTime.getTime()) / (1000 * 60 * 60);
            const threshold = stepThresholds[step] || 2;
            
            // Only suggest if vehicle has been waiting too long (80% of threshold)
            if (hoursInStep < threshold * 0.8) {
                return null;
            }
            
            const availableTechs = (technicians[step] || []).filter(tech => {
                // Check if tech is available or has completed their current job
                const status = technicianStatus[tech];
                if (!status) return false;
                
                // Tech is available
                if (status.available) return true;
                
                // Or tech has a vehicle that's been completed (in mock, check if assigned vehicle is still in same step)
                if (status.currentVehicle) {
                    const assignedVehicle = vehicles.find(v => v.vin === status.currentVehicle);
                    // If vehicle moved to next step, tech is available
                    if (assignedVehicle && assignedVehicle.currentStep !== step) {
                        status.available = true;
                        status.currentVehicle = null;
                        return true;
                    }
                }
                
                return false;
            });
            
            // If there's an available tech and current tech is still busy
            if (availableTechs.length > 0 && currentTech) {
                const currentTechStatus = technicianStatus[currentTech];
                if (currentTechStatus && !currentTechStatus.available) {
                    // Find the tech who completed their last job earliest
                    let bestTech = availableTechs[0];
                    let earliestCompletion = technicianStatus[bestTech]?.lastCompleted || 0;
                    
                    availableTechs.forEach(tech => {
                        const completion = technicianStatus[tech]?.lastCompleted || 0;
                        if (completion < earliestCompletion) {
                            bestTech = tech;
                            earliestCompletion = completion;
                        }
                    });
                    
                    return {
                        currentTech: currentTech,
                        suggestedTech: bestTech,
                        reason: 'Available technician can start immediately',
                        waitTime: formatTimeDiff(vehicle.stepStartTime)
                    };
                }
            }
            
            return null;
        }

        // Apply suggested reassignment
        function reassignTechnician(vin, newTech) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const oldTech = vehicle.assignedTech;
            
            // Update vehicle assignment
            vehicle.assignedTech = newTech;
            
            // Update technician status
            if (technicianStatus[oldTech]) {
                technicianStatus[oldTech].currentVehicle = null;
                technicianStatus[oldTech].available = true;
            }
            
            if (technicianStatus[newTech]) {
                technicianStatus[newTech].currentVehicle = vin;
                technicianStatus[newTech].available = false;
            }
            
            closeDialog();
            
            render();
            alert(`Vehicle ${vehicle.stockNumber || vin} reassigned from ${oldTech} to ${newTech}`);
        }

        // Users database
        const users = {
            'admin': { password: 'admin123', role: 'administrator', name: 'Admin User' },
            'mike': { password: 'tech123', role: 'technician', name: 'Mike Johnson', department: 'Detail' },
            'sarah': { password: 'tech123', role: 'technician', name: 'Sarah Chen', department: 'Xpel' },
            'tom': { password: 'tech123', role: 'technician', name: 'Tom Wilson', department: 'Mechanical' }
        };

        // Utility Functions
        function formatTimeDiff(date) {
            const diff = Date.now() - date.getTime();
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function isOverdue(vehicle) {
            const threshold = stepThresholds[vehicle.currentStep] || 2;
            const hoursInStep = (Date.now() - vehicle.stepStartTime.getTime()) / (1000 * 60 * 60);
            return hoursInStep > threshold;
        }

        function getNextStep(vehicle) {
            // Find next step that's not completed and not skipped
            for (let step of STEPS) {
                if (step === 'Quality Control' || step === 'Finished') {
                    // These come at the end in specific order
                    continue;
                }
                if (!vehicle.completedSteps.includes(step) && !vehicle.skippedSteps.includes(step)) {
                    return step;
                }
            }
            
            // If all regular steps are done, go to QC
            if (!vehicle.completedSteps.includes('Quality Control')) {
                return 'Quality Control';
            }
            
            return 'Finished';
        }

        function getSmartNextStep(vehicle) {
            // Get all remaining steps (excluding QC and Finished)
            const remainingSteps = STEPS.filter(step => 
                step !== 'Quality Control' && 
                step !== 'Finished' &&
                !vehicle.completedSteps.includes(step) && 
                !vehicle.skippedSteps.includes(step)
            );

            if (remainingSteps.length === 0) {
                // All regular steps done, move to QC
                return 'Quality Control';
            }

            // Count vehicles in each remaining step
            const queueCounts = {};
            remainingSteps.forEach(step => {
                queueCounts[step] = vehicles.filter(v => v.currentStep === step).length;
            });

            // Find step with shortest queue
            let shortestQueue = remainingSteps[0];
            let shortestCount = queueCounts[remainingSteps[0]];

            remainingSteps.forEach(step => {
                if (queueCounts[step] < shortestCount) {
                    shortestQueue = step;
                    shortestCount = queueCounts[step];
                }
            });

            return shortestQueue;
        }

        function assignTechnician(step) {
            const techList = technicians[step] || [];
            if (techList.length === 0) return null;

            // Round robin - find next technician
            const lastTech = lastAssignment[step] || null;
            const lastIndex = lastTech ? techList.indexOf(lastTech) : -1;
            const nextIndex = (lastIndex + 1) % techList.length;
            
            const assignedTech = techList[nextIndex];
            lastAssignment[step] = assignedTech;
            
            return assignedTech;
        }

        function getAvailableTechnician(step) {
            const techList = technicians[step] || [];
            if (techList.length === 0) return null;

            // Find technicians who don't have active assignments
            for (let tech of techList) {
                const hasActiveAssignment = vehicles.some(v => 
                    v.assignedTech === tech && 
                    v.currentStep === step && 
                    v.currentStep !== 'Finished'
                );
                
                if (!hasActiveAssignment) {
                    return tech;
                }
            }

            // If all are busy, return the one with oldest assignment (likely to finish soon)
            let oldestAssignment = null;
            let oldestTime = Date.now();

            techList.forEach(tech => {
                const vehicle = vehicles.find(v => 
                    v.assignedTech === tech && 
                    v.currentStep === step
                );
                if (vehicle && vehicle.stepStartTime < oldestTime) {
                    oldestTime = vehicle.stepStartTime;
                    oldestAssignment = tech;
                }
            });

            return oldestAssignment || techList[0];
        }

        function getSuggestedAlternateStep(vehicle) {
            // Get all steps the vehicle still needs (excluding completed, skipped, QC, and Finished)
            const remainingSteps = STEPS.filter(step => 
                step !== 'Quality Control' && 
                step !== 'Finished' &&
                step !== vehicle.currentStep &&
                !vehicle.completedSteps.includes(step) && 
                !vehicle.skippedSteps.includes(step)
            );

            if (remainingSteps.length === 0) {
                return null; // No other steps available
            }

            // Calculate queue lengths for each remaining step
            const queueInfo = remainingSteps.map(step => {
                const queueLength = vehicles.filter(v => v.currentStep === step).length;
                const currentStepQueue = vehicles.filter(v => v.currentStep === vehicle.currentStep).length;
                
                return {
                    step: step,
                    queueLength: queueLength,
                    improvement: currentStepQueue - queueLength
                };
            });

            // Find step with shortest queue that's actually better than current
            const bestAlternate = queueInfo
                .filter(info => info.improvement > 0) // Only suggest if it's actually better
                .sort((a, b) => b.improvement - a.improvement)[0];

            return bestAlternate ? bestAlternate.step : null;
        }

        function reassignVehicle(vin, newTech) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                vehicle.assignedTech = newTech;
                vehicle.stepStartTime = new Date(); // Reset timer
                
                render();
                alert(`✓ Vehicle ${vehicle.stockNumber || vin} reassigned to ${newTech}`);
            }
        }

        function moveToSuggestedStep(vin, newStep) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                // Safety check: Don't allow moving to QC or Finished without all steps completed
                if (newStep === 'Quality Control') {
                    const allStepsComplete = STEPS.filter(s => 
                        s !== 'Quality Control' && 
                        s !== 'Finished'
                    ).every(step => 
                        vehicle.completedSteps.includes(step) || 
                        vehicle.skippedSteps.includes(step)
                    );
                    
                    if (!allStepsComplete) {
                        alert('❌ Cannot move to Quality Control - all prior steps must be completed first!');
                        return;
                    }
                }
                
                if (newStep === 'Finished') {
                    if (!vehicle.completedSteps.includes('Quality Control')) {
                        alert('❌ Cannot move to Finished - must complete Quality Control first!');
                        return;
                    }
                }
                
                vehicle.currentStep = newStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(newStep);
                
                render();
                alert(`✓ Vehicle ${vehicle.stockNumber || vin} moved to ${newStep}`);
            }
        }

        function completeStep(vehicle) {
            // Mark current step as complete
            vehicle.completedSteps.push(vehicle.currentStep);
            
            // Update technician status - they're now available
            if (vehicle.assignedTech && technicianStatus[vehicle.assignedTech]) {
                technicianStatus[vehicle.assignedTech].available = true;
                technicianStatus[vehicle.assignedTech].currentVehicle = null;
                technicianStatus[vehicle.assignedTech].lastCompleted = Date.now();
            }
            
            // Determine next step using smart routing with safety checks
            let nextStep;
            
            if (vehicle.currentStep === 'Quality Control') {
                nextStep = 'Finished';
            } else {
                // Check if all regular steps are complete
                const allRegularStepsComplete = STEPS.filter(s => 
                    s !== 'Quality Control' && 
                    s !== 'Finished'
                ).every(step => 
                    vehicle.completedSteps.includes(step) || 
                    vehicle.skippedSteps.includes(step)
                );
                
                if (allRegularStepsComplete) {
                    // All steps done, move to Quality Control
                    nextStep = 'Quality Control';
                } else {
                    // Get smart next step from remaining steps
                    nextStep = getSmartNextStep(vehicle);
                }
            }
            
            vehicle.currentStep = nextStep;
            vehicle.stepStartTime = new Date();
            const newTech = assignTechnician(nextStep);
            vehicle.assignedTech = newTech;
            
            // Update new technician status
            if (newTech && technicianStatus[newTech]) {
                technicianStatus[newTech].available = false;
                technicianStatus[newTech].currentVehicle = vehicle.vin;
            }
            
            
            render();
        }

        function rejectFromQC(vehicle, sendBackTo) {
            // Remove the step from completed so it needs to be done again
            const index = vehicle.completedSteps.indexOf(sendBackTo);
            if (index > -1) {
                vehicle.completedSteps.splice(index);
            }
            
            vehicle.currentStep = sendBackTo;
            vehicle.stepStartTime = new Date();
            vehicle.assignedTech = assignTechnician(sendBackTo);
            
            
            render();
        }

        // Rendering Functions
        function renderLogin() {
            return `
                <div class="login-container">
                    <h2 class="login-title">Vehicle Recon System</h2>
                    
                    <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 8px; color: #234e52; font-size: 14px;">📂 Load Your Save File</h3>
                        <p style="margin-bottom: 10px; font-size: 12px; color: #2c7a7b;">
                            If you have a saved data file, load it here before logging in:
                        </p>
                        <input type="file" id="loginLoadFile" accept=".json" onchange="loadFromFile(event)" 
                               style="width: 100%; padding: 8px; border: 2px solid #38b2ac; border-radius: 4px; font-size: 12px; cursor: pointer; background: white;">
                    </div>
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="login()" style="width: 100%">Login</button>
                    <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 4px; font-size: 12px;">
                        <strong>Demo Accounts:</strong><br>
                        Admin: admin / admin123<br>
                        Tech: mike / tech123<br>
                        Tech: sarah / tech123
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header>
                    <h1>🚗 Vehicle Recon Management System</h1>
                   <div class="user-info">
    <span>👤 ${currentUser.name || currentUser.username}</span>
    <span>Role: ${currentUser.role}</span>
    ${currentUser.department ? `<span>Dept: ${currentUser.department}</span>` : ''}
    
    ${currentUser && currentUser.role === 'superadmin' && userLocations.length > 1 ? `
        <div style="display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; color: #718096;">Location:</label>
            <select onchange="switchLocation(this.value)" style="padding: 6px; border: 2px solid #4299e1; border-radius: 4px; font-size: 12px;">
                ${userLocations.map(loc => `
                    <option value="${loc.id}" ${loc.id === currentLocationId ? 'selected' : ''}>
                        ${loc.name}
                    </option>
                `).join('')}
            </select>
        </div>
    ` : ''}
    
    <button class="btn" onclick="logout()">Logout</button>
</div>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </header>
            `;
        }

        function renderDashboard() {
            const totalVehicles = vehicles.length;
            const awaitingArrival = vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING').length;
            const inProgress = vehicles.filter(v => v.currentStep !== 'Finished' && v.workflow && v.workflow !== 'AWAITING').length;
            const completed = vehicles.filter(v => v.currentStep === 'Finished').length;
            const overdue = vehicles.filter(v => isOverdue(v) && v.currentStep !== 'Finished').length;


            
            // Calculate suggested changes
            const suggested = vehicles.filter(v => {
                if (v.currentStep === 'Finished') return false;
                if (!v.workflow || v.workflow === 'AWAITING') return false;
                const suggestedStep = getSuggestedAlternateStep(v);
                const availableTech = getAvailableTechnician(v.currentStep);
                return suggestedStep !== null || (availableTech && availableTech !== v.assignedTech);
            }).length;

            // Filter vehicles based on selected stat
            let vehiclesToShow = vehicles;
            if (selectedStatFilter !== 'all') {
                vehiclesToShow = getVehiclesByStat(selectedStatFilter);
            }

            // Filter by workflow
            if (currentWorkflowFilter !== 'all') {
                vehiclesToShow = vehiclesToShow.filter(v => v.workflow === currentWorkflowFilter);
            }

            const queuesByStep = {};
            STEPS.forEach(step => {
                queuesByStep[step] = vehiclesToShow.filter(v => v.currentStep === step);
            });

            // Filter steps if a specific step is selected
            const stepsToShow = selectedStepFilter === 'all' 
                ? STEPS 
                : [selectedStepFilter];

            return `
                ${currentUser.role === 'administrator' ? `
                <div class="step-filter-bar">
                    <div class="step-filter-buttons">
                        <button class="step-filter-btn ${selectedStepFilter === 'all' ? 'all-steps' : ''}" 
                                onclick="filterByStep('all')">
                            <div>All Steps</div>
                            <div class="step-counts">
                                <span class="count-badge count-in-step">${inProgress}</span>
                            </div>
                        </button>
                        ${STEPS.filter(s => s !== 'Finished').map(step => {
                            const stats = getStepStats(step);
                            return `
                            <button class="step-filter-btn ${selectedStepFilter === step ? 'active' : ''}" 
                                    onclick="filterByStep('${step}')">
                                <div>${step}</div>
                                <div class="step-counts">
                                    <span class="count-badge count-in-step" title="Vehicles in step">${stats.inStep}</span>
                                    ${stats.movable > 0 ? `<span class="count-badge count-movable" title="Can move to faster step">${stats.movable}</span>` : ''}
                                    ${stats.overdue > 0 ? `<span class="count-badge count-overdue" title="Overdue vehicles">${stats.overdue}</span>` : ''}
                                </div>
                            </button>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="workflow-bar">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 15px;">Workflows:</strong>
                    </div>
                    <div class="workflow-buttons">
                        <button class="workflow-btn ${currentWorkflowFilter === 'all' ? 'active' : ''}" 
                                style="border-color: #718096; ${currentWorkflowFilter === 'all' ? 'background: #718096; color: white;' : ''}"
                                onclick="filterByWorkflow('all')">
                            All Workflows
                            <span class="workflow-badge">${vehicles.filter(v => v.workflow && v.workflow !== 'AWAITING').length}</span>
                        </button>
                        ${Object.entries(workflows).map(([id, workflow]) => {
                            const count = vehicles.filter(v => v.workflow === id).length;
                            return `
                                <button class="workflow-btn ${currentWorkflowFilter === id ? 'active' : ''}" 
                                        style="border-color: ${workflow.color}; ${currentWorkflowFilter === id ? `background: ${workflow.color}; color: white;` : ''}"
                                        onclick="filterByWorkflow('${id}')">
                                    ${workflow.name}
                                    <span class="workflow-badge">${count}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card ${selectedStatFilter === 'awaiting' ? 'active' : ''}" onclick="filterByStat('awaiting')" style="border: 2px solid #f39c12;">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'awaiting' ? 'white' : '#f39c12'}">${awaitingArrival}</div>
                        <div class="stat-label">Awaiting Arrival</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'total' ? 'active' : ''}" onclick="filterByStat('total')">
                        <div class="stat-value">${totalVehicles}</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'inProgress' ? 'active' : ''}" onclick="filterByStat('inProgress')">
                        <div class="stat-value">${inProgress}</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'completed' ? 'active' : ''}" onclick="filterByStat('completed')">
                        <div class="stat-value">${completed}</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'overdue' ? 'active' : ''}" onclick="filterByStat('overdue')">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'overdue' ? 'white' : (overdue > 0 ? '#e53e3e' : '#48bb78')}">${overdue}</div>
                        <div class="stat-label">Overdue Vehicles</div>
                    </div>
                    <div class="stat-card ${selectedStatFilter === 'suggested' ? 'active' : ''}" onclick="filterByStat('suggested')">
                        <div class="stat-value" style="color: ${selectedStatFilter === 'suggested' ? 'white' : (suggested > 0 ? '#f39c12' : '#48bb78')}">${suggested}</div>
                        <div class="stat-label">Suggested Changes</div>
                    </div>
                </div>

                <!-- Awaiting Arrival Section -->
                ${selectedStatFilter === 'awaiting' || selectedStatFilter === 'all' || selectedStatFilter === 'total' ? `
                    <div style="background: #fffbeb; border: 3px solid #f39c12; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 18px; color: #7c2d12;">
                            ⏳ Awaiting Arrival
                        </h3>
                        ${awaitingArrival > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                                ${vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING').map(vehicle => `
                                    <div style="background: white; padding: 15px; border-radius: 6px; border: 2px solid #f39c12; cursor: pointer; transition: all 0.2s;" 
                                         onclick="showVehicleDetails('${vehicle.vin}')"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #2d3748;">
                                            ${vehicle.year} ${vehicle.make} ${vehicle.model}
                                        </div>
                                        <div style="font-size: 12px; color: #718096; margin-bottom: 10px;">
                                            <div><strong>Stock:</strong> ${vehicle.stockNumber}</div>
                                            <div><strong>VIN:</strong> ${vehicle.vin}</div>
                                            <div><strong>Miles:</strong> ${vehicle.miles?.toLocaleString() || 'N/A'}</div>
                                            ${(vehicle.noteHistory && vehicle.noteHistory.length > 0) ? `
                                                <div style="margin-top: 6px; padding: 6px; background: #f7fafc; border-radius: 3px; font-size: 11px;">
                                                    <strong>Latest note:</strong> ${vehicle.noteHistory[vehicle.noteHistory.length - 1].text.substring(0, 50)}${vehicle.noteHistory[vehicle.noteHistory.length - 1].text.length > 50 ? '...' : ''}
                                                </div>
                                            ` : ''}
                                            ${(vehicle.vehicleTags && vehicle.vehicleTags.length > 0) ? `
                                                <div style="margin-top: 6px;">
                                                    ${vehicle.vehicleTags.slice(0, 2).map(tag => `
                                                        <span style="display: inline-block; font-size: 10px; padding: 2px 6px; margin: 2px; background: ${tagDefinitions[tag]?.color || '#bee3f8'}; border-radius: 3px;">${tag}</span>
                                                    `).join('')}
                                                    ${vehicle.vehicleTags.length > 2 ? `<span style="font-size: 10px; color: #718096;">+${vehicle.vehicleTags.length - 2}</span>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div style="margin-bottom: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                            <label style="display: block; margin-bottom: 5px; font-size: 11px; font-weight: bold; color: #4a5568;">Assign Workflow:</label>
                                            <select id="workflow_${vehicle.vin}" 
                                                    onclick="event.stopPropagation();"
                                                    style="width: 100%; padding: 8px; font-size: 12px; border: 2px solid #cbd5e0; border-radius: 4px;">
                                                <option value="">-- Select Workflow --</option>
                                                ${Object.entries(workflows).map(([id, workflow]) => `
                                                    <option value="${id}">${workflow.name}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <button class="btn" onclick="event.stopPropagation(); assignWorkflowToVehicle('${vehicle.vin}')" 
                                                style="width: 100%; background: #48bb78; padding: 10px; font-size: 13px;">
                                            ✅ Assign & Start Recon
                                        </button>
                                        <div style="margin-top: 8px; text-align: center; font-size: 11px; color: #718096;">
                                            Click card to add notes/tags
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 30px; color: #718096;">
                                <div style="font-size: 48px; margin-bottom: 10px;">✓</div>
                                <div style="font-size: 14px;">No vehicles awaiting assignment</div>
                            </div>
                        `}
                    </div>
                ` : ''}

                <div class="queue-board ${selectedStepFilter !== 'all' ? 'single-step' : ''}">
                    ${stepsToShow.map(step => {
                        const stepVehicles = queuesByStep[step];
                        const hasOverdue = stepVehicles.some(v => isOverdue(v));
                        const overdueVehicles = stepVehicles.filter(v => isOverdue(v));
                        
                        return `
                        <div class="queue-column ${hasOverdue ? 'has-overdue' : ''}">
                            <div class="queue-header">
                                <span class="queue-title">${step}</span>
                                <span class="queue-count">${stepVehicles.length}</span>
                            </div>
                            ${hasOverdue ? `
                                <div class="overdue-alert">
                                    ⚠️ ${overdueVehicles.length} OVERDUE!
                                </div>
                            ` : ''}
                            ${stepVehicles
                                .sort((a, b) => a.entryTime - b.entryTime) // Oldest first
                                .map(vehicle => {
                                    const vehicleOverdue = isOverdue(vehicle);
                                    const availableTech = getAvailableTechnician(step);
                                    const shouldSuggestReassign = availableTech && 
                                        availableTech !== vehicle.assignedTech;
                                    
                                    const suggestedStep = getSuggestedAlternateStep(vehicle);
                                    const shouldSuggestStepChange = suggestedStep !== null;
                                    
                                    // On filtered view, always show suggestions if available
                                    const isFilteredView = selectedStepFilter !== 'all';
                                    const showStepSuggestion = isFilteredView ? shouldSuggestStepChange : (vehicleOverdue && shouldSuggestStepChange);
                                    const showTechSuggestion = isFilteredView ? shouldSuggestReassign : (vehicleOverdue && shouldSuggestReassign);
                                    
                                    return `
                                    <div class="vehicle-card ${vehicleOverdue ? 'overdue' : ''} ${(showStepSuggestion || showTechSuggestion) ? 'needs-attention' : ''}" onclick="showVehicleDetails('${vehicle.vin}')">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <div class="vehicle-vin">${vehicle.stockNumber || vehicle.vin}</div>
                                                ${vehicle.year && vehicle.make && vehicle.model ? `
                                                    <div style="font-size: 11px; color: #718096; margin-top: 2px;">
                                                        ${vehicle.year} ${vehicle.make} ${vehicle.model}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 5px;">
                                                <span class="progress-indicator">${vehicle.completedSteps.length}/${STEPS.length - 1}</span>
                                                ${currentUser.role === 'administrator' ? `
                                                    <span class="lock-icon" 
                                                          onclick="event.stopPropagation(); toggleReassignLock('${vehicle.vin}')" 
                                                          title="${reassignableLocks.has(vehicle.vin) ? 'Locked from auto-reassign' : 'Click to lock from auto-reassign'}">
                                                        ${reassignableLocks.has(vehicle.vin) ? '🔒' : '🔓'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="vehicle-time">⏱️ ${formatTimeDiff(vehicle.stepStartTime)} in step</div>
                                        <div class="vehicle-time">📅 ${formatTimeDiff(vehicle.entryTime)} in system</div>
                                        <div class="vehicle-time">👤 ${vehicle.assignedTech || 'Unassigned'}</div>
                                        ${vehicle.tags.length > 0 ? `
                                            <div class="vehicle-tags">
                                                ${vehicle.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        ${vehicleOverdue ? '<div class="vehicle-tags"><span class="tag alert-tag">⚠️ OVERDUE</span></div>' : ''}
                                        ${currentUser.role === 'administrator' && vehicle.currentStep !== 'Finished' ? `
                                            <button class="quick-complete-btn" onclick="event.stopPropagation(); quickCompleteStep('${vehicle.vin}')">
                                                ✓ Complete ${vehicle.currentStep}
                                            </button>
                                        ` : ''}
                                        ${showStepSuggestion ? `
                                            <div class="step-suggestion" onclick="event.stopPropagation()">
                                                <strong>🔄 Move to Different Step:</strong><br>
                                                ${suggestedStep} has shorter queue
                                                <button class="step-btn" onclick="event.stopPropagation(); moveToSuggestedStep('${vehicle.vin}', '${suggestedStep}')">
                                                    Move to ${suggestedStep}
                                                </button>
                                            </div>
                                        ` : ''}
                                        ${showTechSuggestion ? `
                                            <div class="reassign-suggestion" onclick="event.stopPropagation()">
                                                <strong>💡 Reassign Technician:</strong><br>
                                                ${availableTech} is available
                                                <button class="reassign-btn" onclick="event.stopPropagation(); reassignVehicle('${vehicle.vin}', '${availableTech}')">
                                                    Reassign to ${availableTech}
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `}).join('')}
                            ${stepVehicles.length === 0 ? '<div style="color: #a0aec0; text-align: center; padding: 20px;">No vehicles</div>' : ''}
                        </div>
                    `}).join('')}
                </div>
                
                ${currentUser.role === 'administrator' && inProgress > 0 ? `
                    <button class="auto-reassign-btn" onclick="autoReassignAll()" title="Auto-optimize all vehicle assignments">
                        🤖 Auto-Reassign All
                    </button>
                ` : ''}
            `;
        }

        function renderTechnicianView() {
            // Find vehicle assigned to current technician in their department
            const techDept = currentUser.department;
            const assignedVehicle = vehicles.find(v => 
                v.assignedTech === currentUser.name && 
                v.currentStep === techDept &&
                v.currentStep !== 'Finished'
            );

            if (!assignedVehicle) {
                // Show vehicles in their department queue
                const deptVehicles = vehicles.filter(v => v.currentStep === techDept);
                
                return `
                    <div class="tech-assignment">
                        <div class="no-assignment">
                            <h2>✅ No Current Assignment</h2>
                            <p style="margin-top: 10px;">Waiting for next vehicle in ${techDept}...</p>
                            ${deptVehicles.length > 0 ? `
                                <p style="margin-top: 15px; color: #4a5568;">
                                    <strong>${deptVehicles.length}</strong> vehicle${deptVehicles.length !== 1 ? 's' : ''} in ${techDept} queue
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="tech-assignment">
                    <h2 style="font-size: 18px; margin-bottom: 10px;">Current Assignment - ${currentUser.department}</h2>
                    <div class="assignment-vin">${assignedVehicle.stockNumber || assignedVehicle.vin}</div>
                    ${assignedVehicle.year && assignedVehicle.make && assignedVehicle.model ? `
                        <div style="font-size: 13px; color: #718096; margin-top: 5px; margin-bottom: 10px;">
                            ${assignedVehicle.year} ${assignedVehicle.make} ${assignedVehicle.model}
                        </div>
                    ` : ''}
                    <div class="assignment-step">Step: ${assignedVehicle.currentStep}</div>
                    <div style="margin: 15px 0; color: #718096; font-size: 14px;">
                        <div>⏱️ Time in step: ${formatTimeDiff(assignedVehicle.stepStartTime)}</div>
                        <div>📅 Total time in system: ${formatTimeDiff(assignedVehicle.entryTime)}</div>
                        ${assignedVehicle.tags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${assignedVehicle.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}
                            </div>
                        ` : ''}
                    </div>
                    <button class="complete-btn" onclick="completeTechStep('${assignedVehicle.vin}')">
                        ✓ Mark Complete
                    </button>
                </div>
            `;
        }

        function renderAdminPanel() {
            return `
                <div class="admin-tabs">
                    <button class="admin-tab ${currentAdminTab === 'import' ? 'active' : ''}" onclick="switchAdminTab('import')">
                        📋 Import Vehicles
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'users' ? 'active' : ''}" onclick="switchAdminTab('users')">
                        👥 Users
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'steps' ? 'active' : ''}" onclick="switchAdminTab('steps')">
                        🔧 Steps
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'techs' ? 'active' : ''}" onclick="switchAdminTab('techs')">
                        👨‍🔧 Technicians
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'tags' ? 'active' : ''}" onclick="switchAdminTab('tags')">
                        🏷️ Tags
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'workflows' ? 'active' : ''}" onclick="switchAdminTab('workflows')">
                        🔄 Workflows
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'settings' ? 'active' : ''}" onclick="switchAdminTab('settings')">
                        ⚙️ Settings
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'data' ? 'active' : ''}" onclick="switchAdminTab('data')">
                        💾 Data Management
                    </button>
                    <button class="admin-tab ${currentAdminTab === 'report' ? 'active' : ''}" onclick="switchAdminTab('report')">
                        📊 Report
                    </button>
                </div>

                <div class="admin-content ${currentAdminTab === 'import' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">📋 Import Vehicles from Excel</h2>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin-bottom: 10px; font-size: 14px;">
                                Upload a CSV file with columns: VIN, Stock Number, Miles, Appraisal Notes, Skip Steps
                            </p>
                            <p style="margin-bottom: 10px; font-size: 13px; color: #718096;">
                                <strong>Note:</strong> Duplicate stock numbers will be automatically skipped
                            </p>
                            <input type="file" id="excelImport" accept=".csv" 
                                   onchange="handleExcelImport(event)"
                                   style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px;">
                            <button class="btn" onclick="window.open('/mnt/user-data/outputs/vehicle-import-template.csv')" 
                                    style="margin-top: 10px; background: #4299e1;">
                                📥 Download Template
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2 class="section-title">Add New Vehicle</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>VIN Number</label>
                                <input type="text" id="newVIN" placeholder="Enter VIN">
                            </div>
                            <div class="form-group">
                                <label>Stock Number</label>
                                <input type="text" id="newStockNumber" placeholder="Enter Stock #">
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <input type="text" id="newYear" placeholder="2024">
                            </div>
                            <div class="form-group">
                                <label>Make</label>
                                <input type="text" id="newMake" placeholder="Toyota">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" id="newModel" placeholder="Camry">
                            </div>
                            <div class="form-group">
                                <label>Miles</label>
                                <input type="number" id="newMiles" placeholder="25000">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Skip Steps (Optional)</label>
                                <select id="skipSteps" multiple style="height: 80px;">
                                    ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => 
                                        `<option value="${step}">${step}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <button class="btn" onclick="addNewVehicle()">Add Vehicle</button>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'users' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">👥 User Management</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Add New User</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div class="form-group">
                                    <label>Email / Username</label>
                                    <input type="text" id="username" placeholder="admin@miami.test or admin">
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" id="newPassword" placeholder="password">
                                </div>
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="newUserFullName" placeholder="John Doe">
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <select id="newUserRole" onchange="document.getElementById('deptField').style.display = this.value === 'technician' ? 'block' : 'none'">
                                        <option value="technician">Technician</option>
                                        <option value="administrator">Administrator</option>
                                        <option value="manager">Manager</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="deptField">
                                <label>Department (for Technicians)</label>
                                <select id="newUserDepartment">
                                    ${STEPS.filter(s => s !== 'Finished').map(step => 
                                        `<option value="${step}">${step}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <button class="btn" onclick="addUser()">➕ Add User</button>
                        </div>
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Current Users</h3>
                        <table style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(users).map(([username, user]) => `
                                    <tr>
                                        <td>${username}</td>
                                        <td>${user.name}</td>
                                        <td>${user.role}</td>
                                        <td>${user.department || '-'}</td>
                                        <td>
                                            ${username !== 'admin' ? `
                                                <button class="btn" onclick="removeUser('${username}')" style="background: #e53e3e; padding: 4px 8px; font-size: 11px;">
                                                    Remove
                                                </button>
                                            ` : '<span style="color: #718096;">Protected</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'steps' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🔧 Step Management</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Add New Step</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group">
                                    <label>Step Name</label>
                                    <input type="text" id="newStepName" placeholder="Paint Correction">
                                </div>
                                <div class="form-group">
                                    <label>Insert Before</label>
                                    <select id="insertBeforeStep">
                                        ${STEPS.map(step => 
                                            `<option value="${step}">${step}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="addStep()">➕ Add Step</button>
                        </div>
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Current Steps (In Order)</h3>
                        <p style="font-size: 13px; color: #718096; margin-bottom: 15px;">
                            Click the ▶ arrow to expand a step and manage its substeps
                        </p>
                        <div style="background: white; border-radius: 6px; overflow: hidden;">
                            ${STEPS.map((step, index) => {
                                const isExpanded = expandedSteps.has(step);
                                const hasSubsteps = substeps[step] && substeps[step].length > 0;
                                
                                return `
                                    <div style="border-bottom: 1px solid #e2e8f0;">
                                        <div style="display: grid; grid-template-columns: 40px 1fr 80px 80px 200px; gap: 10px; padding: 12px; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                ${hasSubsteps || true ? `
                                                    <button class="expand-btn ${isExpanded ? 'expanded' : ''}" 
                                                            onclick="toggleStepExpansion('${step}')" 
                                                            title="Show/hide substeps">
                                                        ▶
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div>
                                                <strong style="font-size: 14px;">${index + 1}. </strong>
                                                <span class="step-name-editable" onclick="editStepName('${step}')" title="Click to rename">
                                                    ${step}
                                                </span>
                                                ${hasSubsteps ? `<span class="substep-badge">${substeps[step].length} substeps</span>` : ''}
                                            </div>
                                            <div style="font-size: 13px;">${stepThresholds[step] || 0}h</div>
                                            <div style="font-size: 13px;">${(technicians[step] || []).length} techs</div>
                                            <div style="display: flex; gap: 4px;">
                                                <button class="btn" onclick="moveStepUp('${step}')" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        ${index === 0 ? 'disabled' : ''}>
                                                    ↑
                                                </button>
                                                <button class="btn" onclick="moveStepDown('${step}')" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        ${index >= STEPS.length - 1 ? 'disabled' : ''}>
                                                    ↓
                                                </button>
                                                <button class="btn" onclick="removeStep('${step}')" 
                                                        style="background: #e53e3e; padding: 4px 8px; font-size: 11px;">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                        
                                        ${isExpanded ? `
                                            <div class="substep-container">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                    <h4 style="font-size: 14px; margin: 0;">Substeps for ${step}</h4>
                                                    <button class="btn" onclick="addSubstep('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                                        ➕ Add Substep
                                                    </button>
                                                </div>
                                                
                                                ${hasSubsteps ? substeps[step].map((substep, subIndex) => `
                                                    <div class="substep-item">
                                                        <div style="display: flex; align-items: center; gap: 8px;">
                                                            <span style="color: #718096; font-weight: bold;">${subIndex + 1}.</span>
                                                            <span class="step-name-editable" onclick="editSubstepName('${step}', '${substep}')" title="Click to rename">
                                                                ${substep}
                                                            </span>
                                                        </div>
                                                        <div style="display: flex; gap: 4px;">
                                                            <button class="btn" onclick="moveSubstepUp('${step}', '${substep}')" 
                                                                    style="padding: 3px 6px; font-size: 11px;"
                                                                    ${subIndex === 0 ? 'disabled' : ''}>
                                                                ↑
                                                            </button>
                                                            <button class="btn" onclick="moveSubstepDown('${step}', '${substep}')" 
                                                                    style="padding: 3px 6px; font-size: 11px;"
                                                                    ${subIndex >= substeps[step].length - 1 ? 'disabled' : ''}>
                                                                ↓
                                                            </button>
                                                            <button onclick="removeSubstep('${step}', '${substep}')" 
                                                                    style="background: #e53e3e; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                                ✕
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('') : `
                                                    <div style="padding: 20px; text-align: center; color: #a0aec0; font-size: 13px;">
                                                        No substeps yet. Click "Add Substep" to create one.
                                                    </div>
                                                `}
                                                
                                                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                        <h4 style="font-size: 14px; margin: 0;">Required Steps (Dependencies)</h4>
                                                        <button class="btn" onclick="addStepDependency('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                                            ➕ Add Requirement
                                                        </button>
                                                    </div>
                                                    
                                                    ${stepDependencies[step] && stepDependencies[step].length > 0 ? `
                                                        <div style="background: #fff5f5; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                                            <strong style="font-size: 12px; color: #c53030;">⚠️ ${step} requires these steps to be completed first:</strong>
                                                        </div>
                                                        ${stepDependencies[step].map(dep => `
                                                            <div class="substep-item">
                                                                <div style="font-size: 13px;">
                                                                    <strong>${dep}</strong> must be completed first
                                                                </div>
                                                                <button onclick="removeStepDependency('${step}', '${dep}')" 
                                                                        style="background: #e53e3e; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        `).join('')}
                                                    ` : `
                                                        <div style="padding: 15px; text-align: center; color: #a0aec0; font-size: 13px;">
                                                            No requirements. This step can be started at any time.
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'techs' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">👨‍🔧 Technician Management</h2>
                        ${STEPS.filter(s => s !== 'Finished').map(step => `
                            <div style="margin-bottom: 15px; padding: 15px; background: #f7fafc; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong>${step}</strong>
                                    <button class="btn" onclick="addTechnicianToStep('${step}')" style="padding: 4px 10px; font-size: 12px;">
                                        ➕ Add Tech
                                    </button>
                                </div>
                                ${(technicians[step] && technicians[step].length > 0) ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${technicians[step].map(tech => `
                                            <div style="background: white; padding: 6px 10px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                                <span>${tech}</span>
                                                <button onclick="removeTechnicianFromStep('${step}', '${tech}')" 
                                                        style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 11px;">
                                                    ✕
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<small style="color: #718096;">No technicians assigned</small>'}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'tags' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🏷️ Tag Management</h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px;">Create New Tag</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div class="form-group">
                                    <label>Tag Name</label>
                                    <input type="text" id="newTagName" placeholder="Rush Order">
                                </div>
                                <div class="form-group">
                                    <label>Tag Type</label>
                                    <select id="newTagType" onchange="document.getElementById('skipStepField').style.display = this.value === 'skip' ? 'block' : 'none'">
                                        <option value="special">Special (Visual Only)</option>
                                        <option value="skip">Skip Step</option>
                                        <option value="priority">Priority</option>
                                    </select>
                                </div>
                                <div class="form-group" id="skipStepField" style="display: none;">
                                    <label>Skip Which Step?</label>
                                    <select id="tagSkipStep">
                                        ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => 
                                            `<option value="${step}">${step}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="createNewTag()">➕ Create Tag</button>
                        </div>
                        
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Existing Tags</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            ${Object.entries(tagDefinitions).map(([name, def]) => `
                                <div style="background: #f7fafc; padding: 12px; border-radius: 4px; border-left: 4px solid ${def.color};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <strong style="font-size: 14px;">${name}</strong>
                                        <button onclick="deleteTag('${name}')" 
                                                style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 11px;">
                                            ✕
                                        </button>
                                    </div>
                                    <div style="font-size: 12px; color: #718096;">
                                        ${def.skipsStep ? `Skips: ${def.skipsStep}` : ''}
                                        ${def.priority ? 'Priority Flag' : ''}
                                        ${def.special && !def.priority ? 'Special Tag' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'workflows' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">🔄 Workflow Management</h2>
                        <p style="margin-bottom: 15px; color: #718096; font-size: 14px;">
                            Workflows define which steps a vehicle goes through. Click steps in the order you want them. The number shows the order.
                        </p>
                        
                        ${Object.entries(workflows).map(([id, workflow]) => `
                            <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-left: 4px solid ${workflow.color}; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 18px; margin: 0; margin-bottom: 5px;">${workflow.name}</h3>
                                        <span style="font-size: 13px; color: #718096;">${workflow.steps.length} steps configured</span>
                                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                                            <button class="btn" onclick="editWorkflowName('${id}')" style="background: #4299e1; padding: 4px 10px; font-size: 11px;">
                                                ✏️ Edit Name
                                            </button>
                                            <button class="btn" onclick="editWorkflowColor('${id}')" style="background: ${workflow.color}; color: white; padding: 4px 10px; font-size: 11px;">
                                                🎨 Edit Color
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn" onclick="deleteWorkflow('${id}')" style="background: #e53e3e; padding: 6px 12px; font-size: 12px;">
                                        Delete Workflow
                                    </button>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 4px;">
                                    <strong style="font-size: 14px; display: block; margin-bottom: 10px;">Click Steps to Add (in order):</strong>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;" id="workflow_steps_${id}">
                                        ${STEPS.filter(s => s !== 'Finished').map(step => {
                                            const stepIndex = workflow.steps.indexOf(step);
                                            const isIncluded = stepIndex > -1;
                                            return `
                                                <button onclick="clickWorkflowStep('${id}', '${step}')" 
                                                        id="step_btn_${id}_${step.replace(/\s/g, '_')}"
                                                        style="position: relative; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: ${isIncluded ? '#e6ffed' : 'white'}; border: 2px solid ${isIncluded ? '#48bb78' : '#e2e8f0'}; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; font-weight: ${isIncluded ? 'bold' : 'normal'};">
                                                    ${isIncluded ? `<span style="position: absolute; top: 2px; right: 2px; background: #48bb78; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${stepIndex + 1}</span>` : ''}
                                                    <span>${step}</span>
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                    
                                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                                        <button class="btn" onclick="saveWorkflowOrder('${id}')" style="flex: 1; background: #48bb78; padding: 10px; font-size: 13px;">
                                            💾 Save Step Order
                                        </button>
                                        <button class="btn" onclick="clearWorkflowSteps('${id}')" style="background: #e53e3e; padding: 10px; font-size: 13px;">
                                            🗑️ Clear All
                                        </button>
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding: 10px; background: #fffbeb; border-radius: 4px; font-size: 12px;">
                                        <strong>⚠️ Important:</strong> Click "Save Step Order" after making changes. "Finished" is automatically added as the final step.
                                    </div>
                                    
                                    <div style="margin-top: 10px; padding: 10px; background: #e6f2ff; border-radius: 4px; font-size: 12px;">
                                        <strong>📋 Current Step Order:</strong><br>
                                        ${workflow.steps.map((s, i) => `${i+1}. ${s}`).join(' → ') || 'No steps selected'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        
                        <button class="btn" onclick="createWorkflow()" style="width: 100%; padding: 12px; font-size: 14px;">
                            ➕ Create New Workflow
                        </button>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'settings' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">⚙️ Step Time Thresholds (Hours)</h2>
                        <div class="threshold-list">
                            ${STEPS.filter(s => s !== 'Finished').map(step => `
                                <div class="threshold-item">
                                    <span>${step}</span>
                                    <input type="number" 
                                           value="${stepThresholds[step]}" 
                                           style="width: 80px;" 
                                           onchange="updateThreshold('${step}', this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'data' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">💾 Data Management</h2>
                        
                        <div style="background: #fef5e7; border: 2px solid #f39c12; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; color: #7c2d12;">📁 File-Based Storage</h3>
                            <p style="margin-bottom: 10px; font-size: 14px;">
                                This system uses <strong>manual file-based storage</strong>. Your data is saved to actual files on your computer.
                            </p>
                            <ul style="margin-left: 20px; font-size: 14px; color: #744210;">
                                <li><strong>Important:</strong> You must manually save your work by clicking the "Save" button</li>
                                <li>Your save file will be downloaded to your Downloads folder</li>
                                <li>To continue working, load your save file using the "Load Data" button below</li>
                                <li>Keep your save file safe - it contains all your work!</li>
                            </ul>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #48bb78;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #22543d;">💾 Save Your Work</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Download current data as <strong>${SAVE_FILE_NAME}</strong>
                                </p>
                                <button class="btn" onclick="saveChanges()" style="width: 100%; background: #48bb78; font-size: 15px; padding: 12px;">
                                    💾 Save to File
                                </button>
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    File will be saved to your Downloads folder
                                </p>
                            </div>

                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #4299e1;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #2c5282;">📂 Load Your Work</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Load data from your saved file
                                </p>
                                <input type="file" id="loadDataFile" accept=".json" onchange="loadFromFile(event)" style="width: 100%; padding: 10px; border: 2px solid #4299e1; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    Select your ${SAVE_FILE_NAME} file
                                </p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h3 style="margin-bottom: 10px; font-size: 16px;">📥 Create Backup</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #718096;">
                                    Create a dated backup file (recommended daily)
                                </p>
                                <button class="btn" onclick="exportData()" style="width: 100%; background: #4299e1;">
                                    Create Backup
                                </button>
                                <p style="margin-top: 10px; font-size: 11px; color: #718096;">
                                    Creates: recon-backup-YYYY-MM-DD.json
                                </p>
                            </div>

                            <div style="background: #fff5f5; padding: 20px; border-radius: 8px; border: 2px solid #fc8181;">
                                <h3 style="margin-bottom: 10px; font-size: 16px; color: #c53030;">⚠️ Reset to Sample Data</h3>
                                <p style="margin-bottom: 15px; font-size: 13px; color: #742a2a;">
                                    Start fresh with sample vehicles
                                </p>
                                <button class="btn" onclick="clearAllData()" style="width: 100%; background: #e53e3e;">
                                    Reset to Sample Data
                                </button>
                            </div>
                        </div>

                        <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; color: #234e52;">💡 Best Practices</h3>
                            <ul style="margin-left: 20px; font-size: 13px; color: #2c7a7b;">
                                <li><strong>Save often:</strong> Click "Save to File" whenever you make important changes</li>
                                <li><strong>Keep your file safe:</strong> Store ${SAVE_FILE_NAME} in a safe location</li>
                                <li><strong>Create backups:</strong> Use "Create Backup" to make dated backup files</li>
                                <li><strong>Load your file:</strong> When you open the system, load your save file first</li>
                                <li><strong>Multiple saves:</strong> You can keep multiple backup files with different dates</li>
                            </ul>
                        </div>

                        <div style="background: #fffbeb; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px;">
                            <h3 style="margin-bottom: 10px; color: #7c2d12;">📋 File Storage Information</h3>
                            <ul style="margin-left: 20px; font-size: 13px; color: #744210;">
                                <li><strong>File Name:</strong> ${SAVE_FILE_NAME}</li>
                                <li><strong>File Type:</strong> JSON (JavaScript Object Notation)</li>
                                <li><strong>Storage Location:</strong> Your computer (Downloads folder by default)</li>
                                <li><strong>What's Saved:</strong> All vehicles, technicians, steps, workflows, tags, and settings</li>
                                <li><strong>Persistence:</strong> Your file remains even if you close the browser</li>
                                <li><strong>Portability:</strong> You can copy your save file to another computer</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="admin-content ${currentAdminTab === 'report' ? 'active' : ''}">
                    <div class="admin-section">
                        <h2 class="section-title">📊 All Vehicles Report</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>VIN</th>
                                    <th>Stock #</th>
                                    <th>Current Step</th>
                                    <th>Time in Step</th>
                                    <th>Total Time</th>
                                    <th>Assigned Tech</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vehicles.sort((a, b) => a.entryTime - b.entryTime).map(v => `
                                    <tr style="${isOverdue(v) ? 'background: #fff5f5;' : ''}">
                                        <td>${v.vin}</td>
                                        <td>${v.stockNumber || 'N/A'}</td>
                                        <td>${v.currentStep}</td>
                                        <td>${formatTimeDiff(v.stepStartTime)}</td>
                                        <td>${formatTimeDiff(v.entryTime)}</td>
                                        <td>${v.assignedTech || 'Unassigned'}</td>
                                        <td>${isOverdue(v) && v.currentStep !== 'Finished' ? '⚠️ Overdue' : '✓ On Track'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        function renderReporting() {
            // Calculate bottlenecks
            const avgTimeByStep = {};
            STEPS.forEach(step => {
                const vehiclesInStep = vehicles.filter(v => v.completedSteps.includes(step));
                if (vehiclesInStep.length > 0) {
                    // Simplified - in real system would track actual times
                    avgTimeByStep[step] = Math.random() * 3 + 0.5;
                }
            });

            const bottleneck = Object.entries(avgTimeByStep)
                .sort((a, b) => b[1] - a[1])[0];

            return `
                <div class="admin-section">
                    <h2 class="section-title">📊 Daily Performance Report</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${vehicles.filter(v => v.currentStep === 'Finished').length}</div>
                            <div class="stat-label">Vehicles Completed Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicles.filter(v => isOverdue(v)).length}</div>
                            <div class="stat-label">Currently Overdue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${bottleneck ? bottleneck[0] : 'N/A'}</div>
                            <div class="stat-label">Biggest Bottleneck</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(Math.random() * 24 + 12).toFixed(1)}h</div>
                            <div class="stat-label">Avg Time Through System</div>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h2 class="section-title">Average Time by Step</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Avg Time (hours)</th>
                                <th>Current Queue</th>
                                <th>Threshold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${STEPS.filter(s => s !== 'Finished').map(step => {
                                const queueLength = vehicles.filter(v => v.currentStep === step).length;
                                const avgTime = avgTimeByStep[step] || 0;
                                const threshold = stepThresholds[step];
                                const status = avgTime > threshold ? '⚠️ Over Threshold' : '✓ Normal';
                                return `
                                    <tr style="${avgTime > threshold ? 'background: #fff5f5;' : ''}">
                                        <td>${step}</td>
                                        <td>${avgTime.toFixed(1)}</td>
                                        <td>${queueLength}</td>
                                        <td>${threshold}h</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="admin-section">
                    <h2 class="section-title">Technician Productivity</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Technician</th>
                                <th>Department</th>
                                <th>Completed Today</th>
                                <th>Avg Time per Job</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(technicians).flatMap(([step, techs]) => 
                                techs.map(tech => `
                                    <tr>
                                        <td>${tech}</td>
                                        <td>${step}</td>
                                        <td>${Math.floor(Math.random() * 8 + 2)}</td>
                                        <td>${(Math.random() * 2 + 0.5).toFixed(1)}h</td>
                                    </tr>
                                `)
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ============================================
        // SUPABASE DATA LOADING FUNCTIONS
        // ============================================
        
        async function loadUserProfileFromSupabase(userId) {
            if (!supabaseClient) return;
            
            try {
                // Load user profile
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (profileError) {
                    console.error('Profile load error:', profileError);
                    alert('Error loading profile: ' + profileError.message);
                    return;
                }
                
                console.log('👤 Profile loaded:', profile);
                
                // Set current user
                currentUser = {
                    username: profile.username,
                    role: profile.role,
                    name: profile.full_name,
                    department: profile.department
                };
                
                // Handle super admin (can see all locations)
                if (profile.role === 'superadmin') {
                    console.log('🌟 Super admin detected - loading all locations');
                    await loadAllLocationsForSuperAdmin();
                } else {
                    // Regular user - load their single location
                    const { data: location, error: locError } = await supabase
                        .from('locations')
                        .select('*')
                        .eq('id', profile.location_id)
                        .single();
                    
                    if (location) {
                        userLocations = [location];
                        currentLocationId = location.id;
                        console.log('📍 Location loaded:', location.name);
                    }
                }
                
                // Load data for current location
                await loadDataFromSupabase();
                
            } catch (err) {
                console.error('Profile load exception:', err);
                alert('Error: ' + err.message);
            }
        }
        
        async function loadAllLocationsForSuperAdmin() {
            const { data: locations, error } = await supabase
                .from('locations')
                .select('*')
                .order('name');
            
            if (locations && locations.length > 0) {
                userLocations = locations;
                currentLocationId = locations[0].id; // Default to first location
                console.log(`✅ Loaded ${locations.length} locations`);
            }
        }
        
        async function loadDataFromSupabase() {
            if (!supabase || !currentLocationId) {
                console.log('⚠️ Skipping data load - no location selected');
                return;
            }
            
            console.log('📊 Loading data for location:', currentLocationId);
            
            try {
                // Load vehicles
                const { data: vehicleData, error: vError } = await supabase
                    .from('vehicles')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (vehicleData) {
                    vehicles = vehicleData.map(v => ({
                        id: v.id,
                        vin: v.vin,
                        stockNumber: v.stock_number,
                        year: v.year,
                        make: v.make,
                        model: v.model,
                        miles: v.miles,
                        appraisalNotes: v.appraisal_notes,
                        currentStep: v.current_step,
                        workflow: v.workflow,
                        assignedTech: v.assigned_tech,
                        entryTime: new Date(v.entry_time),
                        stepStartTime: new Date(v.step_start_time),
                        completedSteps: v.completed_steps || [],
                        skippedSteps: v.skipped_steps || [],
                        tags: v.tags || [],
                        vehicleTags: v.vehicle_tags || [],
                        photos: v.photos || [],
                        stepHistory: v.step_history || [],
                        noteHistory: []
                    }));
                    
                    // Load notes for each vehicle
                    for (let vehicle of vehicles) {
                        const { data: notes } = await supabase
                            .from('vehicle_notes')
                            .select('*')
                            .eq('vehicle_id', vehicle.id)
                            .order('created_at', { ascending: false });
                        
                        if (notes) {
                            vehicle.noteHistory = notes.map(n => ({
                                text: n.note_text,
                                timestamp: new Date(n.created_at),
                                user: n.username,
                                id: n.id
                            }));
                        }
                    }
                    
                    console.log(`✅ Loaded ${vehicles.length} vehicles`);
                }
                
                // Load workflows
                const { data: workflowData } = await supabase
                    .from('workflows')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (workflowData) {
                    workflows = {};
                    workflowData.forEach(w => {
                        workflows[w.workflow_key] = {
                            name: w.name,
                            steps: w.steps || [],
                            color: w.color
                        };
                    });
                    console.log(`✅ Loaded ${workflowData.length} workflows`);
                }
                
                // Load technicians
                const { data: techData } = await supabase
                    .from('technicians')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (techData) {
                    technicians = techData.map(t => ({
                        name: t.name,
                        department: t.department,
                        status: t.status || 'available'
                    }));
                    console.log(`✅ Loaded ${technicians.length} technicians`);
                }
                
                // Load step thresholds
                const { data: thresholdData } = await supabase
                    .from('step_thresholds')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (thresholdData) {
                    stepThresholds = {};
                    thresholdData.forEach(t => {
                        stepThresholds[t.step_name] = t.threshold_hours;
                    });
                    console.log(`✅ Loaded step thresholds`);
                }
                
                // Load tag definitions
                const { data: tagData } = await supabase
                    .from('tag_definitions')
                    .select('*')
                    .eq('location_id', currentLocationId);
                
                if (tagData) {
                    tagDefinitions = {};
                    tagData.forEach(t => {
                        tagDefinitions[t.tag_name] = {
                            color: t.color,
                            skipsStep: t.skips_step
                        };
                    });
                    console.log(`✅ Loaded ${tagData.length} tag definitions`);
                }
                
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }
        
        async function switchLocation(locationId) {
            if (!currentUser || currentUser.role !== 'superadmin') {
                alert('Only super admin can switch locations');
                return;
            }
            
            currentLocationId = locationId;
            await loadDataFromSupabase();
            render();
        }
        
        // Event Handlers
        async function login() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Try Supabase first if configured
            if (USE_SUPABASE && supabaseClient) {
                try {
                    console.log('🔐 Attempting Supabase login...');
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) {
                        console.error('Auth error:', error);
                        alert('Invalid credentials: ' + error.message);
                        return;
                    }
                    
                    console.log('✅ Auth successful');
                    
                    if (data.user) {
                        await loadUserProfileFromSupabase(data.user.id);
                        currentView = currentUser.role === 'technician' ? 'technician' : 'dashboard';
                        render();
                    }
                } catch (err) {
                    console.error('Login exception:', err);
                    alert('Login error: ' + err.message);
                }
            } else {
                // Fallback to mock authentication
                const username = email;
                if (users[username] && users[username].password === password) {
                    currentUser = {
                        username: username,
                        ...users[username]
                    };
                    currentView = currentUser.role === 'technician' ? 'technician' : 'dashboard';
                    render();
                } else {
                    alert('Invalid credentials');
                }
            }
        }

        async function logout() {
            if (USE_SUPABASE && supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentUser = null;
            userLocations = [];
            currentLocationId = null;
            currentView = 'dashboard';
            render();
        }

        function switchView(view) {
            currentView = view;
            selectedStepFilter = 'all'; // Reset filter when switching views
            render();
        }

        function filterByStep(step) {
            selectedStepFilter = step;
            selectedStatFilter = 'all';
            render();
        }

        function filterByStat(stat) {
            selectedStatFilter = stat;
            selectedStepFilter = 'all';
            render();
        }

        function getVehiclesByStat(stat) {
            switch(stat) {
                case 'total':
                    return vehicles;
                case 'awaiting':
                    return vehicles.filter(v => !v.workflow || v.workflow === 'AWAITING');
                case 'inProgress':
                    return vehicles.filter(v => v.currentStep !== 'Finished' && v.workflow && v.workflow !== 'AWAITING');
                case 'completed':
                    return vehicles.filter(v => v.currentStep === 'Finished');
                case 'overdue':
                    return vehicles.filter(v => isOverdue(v) && v.currentStep !== 'Finished');
                case 'suggested':
                    return vehicles.filter(v => {
                        if (v.currentStep === 'Finished') return false;
                        if (!v.workflow || v.workflow === 'AWAITING') return false;
                        const suggestedStep = getSuggestedAlternateStep(v);
                        const availableTech = getAvailableTechnician(v.currentStep);
                        return suggestedStep !== null || (availableTech && availableTech !== v.assignedTech);
                    });
                default:
                    return vehicles;
            }
        }

        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const name = document.getElementById('newUserFullName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const department = document.getElementById('newUserDepartment').value;

            if (!username || !password || !name) {
                alert('Please fill in all required fields');
                return;
            }

            if (users[username]) {
                alert('Username already exists');
                return;
            }

            users[username] = {
                password: password,
                role: role,
                name: name,
                department: role === 'technician' ? department : null
            };

            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserFullName').value = '';
            
            render();
            alert(`✓ User ${name} added successfully`);
        }

        function removeUser(username) {
            if (username === 'admin') {
                alert('Cannot remove admin user');
                return;
            }

            if (confirm(`Remove user ${users[username].name}?`)) {
                delete users[username];
                render();
                alert('✓ User removed');
            }
        }

        function addStep() {
            const stepName = document.getElementById('newStepName').value.trim();
            const insertBefore = document.getElementById('insertBeforeStep').value;

            if (!stepName) {
                alert('Please enter a step name');
                return;
            }

            if (STEPS.includes(stepName)) {
                alert('Step already exists');
                return;
            }

            // Find insertion point
            const insertIndex = STEPS.indexOf(insertBefore);
            STEPS.splice(insertIndex, 0, stepName);

            // Initialize step data
            stepThresholds[stepName] = 2;
            technicians[stepName] = [];

            document.getElementById('newStepName').value = '';
            
            render();
            alert(`✓ Step "${stepName}" added`);
        }

        function removeStep(step) {
            if (vehicles.some(v => v.currentStep === step)) {
                alert('Cannot remove step - vehicles are currently in this step');
                return;
            }

            if (confirm(`Remove step "${step}"?`)) {
                const index = STEPS.indexOf(step);
                STEPS.splice(index, 1);
                delete stepThresholds[step];
                delete technicians[step];
                
                render();
                alert(`✓ Step "${step}" removed`);
            }
        }

        function moveStepUp(step) {
            const index = STEPS.indexOf(step);
            if (index <= 0) return;
            
            [STEPS[index], STEPS[index - 1]] = [STEPS[index - 1], STEPS[index]];
            render();
        }

        function moveStepDown(step) {
            const index = STEPS.indexOf(step);
            if (index >= STEPS.length - 1) return;
            
            [STEPS[index], STEPS[index + 1]] = [STEPS[index + 1], STEPS[index]];
            render();
        }

        function addTechnicianToStep(step) {
            const techName = prompt(`Enter technician name for ${step}:`);
            if (!techName) return;

            if (!technicians[step]) technicians[step] = [];
            
            if (technicians[step].includes(techName)) {
                alert('Technician already assigned to this step');
                return;
            }

            technicians[step].push(techName);
            render();
            alert(`✓ ${techName} added to ${step}`);
        }

        function switchAdminTab(tab) {
            currentAdminTab = tab;
            render();
        }

        function addTagToVehicle(vin, tagName) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            if (!vehicle.vehicleTags) vehicle.vehicleTags = [];
            
            if (vehicle.vehicleTags.includes(tagName)) {
                alert('Tag already applied to this vehicle');
                return;
            }

            vehicle.vehicleTags.push(tagName);
            
            // Apply tag effects
            const tagDef = tagDefinitions[tagName];
            if (tagDef && tagDef.skipsStep) {
                if (!vehicle.skippedSteps.includes(tagDef.skipsStep)) {
                    vehicle.skippedSteps.push(tagDef.skipsStep);
                    if (!vehicle.tags.includes(`Skip ${tagDef.skipsStep}`)) {
                        vehicle.tags.push(`Skip ${tagDef.skipsStep}`);
                    }
                }
            }

            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Tag added: ${tagName}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            render();
            alert(`✓ Tag "${tagName}" added`);
        }

        function removeTagFromVehicle(vin, tagName) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            vehicle.vehicleTags = (vehicle.vehicleTags || []).filter(t => t !== tagName);
            
            // Remove tag effects
            const tagDef = tagDefinitions[tagName];
            if (tagDef && tagDef.skipsStep) {
                vehicle.skippedSteps = vehicle.skippedSteps.filter(s => s !== tagDef.skipsStep);
                vehicle.tags = vehicle.tags.filter(t => t !== `Skip ${tagDef.skipsStep}`);
            }

            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Tag removed: ${tagName}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });

            render();
        }

        function createNewTag() {
            const tagName = document.getElementById('newTagName').value.trim();
            const tagType = document.getElementById('newTagType').value;
            const skipStep = document.getElementById('tagSkipStep').value;

            if (!tagName) {
                alert('Please enter a tag name');
                return;
            }

            if (tagDefinitions[tagName]) {
                alert('Tag already exists');
                return;
            }

            const newTag = {
                color: '#bee3f8'
            };

            if (tagType === 'skip' && skipStep) {
                newTag.skipsStep = skipStep;
            } else if (tagType === 'priority') {
                newTag.priority = true;
                newTag.color = '#fbd38d';
            } else {
                newTag.special = true;
            }

            tagDefinitions[tagName] = newTag;

            document.getElementById('newTagName').value = '';
            
            render();
            alert(`✓ Tag "${tagName}" created`);
        }

        function deleteTag(tagName) {
            if (confirm(`Delete tag "${tagName}"? This will remove it from all vehicles.`)) {
                // Remove from all vehicles
                vehicles.forEach(v => {
                    if (v.vehicleTags) {
                        v.vehicleTags = v.vehicleTags.filter(t => t !== tagName);
                    }
                });

                delete tagDefinitions[tagName];
                render();
                alert(`✓ Tag "${tagName}" deleted`);
            }
        }

        function editStepName(oldName) {
            const newName = prompt(`Enter new name for "${oldName}":`, oldName);
            if (!newName || newName === oldName) return;

            if (STEPS.includes(newName)) {
                alert('A step with this name already exists');
                return;
            }

            // Update in STEPS array
            const index = STEPS.indexOf(oldName);
            STEPS[index] = newName;

            // Update thresholds
            stepThresholds[newName] = stepThresholds[oldName];
            delete stepThresholds[oldName];

            // Update technicians
            technicians[newName] = technicians[oldName] || [];
            delete technicians[oldName];

            // Update substeps
            if (substeps[oldName]) {
                substeps[newName] = substeps[oldName];
                delete substeps[oldName];
            }

            // Update vehicles
            vehicles.forEach(v => {
                if (v.currentStep === oldName) v.currentStep = newName;
                if (v.completedSteps.includes(oldName)) {
                    const idx = v.completedSteps.indexOf(oldName);
                    v.completedSteps[idx] = newName;
                }
                if (v.skippedSteps.includes(oldName)) {
                    const idx = v.skippedSteps.indexOf(oldName);
                    v.skippedSteps[idx] = newName;
                }
            });

            render();
            alert(`✓ Step renamed to "${newName}"`);
        }

        function toggleStepExpansion(stepName) {
            if (expandedSteps.has(stepName)) {
                expandedSteps.delete(stepName);
            } else {
                expandedSteps.add(stepName);
            }
            render();
        }

        function addSubstep(stepName) {
            const substepName = prompt(`Enter new substep name for ${stepName}:`);
            if (!substepName) return;

            if (!substeps[stepName]) {
                substeps[stepName] = [];
            }

            if (substeps[stepName].includes(substepName)) {
                alert('Substep already exists');
                return;
            }

            substeps[stepName].push(substepName);
            render();
            alert(`✓ Substep "${substepName}" added to ${stepName}`);
        }

        function removeSubstep(stepName, substepName) {
            if (confirm(`Remove substep "${substepName}" from ${stepName}?`)) {
                substeps[stepName] = substeps[stepName].filter(s => s !== substepName);
                
                // Clean up if no substeps remain
                if (substeps[stepName].length === 0) {
                    delete substeps[stepName];
                }
                
                render();
                alert(`✓ Substep "${substepName}" removed`);
            }
        }

        function moveSubstepUp(stepName, substepName) {
            const list = substeps[stepName];
            const index = list.indexOf(substepName);
            if (index <= 0) return;

            [list[index], list[index - 1]] = [list[index - 1], list[index]];
            render();
        }

        function moveSubstepDown(stepName, substepName) {
            const list = substeps[stepName];
            const index = list.indexOf(substepName);
            if (index >= list.length - 1) return;

            [list[index], list[index + 1]] = [list[index + 1], list[index]];
            render();
        }

        function editSubstepName(stepName, oldName) {
            const newName = prompt(`Rename substep "${oldName}" to:`, oldName);
            if (!newName || newName === oldName) return;

            const index = substeps[stepName].indexOf(oldName);
            substeps[stepName][index] = newName;
            
            render();
            alert(`✓ Substep renamed to "${newName}"`);
        }

        // Workflow Management Functions
        function filterByWorkflow(workflowId) {
            currentWorkflowFilter = workflowId;
            selectedStatFilter = 'all';
            selectedStepFilter = 'all';
            render();
        }

        function createWorkflow() {
            const name = prompt('Enter new workflow name:');
            if (!name) return;
            
            const id = name.replace(/\s+/g, '-').toLowerCase();
            if (workflows[id]) {
                alert('A workflow with this name already exists');
                return;
            }
            
            workflows[id] = {
                name: name,
                steps: [],
                color: '#' + Math.floor(Math.random()*16777215).toString(16)
            };
            
            render();
            alert(`✓ Workflow "${name}" created. Configure steps in Admin Panel → Workflows tab.`);
        }

        function deleteWorkflow(workflowId) {
            if (confirm(`Delete workflow "${workflows[workflowId].name}"? Vehicles using this workflow will be moved to CPO.`)) {
                // Move vehicles to CPO workflow
                vehicles.forEach(v => {
                    if (v.workflow === workflowId) {
                        v.workflow = 'CPO';
                    }
                });
                
                delete workflows[workflowId];
                render();
                alert('✓ Workflow deleted');
            }
        }

        function editWorkflowName(workflowId) {
            const workflow = workflows[workflowId];
            const newName = prompt(`Enter new name for workflow:`, workflow.name);
            
            if (!newName || newName === workflow.name) return;
            
            workflow.name = newName;
            render();
            alert(`✓ Workflow renamed to "${newName}"`);
        }

        function editWorkflowColor(workflowId) {
            const workflow = workflows[workflowId];
            const newColor = prompt(`Enter new color (hex code):`, workflow.color);
            
            if (!newColor || newColor === workflow.color) return;
            
            // Validate hex color
            if (!/^#[0-9A-F]{6}$/i.test(newColor)) {
                alert('Invalid color. Please use hex format like #48bb78');
                return;
            }
            
            workflow.color = newColor;
            render();
            alert(`✓ Workflow color updated`);
        }

        // Temporary storage for workflow step ordering
        let workflowEditState = {};

        function clickWorkflowStep(workflowId, step) {
            const workflow = workflows[workflowId];
            
            // Initialize edit state if needed
            if (!workflowEditState[workflowId]) {
                workflowEditState[workflowId] = [...workflow.steps];
            }
            
            const tempSteps = workflowEditState[workflowId];
            const index = tempSteps.indexOf(step);
            
            if (index > -1) {
                // Step already in list - remove it
                tempSteps.splice(index, 1);
            } else {
                // Add step to end of list
                tempSteps.push(step);
            }
            
            // Update button visuals without saving
            updateWorkflowStepButtons(workflowId);
        }
        
        function updateWorkflowStepButtons(workflowId) {
            const tempSteps = workflowEditState[workflowId] || workflows[workflowId].steps;
            
            STEPS.filter(s => s !== 'Finished').forEach(step => {
                const btnId = `step_btn_${workflowId}_${step.replace(/\s/g, '_')}`;
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                const stepIndex = tempSteps.indexOf(step);
                const isIncluded = stepIndex > -1;
                
                // Update button styling and number badge
                btn.style.background = isIncluded ? '#e6ffed' : 'white';
                btn.style.border = isIncluded ? '2px solid #48bb78' : '2px solid #e2e8f0';
                btn.style.fontWeight = isIncluded ? 'bold' : 'normal';
                
                // Update or remove number badge
                const existingBadge = btn.querySelector('span:first-child');
                if (isIncluded) {
                    const badgeHTML = `<span style="position: absolute; top: 2px; right: 2px; background: #48bb78; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${stepIndex + 1}</span>`;
                    if (existingBadge && existingBadge.style.position === 'absolute') {
                        existingBadge.outerHTML = badgeHTML;
                    } else {
                        btn.insertAdjacentHTML('afterbegin', badgeHTML);
                    }
                } else {
                    if (existingBadge && existingBadge.style.position === 'absolute') {
                        existingBadge.remove();
                    }
                }
            });
        }
        
        function saveWorkflowOrder(workflowId) {
            if (!workflowEditState[workflowId]) {
                alert('No changes to save');
                return;
            }
            
            const workflow = workflows[workflowId];
            workflow.steps = [...workflowEditState[workflowId]];
            
            // Clear edit state
            delete workflowEditState[workflowId];
            
            render();
            alert(`✓ Step order saved for ${workflow.name}`);
        }
        
        function clearWorkflowSteps(workflowId) {
            if (!confirm('Clear all steps from this workflow?')) return;
            
            workflowEditState[workflowId] = [];
            updateWorkflowStepButtons(workflowId);
        }

        function toggleWorkflowStep(workflowId, step) {
            // Legacy function - redirect to new click system
            clickWorkflowStep(workflowId, step);
        }

        function applyWorkflowToVehicle(vehicle, workflowId) {
            const workflow = workflows[workflowId];
            vehicle.workflow = workflowId;
            
            // Set skipped steps (steps not in this workflow)
            vehicle.skippedSteps = STEPS.filter(s => !workflow.steps.includes(s) && s !== 'Finished');
            
            // Move to first step in workflow
            const firstStep = workflow.steps[0];
            if (firstStep && firstStep !== 'Finished') {
                vehicle.currentStep = firstStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(firstStep);
            }
            
            render();
            alert(`✓ Vehicle assigned to ${workflow.name} workflow`);
        }
        
        function assignWorkflowToVehicle(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const workflowSelect = document.getElementById(`workflow_${vin}`);
            const workflowId = workflowSelect.value;
            
            if (!workflowId) {
                alert('Please select a workflow');
                return;
            }
            
            const workflow = workflows[workflowId];
            if (!workflow) return;
            
            // Apply workflow
            vehicle.workflow = workflowId;
            vehicle.skippedSteps = STEPS.filter(s => !workflow.steps.includes(s) && s !== 'Finished');
            
            // Set to first step in workflow
            const firstStep = workflow.steps[0];
            if (firstStep && firstStep !== 'Finished') {
                vehicle.currentStep = firstStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(firstStep);
            }
            
            // Add note to history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Workflow assigned: ${workflow.name}. Started in ${firstStep || 'N/A'}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });
            
            render();
            alert(`✓ Vehicle assigned to ${workflow.name} workflow and moved to ${firstStep}`);
        }

        function validateWorkflowCompletion(vehicle) {
            // Ensure vehicle has completed all required steps in their workflow before finishing
            const workflow = workflows[vehicle.workflow];
            if (!workflow) return true; // No workflow = allow completion
            
            const requiredSteps = workflow.steps.filter(s => s !== 'Finished' && s !== 'Quality Control');
            const missingSteps = requiredSteps.filter(s => 
                !vehicle.completedSteps.includes(s) && !vehicle.skippedSteps.includes(s)
            );
            
            if (missingSteps.length > 0) {
                alert(`❌ Cannot finish vehicle. Missing required steps:\n${missingSteps.join(', ')}`);
                return false;
            }
            
            return true;
        }

        // Auto-reassign logic with ML-like optimization
        function autoReassignAll() {
            if (!confirm('Auto-reassign will analyze all vehicles and optimize assignments based on:\n• Queue lengths\n• Technician availability\n• Historical completion times\n\nProceed?')) {
                return;
            }

            let reassignCount = 0;
            let stepChangeCount = 0;
            let techChangeCount = 0;

            vehicles.forEach(vehicle => {
                // Skip locked vehicles and finished ones
                if (reassignableLocks.has(vehicle.vin) || vehicle.currentStep === 'Finished') {
                    return;
                }

                // Check for better step
                const suggestedStep = getSuggestedAlternateStep(vehicle);
                if (suggestedStep) {
                    vehicle.currentStep = suggestedStep;
                    vehicle.stepStartTime = new Date();
                    vehicle.assignedTech = assignTechnician(suggestedStep);
                    stepChangeCount++;
                    reassignCount++;
                }

                // Check for better tech in current step
                const availableTech = getAvailableTechnician(vehicle.currentStep);
                if (availableTech && availableTech !== vehicle.assignedTech) {
                    vehicle.assignedTech = availableTech;
                    vehicle.stepStartTime = new Date();
                    techChangeCount++;
                    reassignCount++;
                }
            });

            
            render();
            alert(`✓ Auto-reassignment complete!\n\n${reassignCount} total changes:\n• ${stepChangeCount} step changes\n• ${techChangeCount} technician changes`);
        }

        function toggleReassignLock(vin) {
            if (reassignableLocks.has(vin)) {
                reassignableLocks.delete(vin);
            } else {
                reassignableLocks.add(vin);
            }
            
            render();
        }

        function checkStepDependencies(vehicle, targetStep) {
            const dependencies = stepDependencies[targetStep];
            if (!dependencies) return { valid: true, missing: [] };

            const missing = dependencies.filter(dep => 
                !vehicle.completedSteps.includes(dep) && 
                !vehicle.skippedSteps.includes(dep)
            );

            return {
                valid: missing.length === 0,
                missing: missing
            };
        }

        function addStepDependency(step) {
            const dependencyStep = prompt(`Which step must be completed BEFORE ${step}?\n\nAvailable steps:\n${STEPS.filter(s => s !== step).join(', ')}`);
            
            if (!dependencyStep) return;
            if (!STEPS.includes(dependencyStep)) {
                alert('Invalid step name');
                return;
            }

            if (!stepDependencies[step]) {
                stepDependencies[step] = [];
            }

            if (stepDependencies[step].includes(dependencyStep)) {
                alert('Dependency already exists');
                return;
            }

            stepDependencies[step].push(dependencyStep);
            render();
            alert(`✓ ${step} now requires ${dependencyStep} to be completed first`);
        }

        function removeStepDependency(step, dependency) {
            if (confirm(`Remove requirement that ${dependency} must be completed before ${step}?`)) {
                stepDependencies[step] = stepDependencies[step].filter(d => d !== dependency);
                if (stepDependencies[step].length === 0) {
                    delete stepDependencies[step];
                }
                render();
            }
        }

        // Initialize file system structure
        function initializeFileSystem() {
            // In production, this would use actual file system APIs
            // For mockup, we'll simulate the structure
            console.log(`Creating directory structure at: ${baseDirectory}`);
            console.log(`History directory: ${historyDirectory}`);
            console.log(`Photos directory: ${photosDirectory}`);
            
            // Create sample structure documentation
            const structure = `
File System Structure:
=====================

${baseDirectory}/
├── recon_history/
│   ├── 2025/
│   │   ├── 02/
│   │   │   ├── A12345_completed_20250212.json
│   │   │   └── B98765_completed_20250215.json
│   │   └── 03/
│   └── 2024/
│
└── vehicle_photos/
    ├── A12345/
    │   ├── photo1_exterior_20250212_143022.jpg
    │   ├── photo2_interior_20250212_143045.jpg
    │   └── photo3_damage_20250212_143103.jpg
    ├── B98765/
    │   ├── photo1_20250213_091523.jpg
    │   └── photo2_20250213_091547.jpg
    └── C54321/
        └── photo1_20250214_102334.jpg
            `;
            
            console.log(structure);
            
            // Store in localStorage for persistence simulation
            try {
                localStorage.setItem('recon_base_directory', baseDirectory);
                localStorage.setItem('recon_file_structure', structure);
            } catch (e) {
                console.log('LocalStorage not available, using in-memory only');
            }
        }

        function saveVehicleToHistory(vehicle) {
            const completedDate = new Date();
            const year = completedDate.getFullYear();
            const month = String(completedDate.getMonth() + 1).padStart(2, '0');
            
            const historyRecord = {
                vin: vehicle.vin,
                stockNumber: vehicle.stockNumber,
                miles: vehicle.miles,
                appraisalNotes: vehicle.appraisalNotes,
                completedDate: completedDate,
                totalReconTime: Math.floor((completedDate - vehicle.entryTime) / (1000 * 60)), // minutes
                notes: vehicle.notes,
                noteHistory: vehicle.noteHistory || [], // Preserve note history
                photos: vehicle.photos,
                stepHistory: vehicle.stepHistory
            };

            // Add to in-memory history
            vehicleHistory.push(historyRecord);

            // Simulate file save
            const filename = `${vehicle.stockNumber}_completed_${completedDate.toISOString().split('T')[0].replace(/-/g, '')}.json`;
            const filepath = `${historyDirectory}/${year}/${month}/${filename}`;
            
            console.log(`Saving vehicle history to: ${filepath}`);
            console.log(JSON.stringify(historyRecord, null, 2));

            // In production, would use:
            // await fetch('/api/save-history', { method: 'POST', body: JSON.stringify(historyRecord) });
        }

        function savePhotoToFileSystem(vehicle, photoData, filename) {
            const stockNumber = vehicle.stockNumber;
            const vehiclePhotoDir = `${photosDirectory}/${stockNumber}`;
            const filepath = `${vehiclePhotoDir}/${filename}`;

            console.log(`Saving photo to: ${filepath}`);

            // In production, would use:
            // const formData = new FormData();
            // formData.append('file', photoData);
            // formData.append('stockNumber', stockNumber);
            // await fetch('/api/save-photo', { method: 'POST', body: formData });

            return filepath;
        }

        // Initialize on load
        if (typeof window !== 'undefined') {
            window.addEventListener('load', initializeFileSystem);
        }

        function getStepStats(step) {
            const vehiclesInStep = vehicles.filter(v => v.currentStep === step);
            const inStep = vehiclesInStep.length;
            const overdue = vehiclesInStep.filter(v => isOverdue(v)).length;
            
            let movable = 0;
            vehiclesInStep.forEach(vehicle => {
                const suggestedStep = getSuggestedAlternateStep(vehicle);
                if (suggestedStep) movable++;
            });
            
            return { inStep, movable, overdue };
        }

        function quickCompleteStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle && vehicle.currentStep !== 'Finished') {
                if (confirm(`Complete ${vehicle.currentStep} for ${vehicle.stockNumber || vin}?`)) {
                    completeStep(vehicle);
                    alert(`✓ Moved to ${vehicle.currentStep}!`);
                }
            }
        }

        function completeTechStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle && vehicle.assignedTech === currentUser.name) {
                completeStep(vehicle);
                alert(`✓ ${vehicle.completedSteps[vehicle.completedSteps.length - 1]} completed for ${vehicle.stockNumber || vin}`);
            }
        }

        function showVehicleDetails(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            // Technicians can only interact with vehicles in their department
            if (currentUser.role === 'technician') {
                const techDept = currentUser.department;
                if (vehicle.currentStep !== techDept) {
                    alert('This vehicle is not in your department. You can only complete vehicles assigned to ' + techDept);
                    return;
                }
                if (vehicle.assignedTech !== currentUser.name) {
                    alert('This vehicle is assigned to ' + vehicle.assignedTech);
                    return;
                }
                
                // Technician can only complete their current step
                if (confirm(`Complete ${techDept} for ${vehicle.stockNumber || vin}?`)) {
                    completeStep(vehicle);
                    alert(`✓ ${techDept} completed for ${vehicle.stockNumber || vin}`);
                }
                return;
            }

            // Admin has full control
            if (currentUser.role === 'administrator') {
                showAdminVehicleDialog(vehicle);
            }
        }

        function showAdminVehicleDialog(vehicle) {
            const dialogHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 1100px; width: 100%; max-height: 85vh; overflow-y: auto;">
                        <h2 style="margin-bottom: 5px; font-size: 18px;">Vehicle Details</h2>
                        ${vehicle.year && vehicle.make && vehicle.model ? `
                            <div style="font-size: 15px; color: #4299e1; margin-bottom: 10px; font-weight: 500;">
                                ${vehicle.year} ${vehicle.make} ${vehicle.model}
                            </div>
                        ` : '<div style="margin-bottom: 10px;"></div>'}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 12px;">
                            <div><strong>VIN:</strong> ${vehicle.vin}</div>
                            <div><strong>Stock #:</strong> ${vehicle.stockNumber || 'N/A'}</div>
                            <div><strong>Miles:</strong> ${vehicle.miles?.toLocaleString() || 'N/A'}</div>
                            <div><strong>Current Step:</strong> ${vehicle.currentStep}</div>
                            <div><strong>Time in Step:</strong> ${formatTimeDiff(vehicle.stepStartTime)}</div>
                            <div><strong>Total Time:</strong> ${formatTimeDiff(vehicle.entryTime)}</div>
                            <div><strong>Assigned Tech:</strong> ${vehicle.assignedTech}</div>
                            <div><strong>Photos:</strong> ${vehicle.photos?.length || 0}</div>
                            <div><strong>Notes:</strong> ${(vehicle.noteHistory || []).length}</div>
                        </div>
                        
                        ${vehicle.appraisalNotes ? `
                            <div style="margin-bottom: 15px; padding: 10px; background: #fffbeb; border-radius: 4px; font-size: 12px;">
                                <strong>Appraisal Notes:</strong><br>
                                ${vehicle.appraisalNotes}
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 15px; font-size: 12px;">
                            <strong>Completed:</strong> ${vehicle.completedSteps.join(', ') || 'None'}<br>
                            <strong>Skipped:</strong> ${vehicle.skippedSteps.join(', ') || 'None'}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'notes')" 
                                    class="action-tab-btn" id="btn_notes_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                📝 Notes
                            </button>
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'photos')" 
                                    class="action-tab-btn" id="btn_photos_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                📷 Photos
                            </button>
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'tags')" 
                                    class="action-tab-btn" id="btn_tags_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                🏷️ Tags
                            </button>
                            ${vehicle.stockNumber ? `
                                <button onclick="switchVehicleTab('${vehicle.vin}', 'history')" 
                                        class="action-tab-btn" id="btn_history_${vehicle.vin}"
                                        style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                    📜 History
                                </button>
                            ` : ''}
                            <button onclick="switchVehicleTab('${vehicle.vin}', 'move')" 
                                    class="action-tab-btn" id="btn_move_${vehicle.vin}"
                                    style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                🚗 Move
                            </button>
                            ${vehicle.currentStep !== 'Finished' ? `
                                <button onclick="switchVehicleTab('${vehicle.vin}', 'complete')" 
                                        class="action-tab-btn" id="btn_complete_${vehicle.vin}"
                                        style="flex: 1; min-width: 140px; padding: 12px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #2d3748;">
                                    ✅ Complete
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- All Data View (default - shown when nothing selected) -->
                        <div id="tab_all_${vehicle.vin}" class="tab-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Left Column -->
                                <div>
                                    <!-- Notes Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">📝 Recent Notes</h3>
                                        <div style="max-height: 150px; overflow-y: auto;">
                                            ${(vehicle.noteHistory && vehicle.noteHistory.length > 0) ? 
                                                vehicle.noteHistory.slice().reverse().slice(0, 3).map(note => `
                                                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-left: 3px solid #4299e1; border-radius: 4px;">
                                                        <div style="font-size: 10px; color: #718096; margin-bottom: 3px;">
                                                            <strong>${note.user}</strong> - ${new Date(note.timestamp).toLocaleDateString()}
                                                        </div>
                                                        <div style="color: #2d3748; font-size: 11px;">${note.text}</div>
                                                    </div>
                                                `).join('') 
                                                : '<div style="color: #a0aec0; font-size: 12px; padding: 8px;">No notes yet</div>'
                                            }
                                        </div>
                                        ${(vehicle.noteHistory && vehicle.noteHistory.length > 3) ? `
                                            <div style="margin-top: 8px; font-size: 11px; color: #718096; text-align: center;">
                                                +${vehicle.noteHistory.length - 3} more notes (click Notes to view all)
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Tags Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">🏷️ Tags</h3>
                                        <div style="min-height: 40px;">
                                            ${(vehicle.vehicleTags || []).map(tag => `
                                                <span class="tag-chip" style="background: ${tagDefinitions[tag]?.color || '#bee3f8'}; display: inline-block; margin: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    ${tag}
                                                </span>
                                            `).join('')}
                                            ${(vehicle.vehicleTags || []).length === 0 ? '<div style="color: #a0aec0; font-size: 12px; padding: 8px;">No tags applied</div>' : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div>
                                    <!-- Photos Summary -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">📷 Photos</h3>
                                        <div style="font-size: 12px; color: #4a5568;">
                                            ${vehicle.photos && vehicle.photos.length > 0 ? 
                                                `${vehicle.photos.length} photo(s) uploaded` : 
                                                '<span style="color: #a0aec0;">No photos uploaded</span>'
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- Current Status -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2d3748;">🚗 Current Status</h3>
                                        <div style="font-size: 12px; line-height: 1.6;">
                                            <div><strong>Step:</strong> ${vehicle.currentStep}</div>
                                            <div><strong>Time in step:</strong> ${formatTimeDiff(vehicle.stepStartTime)}</div>
                                            <div><strong>Total time:</strong> ${formatTimeDiff(vehicle.entryTime)}</div>
                                            <div><strong>Tech:</strong> ${vehicle.assignedTech}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Tab -->
                        <div id="tab_notes_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">📝 Notes History</h3>
                            <div style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 6px;">
                                ${(vehicle.noteHistory && vehicle.noteHistory.length > 0) ? 
                                    vehicle.noteHistory.slice().reverse().map(note => `
                                        <div style="margin-bottom: 12px; padding: 12px; background: white; border-left: 4px solid #4299e1; border-radius: 4px;">
                                            <div style="font-size: 11px; color: #718096; margin-bottom: 5px;">
                                                <strong>${note.user}</strong> - ${new Date(note.timestamp).toLocaleString()}
                                            </div>
                                            <div style="color: #2d3748; font-size: 13px;">${note.text}</div>
                                        </div>
                                    `).join('') 
                                    : '<div style="color: #a0aec0; font-size: 13px; padding: 12px;">No notes yet</div>'
                                }
                            </div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Add New Note:</label>
                            <textarea id="vehicleNotes_${vehicle.vin}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 13px;" placeholder="Enter note..."></textarea>
                            <button class="btn" onclick="addNoteToVehicle('${vehicle.vin}', document.getElementById('vehicleNotes_${vehicle.vin}').value)" style="margin-top: 10px; font-size: 13px; padding: 10px 20px; width: 100%;">
                                ➕ Add Note to History
                            </button>
                        </div>
                        
                        <!-- Photos Tab -->
                        <div id="tab_photos_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">📷 Upload Photos</h3>
                            <input type="file" id="photoUpload_${vehicle.vin}" accept="image/*" multiple 
                                   onchange="handlePhotoUpload('${vehicle.vin}', event)"
                                   style="width: 100%; padding: 15px; border: 3px dashed #cbd5e0; border-radius: 6px; font-size: 13px; background: #f7fafc; cursor: pointer;">
                            ${vehicle.photos && vehicle.photos.length > 0 ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                    <strong style="font-size: 13px;">Uploaded Photos:</strong>
                                    <div style="margin-top: 10px; font-size: 13px; color: #4a5568;">
                                        ${vehicle.photos.length} photo(s) uploaded
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Tags Tab -->
                        <div id="tab_tags_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">🏷️ Vehicle Tags</h3>
                            <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px; min-height: 80px;">
                                <strong style="font-size: 12px; display: block; margin-bottom: 10px;">Current Tags:</strong>
                                ${(vehicle.vehicleTags || []).map(tag => `
                                    <span style="display: inline-flex; align-items: center; background: ${tagDefinitions[tag]?.color || '#bee3f8'}; margin: 5px; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                                        ${tag}
                                        <button onclick="removeTagFromVehicle('${vehicle.vin}', '${tag}'); closeDialog(); showVehicleDetails('${vehicle.vin}');" 
                                                style="margin-left: 8px; background: none; border: none; color: #e53e3e; cursor: pointer; font-weight: bold; font-size: 14px; padding: 0; line-height: 1;">
                                            ✕
                                        </button>
                                    </span>
                                `).join('')}
                                ${(vehicle.vehicleTags || []).length === 0 ? '<div style="color: #a0aec0; font-size: 13px; padding: 10px;">No tags applied</div>' : ''}
                            </div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 13px;">Add New Tag:</label>
                            <select id="addTagSelect_${vehicle.vin}" style="width: 100%; padding: 12px; margin-bottom: 12px; font-size: 13px; border: 2px solid #cbd5e0; border-radius: 6px;">
                                <option value="">-- Select Tag --</option>
                                ${Object.keys(tagDefinitions).filter(t => !(vehicle.vehicleTags || []).includes(t)).map(tag => `
                                    <option value="${tag}">${tag}</option>
                                `).join('')}
                            </select>
                            <button class="btn" onclick="const sel = document.getElementById('addTagSelect_${vehicle.vin}'); if(sel.value) { addTagToVehicle('${vehicle.vin}', sel.value); closeDialog(); showVehicleDetails('${vehicle.vin}'); }" style="width: 100%; font-size: 13px; padding: 12px;">
                                ➕ Add Selected Tag
                            </button>
                        </div>
                        
                        <!-- History Tab -->
                        ${vehicle.stockNumber ? `
                            <div id="tab_history_${vehicle.vin}" class="tab-content" style="display: none;">
                                <h3 style="margin-bottom: 15px; font-size: 15px;">📜 5-Year Vehicle History</h3>
                                <button class="btn" onclick="closeDialog(); viewVehicleHistory('${vehicle.stockNumber}')" 
                                        style="width: 100%; background: #805ad5; font-size: 14px; padding: 15px;">
                                    View Complete Timeline
                                </button>
                                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 6px; font-size: 12px; color: #718096; line-height: 1.6;">
                                    View all historical records, notes, and events for this stock number including past recon visits and completion dates.
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Move Tab -->
                        <div id="tab_move_${vehicle.vin}" class="tab-content" style="display: none;">
                            <h3 style="margin-bottom: 15px; font-size: 15px;">🚗 Move Vehicle to Different Step</h3>
                            <div style="margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 6px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #718096;">
                                    Current Step:
                                </label>
                                <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${vehicle.currentStep}</div>
                            </div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 13px;">Move to:</label>
                            <select id="moveToStep_${vehicle.vin}" style="width: 100%; padding: 15px; margin-bottom: 15px; font-size: 14px; border: 2px solid #cbd5e0; border-radius: 6px;">
                                ${STEPS.map(step => `
                                    <option value="${step}" ${step === vehicle.currentStep ? 'selected' : ''}>
                                        ${step}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn" onclick="moveVehicleToStepFromDialog('${vehicle.vin}')" style="width: 100%; padding: 15px; font-size: 14px; background: #4299e1;">
                                🚗 Move Vehicle
                            </button>
                        </div>
                        
                        <!-- Complete Tab -->
                        ${vehicle.currentStep !== 'Finished' ? `
                            <div id="tab_complete_${vehicle.vin}" class="tab-content" style="display: none;">
                                <h3 style="margin-bottom: 15px; font-size: 15px;">✅ Complete Current Step</h3>
                                <div style="padding: 15px; background: #f7fafc; border-radius: 6px; margin-bottom: 20px;">
                                    <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">
                                        Current Step: <strong style="color: #2d3748; font-size: 15px;">${vehicle.currentStep}</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #718096;">
                                        Time in step: ${formatTimeDiff(vehicle.stepStartTime)}
                                    </div>
                                </div>
                                ${vehicle.currentStep === 'Quality Control' ? `
                                    <button class="btn" onclick="passQC('${vehicle.vin}')" style="width: 100%; background: #48bb78; margin-bottom: 12px; padding: 15px; font-size: 14px;">
                                        ✓ Pass QC - Move to Finished
                                    </button>
                                    <button class="btn" onclick="showRejectQC('${vehicle.vin}')" style="width: 100%; background: #e53e3e; padding: 15px; font-size: 14px;">
                                        ✗ Fail QC - Send Back
                                    </button>
                                ` : `
                                    <button class="btn" onclick="adminCompleteStep('${vehicle.vin}')" style="width: 100%; background: #48bb78; padding: 15px; font-size: 14px;">
                                        ✅ Complete ${vehicle.currentStep}
                                    </button>
                                `}
                            </div>
                        ` : ''}
                        
                        <button class="btn" onclick="closeDialog()" style="width: 100%; background: #718096; padding: 12px; font-size: 14px; margin-top: 20px;">
                            Close
                        </button>
                    </div>
                </div>
                
                <style>
                    .action-tab-btn:hover {
                        background: #f7fafc !important;
                        border-color: #cbd5e0 !important;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .action-tab-btn.active {
                        background: #4299e1 !important;
                        color: white !important;
                        border-color: #4299e1 !important;
                        box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
        
        function switchVehicleTab(vin, tab) {
            // Check if clicking the already active button
            const selectedBtn = document.getElementById(`btn_${tab}_${vin}`);
            if (selectedBtn && selectedBtn.classList.contains('active')) {
                // Unclick - return to overview
                const buttons = document.querySelectorAll('.action-tab-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                const tabs = ['all', 'notes', 'photos', 'tags', 'history', 'move', 'complete'];
                tabs.forEach(t => {
                    const elem = document.getElementById(`tab_${t}_${vin}`);
                    if (elem) elem.style.display = 'none';
                });
                
                // Show overview
                const overviewTab = document.getElementById(`tab_all_${vin}`);
                if (overviewTab) overviewTab.style.display = 'block';
                return;
            }
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.action-tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Hide all tabs
            const tabs = ['all', 'notes', 'photos', 'tags', 'history', 'move', 'complete'];
            tabs.forEach(t => {
                const elem = document.getElementById(`tab_${t}_${vin}`);
                if (elem) elem.style.display = 'none';
            });
            
            // Show selected tab and activate button
            const selectedTab = document.getElementById(`tab_${tab}_${vin}`);
            
            if (selectedTab) selectedTab.style.display = 'block';
            if (selectedBtn) selectedBtn.classList.add('active');
        }
        
        function moveVehicleToStepFromDialog(vin) {
            const newStep = document.getElementById(`moveToStep_${vin}`).value;
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            const oldStep = vehicle.currentStep;
            vehicle.currentStep = newStep;
            vehicle.stepStartTime = new Date();
            
            // Add to note history
            if (!vehicle.noteHistory) vehicle.noteHistory = [];
            vehicle.noteHistory.push({
                text: `Vehicle moved from ${oldStep} to ${newStep}`,
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            });
            
            closeDialog();
            render();
            alert(`✓ Vehicle moved to ${newStep}`);
        }

        function closeDialog() {
            const dialog = document.getElementById('vehicleDialog');
            if (dialog) dialog.remove();
        }

        function moveVehicleToStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            const newStep = document.getElementById('moveToStep').value;
            
            if (vehicle && newStep) {
                // Check dependencies
                const depCheck = checkStepDependencies(vehicle, newStep);
                if (!depCheck.valid) {
                    alert(`❌ Cannot move to ${newStep}\n\nMissing required steps:\n${depCheck.missing.join(', ')}\n\nThese must be completed first.`);
                    return;
                }

                // Remove from completed if moving back
                const index = vehicle.completedSteps.indexOf(newStep);
                if (index > -1) {
                    vehicle.completedSteps.splice(index);
                }
                
                vehicle.currentStep = newStep;
                vehicle.stepStartTime = new Date();
                vehicle.assignedTech = assignTechnician(newStep);
                
                // If moving to Finished, save to history
                if (newStep === 'Finished') {
                    saveVehicleToHistory(vehicle);
                }
                
                closeDialog();
                render();
                alert(`Vehicle ${vehicle.stockNumber || vin} moved to ${newStep}`);
            }
        }

        function adminCompleteStep(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                completeStep(vehicle);
                closeDialog();
                render();
                alert(`✓ ${vehicle.completedSteps[vehicle.completedSteps.length - 1]} completed for ${vehicle.stockNumber || vin}`);
            }
        }

        function passQC(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (vehicle) {
                completeStep(vehicle);
                closeDialog();
                render();
                alert(`✓ Quality Control passed - Vehicle moved to Finished`);
            }
        }

        function showRejectQC(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            closeDialog();
            
            const dialogHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 400px; width: 100%;">
                        <h2 style="margin-bottom: 15px; color: #e53e3e; font-size: 18px;">Reject from QC</h2>
                        <p style="margin-bottom: 12px; font-size: 14px;">Send ${vin} back to:</p>
                        <select id="rejectToStep" style="width: 100%; padding: 8px; margin-bottom: 12px; font-size: 14px;">
                            ${STEPS.filter(s => s !== 'Quality Control' && s !== 'Finished').map(step => `
                                <option value="${step}">${step}</option>
                            `).join('')}
                        </select>
                        <button class="btn" onclick="rejectVehicle('${vin}')" style="width: 100%; background: #e53e3e; margin-bottom: 8px; padding: 10px; font-size: 14px;">
                            Send Back
                        </button>
                        <button class="btn" onclick="closeDialog()" style="width: 100%; background: #718096; padding: 10px; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }

        function rejectVehicle(vin) {
            const vehicle = vehicles.find(v => v.vin === vin);
            const sendBackTo = document.getElementById('rejectToStep').value;
            
            if (vehicle && sendBackTo) {
                rejectFromQC(vehicle, sendBackTo);
                closeDialog();
                render();
                alert(`Vehicle ${vehicle.stockNumber || vin} sent back to ${sendBackTo}`);
            }
        }

        function addNewVehicle() {
            const vin = document.getElementById('newVIN').value;
            const stockNumber = document.getElementById('newStockNumber').value;
            const year = document.getElementById('newYear').value;
            const make = document.getElementById('newMake').value;
            const model = document.getElementById('newModel').value;
            const miles = parseInt(document.getElementById('newMiles').value) || 0;
            const skipStepsSelect = document.getElementById('skipSteps');
            const skippedSteps = Array.from(skipStepsSelect.selectedOptions).map(opt => opt.value);
            
            if (!vin) {
                alert('Please enter a VIN');
                return;
            }

            const newVehicle = {
                vin: vin,
                stockNumber: stockNumber,
                year: year,
                make: make,
                model: model,
                miles: miles,
                entryTime: new Date(),
                currentStep: 'Awaiting Arrival',
                stepStartTime: new Date(),
                completedSteps: [],
                skippedSteps: skippedSteps,
                assignedTech: 'unassigned',
                tags: skippedSteps.map(s => `Skip ${s}`),
                vehicleTags: [],
                notes: '',
                noteHistory: [
                    { text: 'Vehicle added to system - awaiting arrival and workflow assignment', timestamp: new Date(), user: currentUser ? currentUser.username : 'admin', id: Date.now() }
                ],
                photos: [],
                stepHistory: [],
                workflow: 'AWAITING'
            };

            vehicles.push(newVehicle);
            if (stockNumber) stockNumberRegistry.add(stockNumber);
            
            // Clear form
            document.getElementById('newVIN').value = '';
            document.getElementById('newStockNumber').value = '';
            document.getElementById('newYear').value = '';
            document.getElementById('newMake').value = '';
            document.getElementById('newModel').value = '';
            document.getElementById('newMiles').value = '';
            skipStepsSelect.selectedIndex = -1;
            
            
            render();
            alert(`✓ Vehicle ${stockNumber || vin} added to "Awaiting Arrival". Assign a workflow when the vehicle arrives.`);
        }

        function updateThreshold(step, value) {
            stepThresholds[step] = parseFloat(value);
            render();
        }

        // Excel Import Functions
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                let importedCount = 0;
                let skippedCount = 0;
                let duplicates = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',');
                    const stockNumber = values[1]?.trim().replace(/"/g, '');
                    
                    // Skip if stock number already exists
                    if (stockNumberRegistry.has(stockNumber)) {
                        skippedCount++;
                        duplicates.push(stockNumber);
                        continue;
                    }

                    const vin = values[0]?.trim().replace(/"/g, '');
                    const miles = parseInt(values[2]?.trim()) || 0;
                    const appraisalNotes = values[3]?.trim().replace(/"/g, '') || '';
                    const skipSteps = values[4]?.trim().split(';').filter(s => s) || [];

                    const firstStep = STEPS.find(s => !skipSteps.includes(s) && s !== 'Quality Control' && s !== 'Finished');

                    const newVehicle = {
                        vin: vin,
                        stockNumber: stockNumber,
                        miles: miles,
                        appraisalNotes: appraisalNotes,
                        entryTime: new Date(),
                        currentStep: firstStep,
                        stepStartTime: new Date(),
                        completedSteps: [],
                        skippedSteps: skipSteps,
                        assignedTech: assignTechnician(firstStep),
                        tags: skipSteps.map(s => `Skip ${s}`),
                        notes: '',
                        photos: [],
                        stepHistory: []
                    };

                    vehicles.push(newVehicle);
                    stockNumberRegistry.add(stockNumber);
                    importedCount++;
                }

                event.target.value = ''; // Reset file input
                render();
                
                let message = `✓ Imported ${importedCount} vehicles`;
                if (skippedCount > 0) {
                    message += `\n⚠️ Skipped ${skippedCount} duplicates: ${duplicates.join(', ')}`;
                }
                alert(message);
            };
            reader.readAsText(file);
        }

        // Notes and Photo Functions
        function addNoteToVehicle(vin, noteText) {
            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;
            
            if (!noteText || !noteText.trim()) {
                alert('Please enter a note');
                return;
            }
            
            if (!vehicle.noteHistory) {
                vehicle.noteHistory = [];
            }
            
            const newNote = {
                text: noteText.trim(),
                timestamp: new Date(),
                user: currentUser ? currentUser.username : 'Unknown',
                id: Date.now() + Math.random()
            };
            
            vehicle.noteHistory.push(newNote);
            vehicle.notes = noteText.trim(); // Keep last note for backwards compatibility
            
            closeDialog();
            showVehicleDetails(vin);
            alert('✓ Note added to permanent history');
        }

        function saveVehicleNotes(vin, notes) {
            // Deprecated - redirecting to addNoteToVehicle
            addNoteToVehicle(vin, notes);
        }

        function handlePhotoUpload(vin, event) {
            const files = event.target.files;
            if (!files.length) return;

            const vehicle = vehicles.find(v => v.vin === vin);
            if (!vehicle) return;

            const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoFilename = `photo${vehicle.photos.length + 1}_${file.name.split('.')[0]}_${timestamp}.jpg`;
                    const filepath = savePhotoToFileSystem(vehicle, e.target.result, photoFilename);
                    
                    vehicle.photos.push({
                        name: file.name,
                        filename: photoFilename,
                        filepath: filepath,
                        data: e.target.result,
                        uploadedAt: new Date(),
                        uploadedBy: currentUser.name
                    });
                    render();
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = ''; // Reset file input
            alert(`✓ ${files.length} photo(s) uploaded to ${photosDirectory}/${vehicle.stockNumber}/`);
        }

        function viewVehicleHistory(stockNumber) {
            const current = vehicles.find(v => v.stockNumber === stockNumber);
            const history = vehicleHistory.filter(v => v.stockNumber === stockNumber);
            
            if (!current && history.length === 0) {
                alert('No history found for this stock number');
                return;
            }

            // Build complete timeline including notes
            let timeline = [];
            
            // Add current vehicle notes to timeline
            if (current && current.noteHistory && current.noteHistory.length > 0) {
                current.noteHistory.forEach(note => {
                    timeline.push({
                        type: 'note',
                        date: new Date(note.timestamp),
                        text: note.text,
                        user: note.user,
                        status: 'Current Vehicle'
                    });
                });
            }
            
            // Add entry event for current vehicle
            if (current) {
                timeline.push({
                    type: 'entry',
                    date: current.entryTime,
                    text: `Vehicle entered recon (${current.currentStep})`,
                    status: 'Current Vehicle'
                });
            }
            
            // Add historical visits
            history.forEach(h => {
                timeline.push({
                    type: 'completion',
                    date: h.completedDate,
                    text: `Recon completed (${h.totalReconTime})`,
                    vin: h.vin,
                    notes: h.notes,
                    status: 'Historical Visit'
                });
                
                // Add historical notes if they exist
                if (h.noteHistory && h.noteHistory.length > 0) {
                    h.noteHistory.forEach(note => {
                        timeline.push({
                            type: 'note',
                            date: new Date(note.timestamp),
                            text: note.text,
                            user: note.user,
                            status: 'Historical Visit'
                        });
                    });
                }
            });
            
            // Sort timeline by date (newest first)
            timeline.sort((a, b) => b.date - a.date);

            let historyHTML = `
                <div id="vehicleDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 10px; overflow-y: auto;">
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 900px; width: 100%; margin: auto;">
                        <h2 style="margin-bottom: 15px;">5-Year Vehicle History - Stock #${stockNumber}</h2>
                        
                        ${current ? `
                            <div style="margin-bottom: 20px; padding: 15px; background: #e6ffed; border-radius: 4px;">
                                <strong>Current Status:</strong> In ${current.currentStep}<br>
                                <strong>Entry Date:</strong> ${current.entryTime.toLocaleDateString()}<br>
                                <strong>Total Time:</strong> ${formatTimeDiff(current.entryTime)}<br>
                                <strong>Notes in History:</strong> ${(current.noteHistory || []).length}
                            </div>
                        ` : ''}
                        
                        ${timeline.length > 0 ? `
                            <h3 style="margin: 15px 0 10px 0; font-size: 16px;">Timeline:</h3>
                            <div style="position: relative; padding-left: 30px; border-left: 3px solid #e2e8f0; margin-left: 10px;">
                                ${timeline.map((event, idx) => {
                                    const bgColor = event.status === 'Current Vehicle' ? '#ebf8ff' : '#f7fafc';
                                    const borderColor = event.type === 'note' ? '#4299e1' : event.type === 'entry' ? '#48bb78' : '#805ad5';
                                    const icon = event.type === 'note' ? '📝' : event.type === 'entry' ? '🚗' : '✅';
                                    
                                    return `
                                        <div style="position: relative; margin-bottom: 12px; padding: 12px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 4px;">
                                            <div style="position: absolute; left: -42px; top: 12px; width: 24px; height: 24px; background: white; border: 3px solid ${borderColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                ${icon}
                                            </div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">
                                                <strong>${event.date.toLocaleDateString()}</strong> ${event.date.toLocaleTimeString()} 
                                                <span style="margin-left: 10px; padding: 2px 6px; background: ${event.status === 'Current Vehicle' ? '#bee3f8' : '#e2e8f0'}; border-radius: 3px; font-size: 11px;">
                                                    ${event.status}
                                                </span>
                                            </div>
                                            ${event.type === 'note' ? `
                                                <div style="color: #2d3748; font-size: 13px; margin-bottom: 2px;">${event.text}</div>
                                                <div style="font-size: 11px; color: #a0aec0;">by ${event.user}</div>
                                            ` : `
                                                <div style="color: #2d3748; font-size: 13px;">${event.text}</div>
                                                ${event.vin ? `<div style="font-size: 11px; color: #718096; margin-top: 4px;">VIN: ${event.vin}</div>` : ''}
                                                ${event.notes ? `<div style="font-size: 12px; color: #4a5568; margin-top: 6px; padding: 6px; background: white; border-radius: 3px;"><strong>Note:</strong> ${event.notes}</div>` : ''}
                                            `}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p style="color: #718096; margin: 20px 0;">No timeline events</p>'}
                        
                        <button class="btn" onclick="closeDialog()" style="width: 100%; margin-top: 15px;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', historyHTML);
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            
            // Initialize technician status tracking
            initTechnicianStatus();
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
                return;
            }

            let tabs = '';
            if (currentUser.role === 'administrator') {
                tabs = `
                    <div class="tabs">
                        <button class="tab ${currentView === 'dashboard' ? 'active' : ''}" onclick="switchView('dashboard')">Dashboard</button>
                        <button class="tab ${currentView === 'admin' ? 'active' : ''}" onclick="switchView('admin')">Admin Panel</button>
                        <button class="tab ${currentView === 'reporting' ? 'active' : ''}" onclick="switchView('reporting')">Reports</button>
                    </div>
                `;
            } else if (currentUser.role === 'technician') {
                tabs = `
                    <div class="tabs">
                        <button class="tab active">My Assignment</button>
                    </div>
                `;
            }

            let content = '';
            switch(currentView) {
                case 'dashboard':
                    content = renderDashboard();
                    break;
                case 'technician':
                    content = renderTechnicianView();
                    break;
                case 'admin':
                    content = renderAdminPanel();
                    break;
                case 'reporting':
                    content = renderReporting();
                    break;
            }

            app.innerHTML = `
                <div class="container">
                    ${renderHeader()}
                    ${tabs}
                    ${content}
                </div>
            `;
        }

        // ==================== FILE-BASED STORAGE SYSTEM ====================
        
        // Configuration
        const SAVE_FILE_NAME = 'recon-system-data.json';
        
        function saveToFile() {
            try {
                const data = {
                    vehicles: vehicles.map(v => ({
                        ...v,
                        entryTime: v.entryTime.toISOString(),
                        stepStartTime: v.stepStartTime.toISOString()
                    })),
                    workflows: workflows,
                    STEPS: STEPS,
                    technicians: technicians,
                    substeps: substeps,
                    stepThresholds: stepThresholds,
                    tagDefinitions: tagDefinitions,
                    stockNumberRegistry: Array.from(stockNumberRegistry),
                    vehicleHistory: vehicleHistory.map(v => ({
                        ...v,
                        completedDate: v.completedDate.toISOString()
                    })),
                    stepDependencies: stepDependencies,
                    reassignableLocks: Array.from(reassignableLocks),
                    lastSaved: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = SAVE_FILE_NAME;
                link.click();
                URL.revokeObjectURL(url);
                
                console.log('✓ Data saved to file');
                return true;
            } catch (error) {
                console.error('Error saving to file:', error);
                return false;
            }
        }

        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Restore vehicles with date conversion
                    vehicles = data.vehicles.map(v => ({
                        ...v,
                        entryTime: new Date(v.entryTime),
                        stepStartTime: new Date(v.stepStartTime),
                        noteHistory: (v.noteHistory || []).map(note => ({
                            ...note,
                            timestamp: new Date(note.timestamp)
                        }))
                    }));
                    
                    // Restore other data
                    if (data.workflows) workflows = data.workflows;
                    if (data.STEPS) STEPS = data.STEPS;
                    if (data.technicians) technicians = data.technicians;
                    if (data.substeps) substeps = data.substeps;
                    if (data.stepThresholds) stepThresholds = data.stepThresholds;
                    if (data.tagDefinitions) tagDefinitions = data.tagDefinitions;
                    if (data.stockNumberRegistry) stockNumberRegistry = new Set(data.stockNumberRegistry);
                    if (data.stepDependencies) stepDependencies = data.stepDependencies;
                    if (data.reassignableLocks) reassignableLocks = new Set(data.reassignableLocks);
                    if (data.vehicleHistory) {
                        vehicleHistory = data.vehicleHistory.map(v => ({
                            ...v,
                            completedDate: new Date(v.completedDate),
                            noteHistory: (v.noteHistory || []).map(note => ({
                                ...note,
                                timestamp: new Date(note.timestamp)
                            }))
                        }));
                    }
                    
                    render();
                    alert(`✓ Data loaded successfully!\n\nLast saved: ${new Date(data.lastSaved).toLocaleString()}`);
                    console.log(`✓ Data loaded from file (last saved: ${data.lastSaved})`);
                } catch (error) {
                    alert('❌ Error loading data: ' + error.message);
                    console.error('Error loading from file:', error);
                }
            };
            reader.readAsText(file);
        }

        // Manual save function
        function saveChanges() {
            const success = saveToFile();
            if (success) {
                alert('✓ Data saved to file!\n\nThe file "' + SAVE_FILE_NAME + '" has been downloaded to your Downloads folder.');
            } else {
                alert('❌ Error saving data. Check console for details.');
            }
        }

        // Clear all data function for debugging
        function clearAllData() {
            if (confirm('⚠️ This will reset to sample data. Make sure you have saved your data file first!\n\nAre you sure?')) {
                alert('Data reset! Please save a new file or load an existing one.');
                location.reload();
            }
        }

        // Export data as JSON file (same as save, but with custom name)
        function exportData() {
            try {
                const data = {
                    vehicles: vehicles.map(v => ({
                        ...v,
                        entryTime: v.entryTime.toISOString(),
                        stepStartTime: v.stepStartTime.toISOString()
                    })),
                    workflows: workflows,
                    STEPS: STEPS,
                    technicians: technicians,
                    substeps: substeps,
                    stepPrerequisites: stepPrerequisites,
                    stepThresholds: stepThresholds,
                    tagDefinitions: tagDefinitions,
                    stockNumberRegistry: Array.from(stockNumberRegistry),
                    vehicleHistory: vehicleHistory.map(v => ({
                        ...v,
                        completedDate: v.completedDate.toISOString()
                    })),
                    stepDependencies: stepDependencies,
                    reassignableLocks: Array.from(reassignableLocks),
                    lastSaved: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `recon-backup-${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('✓ Backup file created!');
            } catch (error) {
                alert('❌ Error creating backup: ' + error.message);
            }
        }

        // Import data from JSON file
        function importData(event) {
            loadFromFile(event);
        }

        // Expose utility functions to window for console access
        window.saveChanges = saveChanges;
        window.clearAllData = clearAllData;
        window.exportData = exportData;

        // Initialize - check for existing session
        async function init() {
            if (USE_SUPABASE && supabaseClient) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    console.log('📌 Existing session found');
                    await loadUserProfileFromSupabase(session.user.id);
                }
            }
            render();
        }
        
        init();
    </script>
</body>
</html>
